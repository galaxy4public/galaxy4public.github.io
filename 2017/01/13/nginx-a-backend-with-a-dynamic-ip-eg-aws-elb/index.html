<!DOCTYPE html>
<html lang="en">
<head>
	<title>Mind Drops :: nginx + a backend with a dynamic IP (e.g. AWS ELB)</title>
		<meta http-equiv="Content-Security-Policy" content="	default-src 'self';object-src 'none';script-src 'self' https://www.googletagmanager.com/gtag/js 'sha256-TelA7VsuYAMqhOKGk7CHgJyuqSJdmqZEp+hn6PWVRwQ=' https://www.google-analytics.com/analytics.js https://static.cloudflareinsights.com/beacon.min.js/v652eace1692a40cfa3763df669d7439c1639079717194;img-src 'self' data: https://www.google-analytics.com/r/collect https://www.google-analytics.com/collect https://stats.g.doubleclick.net/r/collect https://*/ads/ga-audiences https://www.googletagmanager.com/a;style-src 'self' 'sha256-fszvBX/J9dhPxFSJ5wUrq/Pvg6HrnTkWyshMZpaxSQY=';connect-src 'self' https://www.google-analytics.com/j/collect https://stats.g.doubleclick.net/j/collect; " />
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />	<link rel="preload" href="/theme/fonts/Oswald/Oswald-VariableFont_wght.woff2" crossorigin="anonymous" as="font" type="font/woff2">
	<link rel="preload" href="/theme/fonts/Exo2/Exo2-VariableFont_wght.woff2" crossorigin="anonymous" as="font" type="font/woff2">	<link rel="stylesheet" href="/theme/css/fonts/Icons.css" />
	<link rel="stylesheet" href="/theme/css/fonts/Exo2.css" />
	<link rel="stylesheet" href="/theme/css/fonts/Oswald.css" />
	<link rel="stylesheet" href="/theme/css/fonts/DancingScript.css" />
	<link rel="stylesheet" href="/theme/css/base.css" />
	<link rel="stylesheet" href="/theme/css/pygments/default.css" />
	<link rel="canonical" href="/2017/01/13/nginx-a-backend-with-a-dynamic-ip-eg-aws-elb/" />

	<script type="application/ld+json">
	{
		"@context" : "https://schema.org",
		"@type" : "Article",
		"author": "(GalaxyMaster)",
		"name" : "nginx + a backend with a dynamic IP (e.g. AWS ELB)",
		"datePublished" : "2017-01-13T10:00:00+11:00",
		"dateModified" : "2025-07-10T11:52:03+10:00",
		"image" : "https://dmitry.khlebnikov.net/2020/06/14/truly-responsive-pagination/images/paginator-sketch.png",
		"headline" : "headline",
		"abstract": "abstract goes here",
		"articleSection": "hacking",
		"interactionStatistic":
		[
			{
				"@type": "InteractionCounter",
				"interactionService":
				{
					"@type": "WebSite",
					"name": "Twitter",
					"url": "http://www.twitter.com"
				},
				"interactionType": "http://schema.org/ShareAction",
				"userInteractionCount": "1203"
			},
			{
				"@type": "InteractionCounter",
				"interactionType": "http://schema.org/CommentAction",
				"userInteractionCount": "78"
			}
		],
		"discussionUrl": "https://github.com/"
	}
	</script>
</head>

<body>
	<header>
		<span class="flex">
			<!--
			<button class="menu-toggle" type="button" tabindex="0" aria-label="Menu Toggle"><div></div></button>
			-->
			<div class="menu-toggle" tabindex="0" aria-label="Menu Toggle"><div></div></div>
			<a href="/" class="logo">
				<picture>
					<source srcset="/images/logo.svg" type="image/svg+xml">
					<source srcset="/images/.svg" type="image/svg+xml">
					<source srcset="/images/.webp" type="image/webp">
					<img width="100%" height="100%" src="/images/" alt="Logo">
				</picture>
				<span class="title">Mind Drops</span>
			</a>
			<nav>
				<ul>
					<li><a class="icon home" href="/">Home</a></li>
					<li><a class="icon user" href="/about">About</a></li>
					<li><a class="icon phone" href="/contact">Contact</a></li>
				</ul>
			</nav>
			<form id="search" role="search" autocomplete="off" method="get" action="/search">
				<label for="q" class="icon search">Search</label>
				<input type="text" name="q" id="q" placeholder="Search..." />
				<div class="help" aria-label="Search ">
					<dl>
						<dt>"search terms"</dt><dd>exact-match</dd>
						<dt>term1 | term2</dt><dd>term1 or term2</dd>
						<dt>term1 * term2</dt><dd>term1 followed by term2</dd>
						<dt>-term</dt><dd>exclude term</dd>
						<dt>(search terms)</dt><dd>groups terms</dd>
						<dt>ext:pdf</dt><dd>file type</dd>
					</dl>
				</div>
			</form>
			<ul class="taskbar">
				<li class="search-toggle"><label for="q" class="icon search offscreen" title="Toggle the search bar">Search</label></li>
				<!-- Not Implemented Yet
				<li><a href="#bug-report" class="icon bug offscreen" title="Report a spotted bug on the page">Report a bug</a></li>
				<li><a href="#preferences" class="icon cog offscreen" title="Configure personal preferences">Preferences</a></li>
				 -->
			</ul>
		</span>
	</header>
<!--
	<aside class="modal">
		<div id="bug-report">
			<a href="#" class="close"></a>
			<div class="content">
				<h1>Bug report</h1>
				<form id="bug-report-form" autocomplete="off">
					<textarea id="bug-report-body" name="bug-report-body">
					</textarea>
					<input type="submit" value="Submit">
				</form>
			</div>
		</div>
		<div id="preferences">
		</div>
	</aside>
 -->
	<main>
			<article id="nginx-a-backend-with-a-dynamic-ip-eg-aws-elb">
				<header>
					<h1><a href="/2017/01/13/nginx-a-backend-with-a-dynamic-ip-eg-aws-elb/" rel="bookmark" title="Permalink to nginx + a backend with a dynamic IP (e.g. AWS ELB)">nginx + a backend with a dynamic IP (e.g. AWS ELB)</a></h1>
				</header>
				<aside>
				</aside>
				<p>Recently, I wrote about <a href="../../../../2016/09/20/dynamic-resolution-of-upstream-servers-in-nginx/">the dynamic resolution of upstream servers</a> in
nginx which was achieved by quite an intrusive patch to the core nginx module.
The patch was invented a while ago and was working very well up until recent
nginx versions were released.</p>
<p>With the release of nginx 1.10 it was noticed that the patch crashes some
workers under heavy load and this was unacceptable for the production load,
hence a new approach was implemented.</p>
<p>The beauty of the new solution is that it is non-intrusive and works with any
services that communicate via sockets.</p>
<p>In a nutshell, I just looked at the problem from a little bit different angle
after I defined the requirements:</p>
<ul>
<li>nginx needs to delegate the requests to a FastCGI server over a socket</li>
<li>we want to work with the standard packages provided by the distribution</li>
<li>the FastCGI server could be on a dynamic IP address</li>
</ul>
<p>Since we are not allowed to patch the application the only place we can meddle
with the communication between nginx and the FastCGI server is the socket nginx
connects to. Therefore, we need some kind of a proxy that would take requests
from nginx, determine the FastCGI endpoint, and forward the requests to that
endpoint.</p>
<p>Initially, I thought that I would use something like netcat or a similar tool
for this, but then I found that systemd provides <code>systemd-socket-proxyd</code> binary
which fits the purpose perfectly and could be configured to be socket
activated.</p>
<p>Before we dive into the implementation details of this solution, let&rsquo;s describe
what we are going to do and how:</p>
<ul>
<li>nginx will be configured to talk to the locally bound socket - there are
    two options, actually: either a local TCP socket or a Unix socket</li>
<li>a proxy service will be socket activated by a request coming from nginx to
    that local socket</li>
<li>a proxy service should resolve the target and forward the request there</li>
</ul>
<p>The nginx part is easy &ndash; we just need to replace the FastCGI server endpoint
address (in our example below it was <code>remote.php.backend.domain.tld.:9000</code>)
with our local socket (we are using a unix socket at
<code>/run/systemd-socket-proxyd/fastcgi.sock</code> in this example):</p>
<pre class="highlight"><input type="radio" name="code_menue279035ef62deb93a7229f0b88d8954c5a83d302" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menue279035ef62deb93a7229f0b88d8954c5a83d302" class="line-numbers icon list-numbered"><code class="language-nginx"><div class="line"><a></a><span class="k">upstream</span><span class="w"> </span><span class="s">php</span><span class="w"> </span><span class="p">{</span>
</div><div class="line"><a></a><span class="w">    </span><span class="c1">#server remote.php.backend.domain.tld.:9000;</span>
</div><div class="line"><a></a><span class="w">    </span><span class="kn">server</span><span class="w">  </span><span class="s">unix:/run/systemd-socket-proxyd/fastcgi.sock</span><span class="p">;</span>
</div><div class="line"><a></a><span class="p">}</span>
</div><div class="line"><a></a><span class="k">location</span><span class="w"> </span><span class="p">~</span><span class="w"> </span><span class="sr">\.php$</span><span class="w"> </span><span class="p">{</span>
</div><div class="line"><a></a><span class="w">    </span><span class="kn">try_files</span><span class="w">   </span><span class="nv">$uri</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">404</span><span class="p">;</span>
</div><div class="line"><a></a><span class="w">    </span><span class="kn">fastcgi_pass</span><span class="w">    </span><span class="s">php</span><span class="p">;</span>
</div><div class="line"><a></a><span class="w">    </span><span class="kn">fastcgi_index</span><span class="w">   </span><span class="s">index.php</span><span class="p">;</span>
</div><div class="line"><a></a><span class="w">    </span><span class="kn">include</span><span class="w">     </span><span class="s">fastcgi.conf</span><span class="p">;</span>
</div><div class="line"><a></a><span class="p">}</span></div></code></pre>
<p>The next step is to define the socket activated proxy service. This generally
requires creating two files in <code>/etc/system/systemd</code> directory: one for the
socket and the other for the proxy itself. However, in this article we will go
an extra mile and will define template units so the same configuration could be
reused to launch multiple proxies using the same base templates.</p>
<p>The first template file is for the systemd service which will provide the proxy
capability:</p>
<pre class="highlight"><input type="radio" name="code_menu1175a0c0ab66cfab0aa9e2b9ec9c0e881777311a" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu1175a0c0ab66cfab0aa9e2b9ec9c0e881777311a" class="line-numbers icon list-numbered"><code class="language-systemd" data-file="/etc/systemd/system/systemd-socket-proxyd@.service"><div class="line"><a></a><span class="k">[Unit]</span>
</div><div class="line"><a></a><span class="na">Description</span><span class="o">=</span><span class="s">&quot;Generic Socket Proxy (%I)&quot;</span>
</div><div class="line"><a></a><span class="na">Documentation</span><span class="o">=</span><span class="s">https://www.freedesktop.org/software/systemd/man/systemd-socket-proxyd.html</span>
</div><div class="line"><a></a><span class="na">After</span><span class="o">=</span><span class="s">network.service</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="k">[Service]</span>
</div><div class="line"><a></a><span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">-/etc/sysconfig/systemd-socket-proxyd.%i</span>
</div><div class="line"><a></a><span class="na">User</span><span class="o">=</span><span class="s">nobody</span>
</div><div class="line"><a></a><span class="na">Group</span><span class="o">=</span><span class="s">nobody</span>
</div><div class="line"><a></a><span class="na">OOMScoreAdjust</span><span class="o">=</span><span class="s">-1000</span>
</div><div class="line"><a></a><span class="na">UMask</span><span class="o">=</span><span class="s">077</span>
</div><div class="line"><a></a><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/lib/systemd/systemd-socket-proxyd $TARGET</span>
</div><div class="line"><a></a><span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
</div><div class="line"><a></a><span class="na">PrivateTmp</span><span class="o">=</span><span class="s">true</span>
</div><div class="line"><a></a><span class="na">PrivateDevices</span><span class="o">=</span><span class="s">true</span>
</div><div class="line"><a></a><span class="c1">#PrivateUsers=true</span>
</div><div class="line"><a></a><span class="c1">#ProtectSystem=strict</span>
</div><div class="line"><a></a><span class="na">ProtectSystem</span><span class="o">=</span><span class="s">full</span>
</div><div class="line"><a></a><span class="c1">#ProtectKernelTunables=true</span>
</div><div class="line"><a></a><span class="c1">#ProtectControlGroups=true</span>
</div><div class="line"><a></a><span class="c1">#NoNewPrivileges=true</span>
</div><div class="line"><a></a><span class="c1">#ProtectKernelModules=true</span>
</div><div class="line"><a></a><span class="c1">#MemoryDenyWriteExecute=true</span></div></code></pre>
<p>Depending on the version of your <code>systemd</code> manager you may be able to uncomment
more lines than was shown in this example, which was tested on CentOS 7.3.1611.</p>
<p>Also, in the example template given above we are using <code>OOMScoreAdjust=-1000</code> to
protect this proxy service from being killed in the event the system is
starving for memory &ndash; this may be something you do not need.</p>
<p>The second template file is for the socket unit that would trigger the
activation of the proxy service when a request arrives on the socket:</p>
<pre class="highlight"><input type="radio" name="code_menu4d81a796a4cae0ba3b1778d4e1226127746cc6c2" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu4d81a796a4cae0ba3b1778d4e1226127746cc6c2" class="line-numbers icon list-numbered"><code class="language-systemd" data-file="/etc/systemd/system/systemd-socket-proxyd@.socket"><div class="line"><a></a><span class="k">[Unit]</span>
</div><div class="line"><a></a><span class="na">Description</span><span class="o">=</span><span class="s">&quot;Socket for Generic Socket Proxy (%I)&quot;</span>
</div><div class="line"><a></a><span class="na">Documentation</span><span class="o">=</span><span class="s">https://www.freedesktop.org/software/systemd/man/systemd-socket-proxyd.html</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="k">[Socket]</span>
</div><div class="line"><a></a><span class="na">ListenStream</span><span class="o">=</span><span class="s">/run/systemd-socket-proxyd/%i.sock</span>
</div><div class="line"><a></a><span class="na">SocketUser</span><span class="o">=</span><span class="s">root</span>
</div><div class="line"><a></a><span class="na">SocketGroup</span><span class="o">=</span><span class="s">root</span>
</div><div class="line"><a></a><span class="na">SocketMode</span><span class="o">=</span><span class="s">0660</span>
</div><div class="line"><a></a><span class="na">DirectoryMode</span><span class="o">=</span><span class="s">0711</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="k">[Install]</span>
</div><div class="line"><a></a><span class="na">WantedBy</span><span class="o">=</span><span class="s">sockets.target</span></div></code></pre>
<p>You may notice that the defaults are pretty strict:</p>
<ul>
<li>the socket is owned by root and only root is allowed to work with the
    socket;</li>
<li>the directory permissions are set in such a way that the
    <code>/run/systemd-socket-proxyd</code> directory file list is not readable by anyone
    except root.</li>
</ul>
<p>These are safe and sane defaults and can be tweaked per instance that was
instantiated using the template as shown later in this article.</p>
<p>Since our goal is to connect nginx to the backend FastCGI service we need to
ensure that the proxy socket is read/write accessible to nginx&rsquo;es workers, so
we need to tweak the settings of the socket unit:</p>
<pre class="highlight"><input type="radio" name="code_menu27998f57d01bb24aa37caf31ea0999dcfa40b8f9" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu27998f57d01bb24aa37caf31ea0999dcfa40b8f9" class="line-numbers icon list-numbered"><code class="language-systemd" data-file="/etc/systemd/system/systemd-socket-proxyd@fastcgi.socket.d/fastcgi.conf"><div class="line"><a></a><span class="k">[Socket]</span>
</div><div class="line"><a></a><span class="na">SocketGroup</span><span class="o">=</span><span class="s">nginx</span></div></code></pre>
<p>Note how we extended the template for a specific named instance of the socket
unit: we defined the <code>systemd-socket-proxyd@fastcgi.socket.d</code> sub-directory and
put a drop-in configuration snippet there.</p>
<p>Now, to achieve our goal we need to specify the target endpoint for our proxy
service (the named instance we spawn using the template):</p>
<pre class="highlight"><input type="radio" name="code_menu12308524cbf428b281daf1f11567ffd99737e27b" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu12308524cbf428b281daf1f11567ffd99737e27b" class="line-numbers icon list-numbered"><code class="language-systemd" data-file="/etc/systemd/system/systemd-socket-proxyd@fastcgi.service.d/fastcgi.conf"><div class="line"><a></a><span class="k">[Service]</span>
</div><div class="line"><a></a><span class="c1"># Reset the ExecStart, so we could override it</span>
</div><div class="line"><a></a><span class="na">ExecStart</span><span class="o">=</span>
</div><div class="line"><a></a><span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/lib/systemd/systemd-socket-proxyd remote.php.backend.domain.tld.:9000</span></div></code></pre>
<p>The mechanics behind extending the configuration is the same as for the socket
unit, but here we overrode the <code>ExecStart</code> command to specify the target endpoint
for the proxy.</p>
<p>OK, we are done with the configuration of <code>systemd</code>, so it would be a good time
to reload the <code>systemd</code> daemon:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu1890d918bbd740675f143763585069f1b474c11d" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu1890d918bbd740675f143763585069f1b474c11d" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>systemctl<span class="w"> </span>daemon-reload</div></code></pre>
<p>If you run a system where SELinux is disabled (why?!) you don&rsquo;t need to do
anything additional and should be good, but if you are security conscious and
want to ensure that you follow the least privilege principle, then read on :)</p>
<p>Unfortunately, <code>systemd-socket-proxyd</code> seems not to be used a lot by the
community (most likely people are just unaware of it) so the tool has no
dedicated policy attached to it in the targeted SELinux policy. I plan to push
the change into the SELinux reference policy, but before I do we are going to
use a custom loadable policy module.</p>
<p>To build a module you need the SELinux reference policy development framework
installed on the instance you are building your policies (it can be the same
instance you are running your proxy on, but I would advise to use a temporary
VM for building/compiling policies since the only time you need that
development stuff is when you are compiling the module from sources).</p>
<p>On CentOS, you can install all the necessary bits to build a loadable SELinux
module by installing the <code>selinux-policy-devel</code> package using <code>yum</code>:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu2b83652d42034e71d05d77d2b6901604f384fbe4" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu2b83652d42034e71d05d77d2b6901604f384fbe4" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>yum<span class="w"> </span>-y<span class="w"> </span>install<span class="w"> </span>selinux-policy-devel</div></code></pre>
<p>Note, I skipped the output of the command since it does not provide any useful
information for the purposes of this article.</p>
<p>Once the SELinux development framework is installed we can start designing our
loadable policy for the <code>systemd-socket-proxyd</code> service.</p>
<p>Our policy will consist of two files:</p>
<ul>
<li><code>systemd-socket-proxyd.te</code> &ndash; the type enforcement ruleset; and</li>
<li><code>systemd-socket-proxyd.fc</code> &ndash; the file context ruleset.</li>
</ul>
<p>Eventually, we will need to introduce the corresponding module interface
support file too, but for the purposes of this article we should be fine with
the automatically generated one.</p>
<p>The content of the systemd-socket-proxy.te file is listed below:</p>
<pre class="highlight"><input type="radio" name="code_menu303ae941afb9ed879e7e4742c6cd6bfb379781de" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu303ae941afb9ed879e7e4742c6cd6bfb379781de" class="line-numbers icon list-numbered"><code class="language-selinux" data-file="systemd-socket-proxy.te"><div class="line"><a></a><span class="nx">policy_module</span><span class="p">(</span><span class="nx">systemd</span><span class="o">-</span><span class="nx">socket</span><span class="o">-</span><span class="nx">proxyd</span><span class="p">,</span><span class="w"> </span><span class="m m-Double">1.0</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">desc</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w">  </span><span class="p">&lt;</span><span class="nx">p</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w">  </span><span class="nx">Allow</span><span class="w"> </span><span class="nx">systemd</span><span class="o">-</span><span class="nx">socket</span><span class="o">-</span><span class="nx">proxyd</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">bind</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="nx">instead</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">one</span><span class="w"> </span><span class="nx">labelled</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_port_t</span><span class="p">.</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w">  </span><span class="p">&lt;</span><span class="o">/</span><span class="nx">p</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="p">&lt;</span><span class="o">/</span><span class="nx">desc</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="nx">gen_tunable</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_bind_any</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">desc</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">p</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="nx">Allow</span><span class="w"> </span><span class="nx">systemd</span><span class="o">-</span><span class="nx">socket</span><span class="o">-</span><span class="nx">proxyd</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">connect</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">any</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="nx">instead</span><span class="w"> </span><span class="nx">of</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="nx">labelled</span><span class="w"> </span><span class="nx">ones</span><span class="p">.</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="p">&lt;</span><span class="o">/</span><span class="nx">p</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="err">##</span><span class="w"> </span><span class="p">&lt;</span><span class="o">/</span><span class="nx">desc</span><span class="p">&gt;</span>
</div><div class="line"><a></a><span class="nx">gen_tunable</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_connect_any</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="nx">systemd_domain_template</span><span class="p">(</span><span class="nx">systemd_socket_proxyd</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="k">type</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_unit_file_t</span><span class="p">;</span>
</div><div class="line"><a></a><span class="nx">systemd_unit_file</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_unit_file_t</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="nx">sysnet_dns_name_resolve</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_t</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="err">#</span><span class="w"> </span><span class="nx">resolver</span>
</div><div class="line"><a></a><span class="nx">allow</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_t</span><span class="w"> </span><span class="kp">self</span><span class="p">:</span><span class="nx">unix_dgram_socket</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">create</span><span class="w"> </span><span class="nx">getopt</span><span class="w"> </span><span class="nx">setopt</span><span class="w"> </span><span class="nx">sendto</span><span class="w"> </span><span class="nx">read</span><span class="w"> </span><span class="nx">write</span><span class="w"> </span><span class="p">};</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="err">#</span><span class="w"> </span><span class="nx">listener</span>
</div><div class="line"><a></a><span class="k">type</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_port_t</span><span class="p">;</span>
</div><div class="line"><a></a><span class="nx">corenet_port</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_port_t</span><span class="p">);</span>
</div><div class="line"><a></a><span class="nx">allow</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_t</span><span class="w"> </span><span class="kp">self</span><span class="p">:</span><span class="nx">tcp_socket</span><span class="w"> </span><span class="nx">accept</span><span class="p">;</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="nx">tunable_policy</span><span class="p">(</span><span class="err">`</span><span class="p">!</span><span class="nx">systemd_socket_proxyd_bind_any</span><span class="err">&#39;</span><span class="p">,</span><span class="err">`</span>
</div><div class="line"><a></a><span class="w"> </span><span class="nx">allow</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_t</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_port_t</span><span class="p">:</span><span class="nx">tcp_socket</span><span class="w"> </span><span class="nx">name_bind</span><span class="p">;</span>
</div><div class="line"><a></a><span class="err">&#39;</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="nx">tunable_policy</span><span class="p">(</span><span class="err">`</span><span class="nx">systemd_socket_proxyd_bind_any</span><span class="err">&#39;</span><span class="p">,</span><span class="err">`</span>
</div><div class="line"><a></a><span class="w"> </span><span class="nx">corenet_tcp_bind_all_ports</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_t</span><span class="p">)</span>
</div><div class="line"><a></a><span class="err">&#39;</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="err">#</span><span class="w"> </span><span class="nx">target</span>
</div><div class="line"><a></a><span class="nx">tunable_policy</span><span class="p">(</span><span class="err">`</span><span class="p">!</span><span class="nx">systemd_socket_proxyd_connect_any</span><span class="err">&#39;</span><span class="p">,</span><span class="err">`</span>
</div><div class="line"><a></a><span class="w"> </span><span class="nx">allow</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_t</span><span class="w"> </span><span class="nx">port_type</span><span class="p">:</span><span class="nx">tcp_socket</span><span class="w"> </span><span class="nx">name_connect</span><span class="p">;</span>
</div><div class="line"><a></a><span class="err">&#39;</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="nx">tunable_policy</span><span class="p">(</span><span class="err">`</span><span class="nx">systemd_socket_proxyd_connect_any</span><span class="err">&#39;</span><span class="p">,</span><span class="err">`</span>
</div><div class="line"><a></a><span class="w"> </span><span class="nx">corenet_tcp_connect_all_ports</span><span class="p">(</span><span class="nx">systemd_socket_proxyd_t</span><span class="p">)</span>
</div><div class="line"><a></a><span class="err">&#39;</span><span class="p">)</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="err">#</span><span class="w"> </span><span class="nx">consumer</span>
</div><div class="line"><a></a><span class="nx">allow</span><span class="w"> </span><span class="nx">daemon</span><span class="w"> </span><span class="nx">systemd_socket_proxyd_t</span><span class="p">:</span><span class="nx">unix_stream_socket</span><span class="w"> </span><span class="nx">connectto</span><span class="p">;</span></div></code></pre>
<p>This is still work in progress, but so far it works at least for my projects.
Note that there are two SELinux booleans defined which affect the behaviour of
the policy:</p>
<ul>
<li>
<p>systemd_socket_proxyd_bind_any</p>
<p>allows to bind proxy to any TCP socket if set to true, otherwise the proxy
would be able to connect to TCP ports labelled with
<code>systemd_socket_proxyd_port_t</code>;</p>
</li>
<li>
<p>systemd_socket_proxyd_connect_any</p>
<p>allows proxy to connect to any target TCP ports if set to true, otherwise
the target is limited by the ports labelled with
<code>systemd_socket_proxyd_port_t</code>.</p>
</li>
</ul>
<p>Now, to allow the proper transition into the <code>systemd_socket_proxyd_t</code> domain we
need to label the <code>systemd-socket-proxyd</code> binary with the
<code>systemd_socket_proxyd_exec_t</code> label.</p>
<p>The content of the systemd-socket-proxy.fc file that implements this behavior
is as follows:</p>
<pre class="highlight"><input type="radio" name="code_menu0fa1047433e9cf6bdeabc4c94fe57b8da97f3ae9" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu0fa1047433e9cf6bdeabc4c94fe57b8da97f3ae9" class="line-numbers icon list-numbered"><code class="language-selinux" data-file="systemd-socket-proxy.fc"><div class="line"><a></a>/(usr/lib|etc)/systemd/system/systemd-socket-proxyd\.service  gen_context(system_u:object_r:systemd_socket_proxyd_unit_file_t,s0)
</div><div class="line"><a></a>/usr/lib/systemd/systemd-socket-proxyd -- gen_context(system_u:object_r:systemd_socket_proxyd_exec_t,s0)</div></code></pre>
<p>At this point, we have everything we need to compile a policy module, so let&rsquo;s
just do it now:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu6b3a080fc62691c3c861fb8e0931c05e1bae25b8" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu6b3a080fc62691c3c861fb8e0931c05e1bae25b8" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>ls<span class="w"> </span>-l
</div><div class="line"><a></a><span class="go">total 8</span>
</div><div class="line"><a></a><span class="go">-rw-r--r--. 1 root root  235 Jan  5 05:21 systemd-socket-proxyd.fc</span>
</div><div class="line"><a></a><span class="go">-rw-r--r--. 1 root root 1467 Jan  6 00:10 systemd-socket-proxyd.te</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>make<span class="w"> </span>-f<span class="w"> </span>/usr/share/selinux/devel/Makefile
</div><div class="line"><a></a><span class="go">Compiling targeted systemd-socket-proxyd module</span>
</div><div class="line"><a></a><span class="go">/usr/bin/checkmodule:  loading policy configuration from tmp/systemd-socket-proxyd.tmp</span>
</div><div class="line"><a></a><span class="go">/usr/bin/checkmodule:  policy configuration loaded</span>
</div><div class="line"><a></a><span class="go">/usr/bin/checkmodule:  writing binary representation (version 17) to tmp/systemd-socket-proxyd.mod</span>
</div><div class="line"><a></a><span class="go">Creating targeted systemd-socket-proxyd.pp policy package</span>
</div><div class="line"><a></a><span class="go">rm tmp/systemd-socket-proxyd.mod tmp/systemd-socket-proxyd.mod.fc</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>semodule<span class="w"> </span>-i<span class="w"> </span>systemd-socket-proxyd.pp
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>restorecon<span class="w"> </span>-v<span class="w"> </span>/usr/lib/systemd/systemd-socket-proxyd
</div><div class="line"><a></a><span class="go">restorecon reset /usr/lib/systemd/systemd-socket-proxyd context system_u:object_r:init_exec_t:s0-&gt;system_u:object_r:systemd_socket_proxyd_exec_t:s0</span></div></code></pre>
<p>The <code>semodule -i systemd-socket-proxyd.pp</code> command has actually installed the
module into the system, but if you were building the module on a different
instance, then instead of installing the module you just need to grab the
resulting <code>systemd-socket-proxyd.pp</code> file and transfer it to the target instance
where proxy is going to be running and only apply the last two commands
(<code>semodule -i ...</code> and <code>restorecon</code>).</p>
<p>We approached the time when we need to perform the pre-flight checks before
launching our new service :). First, we need to check whether the file context
was applied to the <code>systemd-socket-proxyd binary</code>:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menub1bbacbfacf313ca72e5a1c097ed766eec8fecda" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menub1bbacbfacf313ca72e5a1c097ed766eec8fecda" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>ls<span class="w"> </span>-ldZ<span class="w"> </span>/usr/lib/systemd/systemd-socket-proxyd<span class="w"> </span>
</div><div class="line"><a></a><span class="go">-rwxr-xr-x. root root system_u:object_r:systemd_socket_proxyd_exec_t:s0 /usr/lib/systemd/systemd-socket-proxyd</span></div></code></pre>
<p>Looks good! Let&rsquo;s start the socket unit and check the permissions set on the
socket file:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu87c6c5d57435f9c9f2372ffb3f57ec33245e7d8c" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu87c6c5d57435f9c9f2372ffb3f57ec33245e7d8c" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>systemctl<span class="w"> </span>start<span class="w"> </span>systemd-socket-proxyd@fastcgi.socket
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>ls<span class="w"> </span>-ldZ<span class="w"> </span>/run/systemd-socket-proxyd<span class="o">{</span>,/fastcgi.sock<span class="o">}</span>
</div><div class="line"><a></a><span class="go">drwx--x--x. root root  system_u:object_r:var_run_t:s0   /run/systemd-socket-proxyd</span>
</div><div class="line"><a></a><span class="go">srw-rw----. root nginx system_u:object_r:var_run_t:s0   /run/systemd-socket-proxyd/fastcgi.sock</span></div></code></pre>
<p>This also looks as expected. The next test would be to check that our proxy
service is running with the desired set of permissions and in the correct
SELinux domain:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu07c03a413ad1b729cc8096ea09fbd8bd611bc269" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu07c03a413ad1b729cc8096ea09fbd8bd611bc269" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>socat<span class="w"> </span>-v<span class="w"> </span>unix-client:/run/systemd-socket-proxyd/fastcgi.sock<span class="w"> </span>stdin
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="go">&lt; 2017/01/13 00:59:22.987083  length=1 from=0 to=0</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>ps<span class="w"> </span>uZ<span class="w"> </span>-C<span class="w"> </span>systemd-socket-proxyd
</div><div class="line"><a></a><span class="go">LABEL                           USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span>
</div><div class="line"><a></a><span class="go">system_u:system_r:systemd_socket_proxyd_t:s0 nobody 28643 0.0  0.0 86628 756 ? Ssl  00:59   0:00 /usr/lib/systemd/systemd-socket-proxyd 127.0.0.1:9000</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>cat<span class="w"> </span>/proc/28643/status<span class="w"> </span>
</div><div class="line"><a></a><span class="go">Name: systemd-socket-</span>
</div><div class="line"><a></a><span class="go">State: S (sleeping)</span>
</div><div class="line"><a></a><span class="go">Tgid: 28643</span>
</div><div class="line"><a></a><span class="go">Ngid: 0</span>
</div><div class="line"><a></a><span class="go">Pid: 28643</span>
</div><div class="line"><a></a><span class="go">PPid: 1</span>
</div><div class="line"><a></a><span class="go">TracerPid: 0</span>
</div><div class="line"><a></a><span class="go">Uid: 99 99 99 99</span>
</div><div class="line"><a></a><span class="go">Gid: 99 99 99 99</span>
</div><div class="line"><a></a><span class="go">FDSize: 64</span>
</div><div class="line"><a></a><span class="go">Groups: 99 </span>
</div><div class="line"><a></a><span class="go">[truncated]</span></div></code></pre>
<p>The first <code>socat</code> command was needed to trigger the socket activation that
resulted in the <code>systemd-socket-proxyd.service</code> being launched.</p>
<p>The second command confirmed that the service is running under the nobody user
and within the <code>systemd_socket_proxyd_t</code> domain.</p>
<p>Finally, the third command confirmed that the privileges were properly dropped
and there is no way the service could regain the escalated privileges back.</p>
<p>Looks like we are all, so let&rsquo;s make our changes persistent. To achieve this we
just need to enable the <code>systemd-socket-proxyd@fastcgi.socket</code> unit:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu4bc6e9f8b4fbc7cbba74f2b6e15f15439bc13918" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu4bc6e9f8b4fbc7cbba74f2b6e15f15439bc13918" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>systemd-socket-proxyd@fastcgi.socket
</div><div class="line"><a></a><span class="go">Created symlink from /etc/systemd/system/sockets.target.wants/systemd-socket-proxyd@fastcgi.socket to /etc/systemd/system/systemd-socket-proxyd@.socket.</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>systemctl<span class="w"> </span>status<span class="w"> </span>systemd-socket-proxyd@fastcgi.socket<span class="w"> </span><span class="p">|</span><span class="w"> </span>fgrep<span class="w"> </span>Loaded:
</div><div class="line"><a></a><span class="go">   Loaded: loaded (/etc/systemd/system/systemd-socket-proxyd@.socket; enabled; vendor preset: disabled)</span></div></code></pre>
<p>Just to show that the configuration is working I set a simple lab up in a VM
and followed this article with the only exception of the PHP/FPM location which
I am running on the same VM:</p>
<pre class="highlight" data-user="root"><input type="radio" name="code_menu41dd77b091a96cca9e70ff322531ec95f38d687d" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu41dd77b091a96cca9e70ff322531ec95f38d687d" class="line-numbers icon list-numbered"><code class="language-console"><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>cat<span class="w"> </span>/usr/share/nginx/html/test.php
</div><div class="line"><a></a><span class="go">&lt;?php echo &quot;This is the output from PHP\n&quot; ?&gt;</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>cat<span class="w"> </span>/etc/nginx/conf.d/php-upstream.conf<span class="w"> </span>
</div><div class="line"><a></a><span class="go">upstream php {</span>
</div><div class="line"><a></a><span class="gp">    #</span>server<span class="w">        </span>remote.php.backend.domain.tld.:9000
</div><div class="line"><a></a><span class="go">    server         unix:/run/systemd-socket-proxyd/fastcgi.sock;</span>
</div><div class="line"><a></a><span class="go">}</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>cat<span class="w"> </span>/etc/nginx/default.d/php.conf
</div><div class="line"><a></a><span class="go">location ~ \.php$ {</span>
</div><div class="line"><a></a><span class="go">    try_files      $uri = 404;</span>
</div><div class="line"><a></a><span class="go">    fastcgi_pass   php;</span>
</div><div class="line"><a></a><span class="go">    fastcgi_index  index.php;</span>
</div><div class="line"><a></a><span class="go">    include        fastcgi.conf;</span>
</div><div class="line"><a></a><span class="go">}</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>cat<span class="w"> </span>/etc/systemd/system/systemd-socket-proxyd@fastcgi.service.d/fastcgi.conf
</div><div class="line"><a></a><span class="go">[Service]</span>
</div><div class="line"><a></a><span class="gp"># </span>Reset<span class="w"> </span>the<span class="w"> </span>ExecStart,<span class="w"> </span>so<span class="w"> </span>we<span class="w"> </span>could<span class="w"> </span>override<span class="w"> </span>it
</div><div class="line"><a></a><span class="go">ExecStart=</span>
</div><div class="line"><a></a><span class="go">ExecStart=/usr/lib/systemd/systemd-socket-proxyd 127.0.0.1:9000</span>
</div><div class="line"><a></a><span class="gp">[root@localhost ~]# </span>telnet<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="m">80</span>
</div><div class="line"><a></a><span class="go">Trying 0.0.0.0...</span>
</div><div class="line"><a></a><span class="go">Connected to 0.</span>
</div><div class="line"><a></a><span class="go">Escape character is &#39;^]&#39;.</span>
</div><div class="line"><a></a><span class="go">GET /test.php HTTP/1.0</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="go">HTTP/1.1 200 OK</span>
</div><div class="line"><a></a><span class="go">Server: nginx/1.10.2</span>
</div><div class="line"><a></a><span class="go">Date: Fri, 13 Jan 2017 03:01:16 GMT</span>
</div><div class="line"><a></a><span class="go">Content-Type: text/html</span>
</div><div class="line"><a></a><span class="go">Connection: close</span>
</div><div class="line"><a></a><span class="go">X-Powered-By: PHP/5.4.16</span>
</div><div class="line"><a></a>
</div><div class="line"><a></a><span class="go">This is the output from PHP</span>
</div><div class="line"><a></a><span class="go">Connection closed by foreign host.</span></div></code></pre>
<p>Works as expected :).</p>
<p>There is one thing one needs to be aware of: when I started to work on this I
discovered that <code>systemd-socket-proxyd</code> had a hard-coded limit for the number
of connections set to 256 (I <a href="https://github.com/systemd/systemd/commit/dc3b8afb93f188f212218487ab62fd3f12a2b58f">introduced the <code>-c</code> parameter</a> to
<code>systemd-socket-proxyd</code>, so one could dynamically set the limit, however it
would take some time until this change is propagated to all major distros).</p>
<p>Also, it is worth it to mention that the provided configuration is not
efficient if you are using a domain name for the target endpoint for the proxy,
so if this is the case I would advise to run a local DNS caching service (e.g.
<code>dnsmasq</code>) so you would not spend time on the DNS queries.</p>
<p>As always, I would appreciate any feedback you may have.</p>
				<footer>
					<span><span class="contextual">Offloaded on </span><time datetime="2017-01-13T10:00:00+11:00">
						<span class="month"><a href="/2017/01/" title="A link to the archives for January of 2017">Jan<span class="month full">uary</span></a></span>
						<span class="day">13</span>
						<span class="year"><a href="/2017/" title="A link to the archives for the year of 2017">2017</a></span>
					</time></span>
						<span class="contextual">into </span><span class="category"><a href="/category/hacking/" title="A link to a collection of articles in the 'hacking' category">hacking</a></span>
					<span class="contextual">and tagged with:</span>
					<ul class="tags">
						<li class="tag">
							<span>
								<a href="/tag/nginx/" rel="tag" title="A link to the collection tagged with 'nginx'" data-count="2" ><span>nginx</span></a>
							</span>
						</li>
						<li class="tag">
							<span>
								<a href="/tag/patch/" rel="tag" title="A link to the collection tagged with 'patch'" data-count="2" ><span>patch</span></a>
							</span>
						</li>
						</ul>
				</footer>
			</article>
		<footer>
		</footer>
	</main>
	<footer>
	</footer>
</body>
</html>