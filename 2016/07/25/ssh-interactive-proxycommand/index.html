<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Security-Policy" content="	default-src 'self';object-src 'none';script-src 'self' https://www.googletagmanager.com/gtag/js 'sha256-TelA7VsuYAMqhOKGk7CHgJyuqSJdmqZEp+hn6PWVRwQ=' https://www.google-analytics.com/analytics.js;img-src 'self' data: https://www.google-analytics.com/r/collect https://www.google-analytics.com/collect https://stats.g.doubleclick.net/r/collect https://*/ads/ga-audiences;style-src 'self' 'sha256-fszvBX/J9dhPxFSJ5wUrq/Pvg6HrnTkWyshMZpaxSQY=';connect-src 'self' https://www.google-analytics.com/j/collect https://stats.g.doubleclick.net/j/collect; " />
		<title>Mind Drops</title>
		<script src="/theme/js/persistence.js" defer></script>
		<meta charset="utf-8" />
		<meta name="description" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#535353" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="format-detection" content="telephone=no" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="apple-mobile-web-app-title" content="Mind Drops" />
		<meta name="description" content="">
		<link rel="apple-touch-icon" href="/theme/images/icons/mind-drops-192x192.png" />
		<link rel="manifest" type="text/json" href="/manifest.json" />
		<link rel="alternate" type="application/atom+xml" href="https://dmitry.khlebnikov.net/feeds/all.atom.xml" title="Mind Drops Full Atom Feed" />
		<link rel="alternate" type="application/atom+xml" href="https://dmitry.khlebnikov.net/feeds/ssh.atom.xml" title="Mind Drops Categories Atom Feed" />
		<link rel="dns-prefetch" href="https://www.google.com" />
		<link rel="preconnect" href="https://www.google.com" crossorigin />
		<link rel="dns-prefetch" href="https://www.google-analytics.com" />
		<link rel="preconnect" href="https://www.google-analytics.com" crossorigin />
		<link rel="dns-prefetch" href="https://www.googletagmanager.com">
		<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
		<link rel="dns-prefetch" href="https://stats.g.doubleclick.net" />
		<link rel="preconnect" href="https://stats.g.doubleclick.net" crossorigin />
		<link rel="preload" as="style" href="/theme/css/reset.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/Icons.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/Exo2.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/Oswald.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/DancingScript.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/FiraCode.css" />
		<link rel="preload" as="style" href="/theme/css/base.css" />
		<link rel="preload" as="script" href="/theme/js/persistence.js" />
		<link rel="preload" as="script" href="/theme/js/visited.js" />
		<link rel="preload" as="script" href="/theme/js/service.js" />
		<link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=UA-165060547-1" />
		<link rel="icon" type="image/png" href="/images/galaxy.png" />
		<script src="/theme/js/loader.js" defer></script>

		<meta name="keywords" content="ssh console" />
		<link rel="stylesheet" type="text/css" href="/theme/css/article.css" />
		<link rel="canonical" href="/2016/07/25/ssh-interactive-proxycommand/" />
	</head>
	<body>

		<input type="radio" name="menu-toggle" id="menu-toggle-full" value="full" tabindex="-1" checked />
		<input type="radio" name="menu-toggle" id="menu-toggle-mini" value="mini" tabindex="-1" />
		<input type="radio" name="menu-toggle" id="menu-toggle-hide" value="hide" tabindex="-1" />
		<label for="menu-toggle-full" class="icon menu" role="radio" tabindex="0">Show the full menu panel on the screen</label>
		<aside id="sidebar">
			<label for="menu-toggle-mini" class="icon left-big" role="radio" tabindex="0">Show the minimised menu panel on the screen</label>
			<label for="menu-toggle-hide" class="icon eye-off" role="radio" tabindex="0">Remove the menu panel off the screen</label>
			<div class="title">Mind Drops</div>
			<div id="logo" class="box shadow">
				<picture>
					<source srcset="/images/galaxy.png.webp" type="image/webp">
					<img src="/images/galaxy.png" alt="Logo">
				</picture>
			</div>

			<!-- Search -->
			<section class="box search">
				<form name="google search" class="icon search" method="get" action="/search">
					<label for="search" class="offscreen">Search</label>
					<input id="search" type="text" class="text" name="q" placeholder="Search" />
				</form>
			</section>

			<nav>
				<ul>
					<li>
						<a class="icon home" href="/">Home</a>
					</li>
					<li>
						<a class="icon user" href="/about">About</a>
					</li>
					<li>
						<a class="icon phone" href="/contact">Contact</a>
					</li>
				</ul>
			</nav>

			<!-- Text -->
			<section class="box text-style1">
				<div class="inner">
					<p>
						<strong>Mind Drops:</strong>: A place to unload all these assorted bits.
					</p>
				</div>
			</section>

			<!-- Copyright -->
			<ul id="copyright">
				<li>&copy; Openwall Pty Ltd 2020 </li>
				<li><a href="/legal/terms-of-service">Terms of Service</a></li>
			</ul>
		</aside>

		<!-- Content -->
		<div id="content">
			<div class="inner">
				<article id="ssh-interactive-proxycommand" class="box post">
					<header>
						<h1><a name="top">SSH: Interactive ProxyCommand</a></h1>
					</header>
					<div class="info">
						<span class="date">
							<span class="day">25</span>
							<span class="month"><a href="/2016/07/">Jul<span class="month full">y</span></a></span>
							<span class="year"><a href="/2016/">2016</a></span>
						</span>
						<ul class="stats">
							<li><a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="icon twitter" aria-label="Twitter" data-tweet-id="1256898089043890176">0</a></li>
						</ul>
					</div>
					<p>I was involved in the creation of the <a href="https://github.com/realestate-com-au/sshephalopod">sshephalopod</a> project, which was an
attempt to build an enterprise level authentication framework for SSH
authentication using the SSH <abbr title="Certificate Authority">CA</abbr> feature.</p>
<p>The project is based on a wrapper script that signs a user via a <abbr title="Security Assertion Markup Language">SAML</abbr> identity
provider and gets user&rsquo;s public key signed for the further usage.</p>
<p>In one of the discussions I pointed out that such a wrapper script is not good
for the end user experience and I proposed to provide the users with an excerpt
for their ssh config file, so the functionality of sshephalopod would be
transparent to the general usage scenario of the ssh tool.</p>
<p>The response was that ProxyCommand do not support interactivity. Well, as they
say: The challenge is accepted :)</p>
<p>The following is my train of thoughts before I came up with a general solution
on how to allow an interactive command to be used as the ProxyCommand in the
ssh config file.</p>
<p>Before we start solving the problem at hand we need to create a test
environment, so we would be able to confirm when we reached success. The task
itself was very simple: we needed a host we could ssh into (an sshd daemon
running on the local host would be sufficient), then we needed an interactive
script, and a configuration block for the connection.</p>
<p>The configuration block is pretty simple (%h expands to localhost and %p
expands to the port specified on the command line or to &ldquo;22&rdquo; otherwise):</p>
<pre class="highlight" data-user="user"><code class="language-shell"><div class="lines"><a></a>[user@localhost ~]$ fgrep -A1 'Host localhost' ~/.ssh/config
</div><div class="lines"><a></a>Host localhost
</div><div class="lines"><a></a> ProxyCommand ~/bin/interactive.script.sh %h %p</div></code></pre>

<p>Since most of our research is going to be inside the interactive script you
will see several incarnations of script&rsquo;s body. The very first one was the
following:</p>
<pre class="highlight" data-file="~/bin/interactive.script.sh"><code class="language-bash"><div class="lines"><a></a>#!/bin/bash
</div><div class="lines"><a></a>exec nc &quot;$1&quot; &quot;$2&quot;</div></code></pre>

<p>At this point we just need to confirm that our test environment works as
expected &ndash; the ssh session should be proxied through the nc command and we
should be able to login under our own account via ssh to the localhost (my
private key was added to the key manager with ssh-add, hence no password prompt
was displayed):</p>
<pre class="highlight" data-user="user"><code class="language-shell"><div class="lines"><a></a>[user@localhost ~]$ ssh galaxy@localhost
</div><div class="lines"><a></a>Last login: Thu Jul 21 01:30:21 2016
</div><div class="lines"><a></a>$</div></code></pre>

<p>OK, we confirmed that we can establish a proxied connection and tunnel our ssh
session through it.</p>
<p>Each interactive script or program relies on the communication channel with the
user otherwise it could not be interactive. This channel comprises at least of
two file descriptors: one for standard input and the other for standard output,
so let&rsquo;s check what descriptors are available for our script:</p>
<pre class="highlight" data="file="~/bin/interactive.script.sh""><code class="language-bash"><div class="lines"><a></a>#!/bin/bash
</div><div class="lines"><a></a># on Linux the following line would be much simpler: ls -l /proc/$$/fd/, but
</div><div class="lines"><a></a># on OS X they do not expose the open file descriptors through /proc, so I
</div><div class="lines"><a></a># used &quot;lsof&quot; instead.
</div><div class="lines"><a></a>lsof -p $$ &gt;&amp;2
</div><div class="lines"><a></a>exec nc &quot;$1&quot; &quot;$2&quot;</div></code></pre>

<p>If we try to connect now we should see something like the following (I am
writing this article on an OS X machine so I provide the output from OS X,
however this also works for Linux):</p>
<pre class="highlight" data-user="user"><code class="language-shell"><div class="lines"><a></a>[user@localhost ~]$ ssh galaxy@localhost
</div><div class="lines"><a></a>COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF     NODE NAME
</div><div class="lines"><a></a>bash    45225   user  cwd    DIR                1,2       612   893854 /Users/user/.ssh
</div><div class="lines"><a></a>bash    45225   user  txt    REG                1,2    628640  2329236 /bin/bash
</div><div class="lines"><a></a>bash    45225   user  txt    REG                1,2    625712 13892061 /usr/lib/dyld
</div><div class="lines"><a></a>bash    45225   user  txt    REG                1,2 385393734 13894121 /private/var/run/dyld_shared_cache_x86_64
</div><div class="lines"><a></a>bash    45225   user    0   PIPE 0x44d71099589485df     16384          -&gt;0x44d7109951223d0f
</div><div class="lines"><a></a>bash    45225   user    1   PIPE 0x44d710995122454f     16384          -&gt;0x44d71099512246af
</div><div class="lines"><a></a>bash    45225   user    2u   CHR               16,1  0t631830     9705 /dev/ttys001
</div><div class="lines"><a></a>bash    45225   user  255r   REG                1,2       219 15455259 /Users/user/bin/interactive.script.sh
</div><div class="lines"><a></a>Last login: Mon Jul 25 17:52:40 2016 from localhost
</div><div class="lines"><a></a>$</div></code></pre>

<p>We are interested in file descriptors 0 (standard input), 1 (standard output),
and 2 (standard error). As you can see the standard input and output are part
of the pipes (presumably linking them to the parent ssh process) and standard
error is pointing to our terminal session.</p>
<p>I could have occupied a bit more of the page space showcasing that if you try
to communicate on standard input and/or output the ssh client will terminate
since you will be messing with the SSH protocol flow, but I believe you will
trust me on this :).</p>
<p>What can we do to interact with the user, yet to preserve the channel with the
parent ssh process? Well, the answer is quite obvious:</p>
<ul>
<li>we have a pointer to the terminal session (file descriptor 2, the standard
    error, points to the terminal),</li>
<li>so we just need to save pointers to the pipes&rsquo; ends,</li>
<li>re-open standard input and output with the terminal before we interact with
    the user,</li>
<li>and restore these file descriptors back once we are ready to hand over the
    ssh session.</li>
</ul>
<p>The following version of the script demonstrates the implementation of the
above logic:</p>
<pre class="highlight" data-file="~/bin/interactive.script.sh"><code class="language-bash"><div class="lines"><a></a>#!/bin/bash
</div><div class="lines"><a></a>exec 10&lt;&amp;0 11&gt;&amp;1 0&lt;&amp;2 1&gt;&amp;2
</div><div class="lines"><a></a># start of the interactive behaviour
</div><div class="lines"><a></a>lsof -p $$
</div><div class="lines"><a></a>read -p &quot;Type something: &quot; I
</div><div class="lines"><a></a>echo &quot;You typed: $I&quot;
</div><div class="lines"><a></a># finish of the interactive behaviour
</div><div class="lines"><a></a>exec 0&lt;&amp;10 1&gt;&amp;11
</div><div class="lines"><a></a>exec nc &quot;$1&quot; &quot;$2&quot;</div></code></pre>

<p>I think it is time to test it :) :</p>
<pre class="highlight" data-user="user"><code class="language-shell"><div class="lines"><a></a>[user@localhost ~]$ ssh galaxy@localhost
</div><div class="lines"><a></a>COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF     NODE NAME
</div><div class="lines"><a></a>bash    45238   user  cwd    DIR                1,2       612   893854 /Users/user/.ssh
</div><div class="lines"><a></a>bash    45238   user  txt    REG                1,2    628640  2329236 /bin/bash
</div><div class="lines"><a></a>bash    45238   user  txt    REG                1,2    625712 13892061 /usr/lib/dyld
</div><div class="lines"><a></a>bash    45238   user  txt    REG                1,2 385393734 13894121 /private/var/run/dyld_shared_cache_x86_64
</div><div class="lines"><a></a>bash    45238   user    0u   CHR               16,1  0t640407     9705 /dev/ttys001
</div><div class="lines"><a></a>bash    45238   user    1u   CHR               16,1  0t640407     9705 /dev/ttys001
</div><div class="lines"><a></a>bash    45238   user    2u   CHR               16,1  0t640407     9705 /dev/ttys001
</div><div class="lines"><a></a>bash    45238   user   10   PIPE 0x44d710995122378f     16384          -&gt;0x44d71099589494ff
</div><div class="lines"><a></a>bash    45238   user   11   PIPE 0x44d7109951223d0f     16384          -&gt;0x44d710995122454f
</div><div class="lines"><a></a>bash    45238   user  255r   REG                1,2       135 15455285 /Users/user/bin/interactive.script.sh
</div><div class="lines"><a></a>Type something: This is a test
</div><div class="lines"><a></a>You typed: This is a test
</div><div class="lines"><a></a>Last login: Mon Jul 25 17:57:05 2016 from localhost
</div><div class="lines"><a></a>$ logout
</div><div class="lines"><a></a>Connection to localhost closed.</div></code></pre>

<p>Mission accomplished! :)</p>
<p>I hope this small article would help somebody to design better wrappers around
SSH. Keep in mind that you could always optimise it further. For example, recent
versions of OpenSSH support passing of a file descriptor from the ProxyCommand
script, so if you have a decent netcat tool that supports the &ldquo;-F&rdquo; option
(fdpass) you could get native performance for the ssh communication link with
no proxy process hanging around.</p>
<p>P.S. if you have any questions do not hesitate to comment.</p>
					<ul class="tags">
						<li class="tag">
							<div>
								<a href="/tag/ssh/" class="tag name">ssh</a>
							</div>
							<a href="/tag/ssh/" class="tag count">4</a>
						</li>
						<li class="tag">
							<div>
								<a href="/tag/console/" class="tag name">console</a>
							</div>
							<a href="/tag/console/" class="tag count">7</a>
						</li>
					</ul>
					<footer>
						Offloaded on
						<time datetime="2016-07-25 10:00:00+10:00">Mon, 25/07/2016 at 10:00 (<a href="https://time.is/AEST" target="_blank" rel="noreferrer">AEST</a>)</time>
						<span class="category-tag"><a href="/category/ssh">ssh</a></span>
					</footer>				</article>
			</div>
		</div>
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-165060547-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-165060547-1');
		</script>
	</body>
</html>