<!DOCTYPE HTML>
<html lang="en">
	<head>
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.googletagmanager.com/gtag/js 'sha256-TelA7VsuYAMqhOKGk7CHgJyuqSJdmqZEp+hn6PWVRwQ=' https://www.google-analytics.com/analytics.js ; img-src 'self' https://www.google-analytics.com/r/collect https://www.google-analytics.com/collect https://stats.g.doubleclick.net/r/collect https://www.google.com/ads/ga-audiences https://www.google.com.au/ads/ga-audiences ; style-src 'self' 'sha256-fszvBX/J9dhPxFSJ5wUrq/Pvg6HrnTkWyshMZpaxSQY='; connect-src 'self' https://www.google-analytics.com/j/collect https://stats.g.doubleclick.net/j/collect ; " />
		<title>Mind Drops</title>
		<script src="/theme/js/persistence.js" defer></script>
		<meta charset="utf-8" />
		<meta name="description" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#535353" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="format-detection" content="telephone=no" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="apple-mobile-web-app-title" content="Mind Drops" />
		<meta name="description" content="">
		<link rel="apple-touch-icon" href="/theme/images/icons/mind-drops-192x192.png" />
		<link rel="manifest" type="text/json" href="/manifest.json" />
		<link rel="alternate" type="application/atom+xml" href="https://dmitry.khlebnikov.net/feeds/all.atom.xml" title="Mind Drops Full Atom Feed" />
		<link rel="alternate" type="application/atom+xml" href="https://dmitry.khlebnikov.net/feeds/ssh.atom.xml" title="Mind Drops Categories Atom Feed" />
		<link rel="dns-prefetch" href="https://www.google.com">
		<link rel="preconnect" href="https://www.google.com" crossorigin>
		<link rel="dns-prefetch" href="https://www.google-analytics.com">
		<link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
		<link rel="dns-prefetch" href="https://www.googletagmanager.com">
		<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
		<link rel="dns-prefetch" href="https://stats.g.doubleclick.net">
		<link rel="preconnect" href="https://stats.g.doubleclick.net" crossorigin>
		<link rel="preload" as="style" href="/theme/css/reset.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/Icons.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/Exo2.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/Oswald.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/DancingScript.css" />
		<link rel="preload" as="style" href="/theme/css/fonts/FiraCode.css" />
		<link rel="preload" as="style" href="/theme/css/base.css" />
		<link rel="preload" as="script" href="/theme/js/persistence.js" />
		<link rel="preload" as="script" href="/theme/js/visited.js" />
		<link rel="preload" as="script" href="/theme/js/service.js" />
		<link rel="preload" as="script" href="https://www.googletagmanager.com/gtag/js?id=UA-165060547-1" />
		<script src="/theme/js/loader.js" defer></script>
		<link rel="icon" type="image/png" href="/images/galaxy.png" />

		<link rel="stylesheet" type="text/css" href="/theme/css/article.css" />
		<meta name="tags" content="console" />
		<meta name="tags" content="ssh" />
		<meta name="tags" content="howto" />
	</head>
	<body>

		<input type="radio" name="menu-toggle" id="menu-toggle-full" value="full" tabindex="-1" checked />
		<input type="radio" name="menu-toggle" id="menu-toggle-mini" value="mini" tabindex="-1" />
		<input type="radio" name="menu-toggle" id="menu-toggle-hide" value="hide" tabindex="-1" />
		<label for="menu-toggle-full" class="icon menu" role="radio" tabindex="0">Show the full menu panel on the screen</label>
		<aside id="sidebar">
			<label for="menu-toggle-mini" class="icon left-big" role="radio" tabindex="0">Show the minimised menu panel on the screen</label>
			<label for="menu-toggle-hide" class="icon eye-off" role="radio" tabindex="0">Remove the menu panel off the screen</label>
			<div id="logo" class="box shadow">
				<picture>
					<source srcset="/images/galaxy.png.webp" type="image/webp">
					<img src="/images/galaxy.png" alt="Logo">
				</picture>
			</div>

			<!-- Search -->
			<section class="box search">
				<form name="google search" class="icon search" method="get" action="/search">
					<label for="search" class="offscreen">Search</label>
					<input id="search" type="text" class="text" name="q" placeholder="Search" />
				</form>
			</section>

			<nav>
				<ul>
					<li>
						<a class="icon home" href="/">Home</a>
					</li>
					<li>
						<a class="icon user" href="/about">About</a>
					</li>
					<li>
						<a class="icon phone" href="/contact">Contact</a>
					</li>
				</ul>
			</nav>

			<!-- Text -->
			<section class="box text-style1">
				<div class="inner">
					<p>
						<strong>Mind Drops:</strong>: A place to unload all these assorted bits.
					</p>
				</div>
			</section>

			<!-- Copyright -->
			<ul id="copyright">
				<li>&copy; Openwall Pty Ltd 2020 </li>
				<li><a href="/legal/terms-of-service">Terms of Service</a></li>
			</ul>
		</aside>

		<!-- Content -->
		<div id="content">
			<div class="inner">
				<article id="transparent-ssh-host-jumping-expert" class="box post">
					<header>
						<h1><a name="top">Transparent SSH host-jumping (Expert)</a></h1>
					</header>
					<div class="info">
						<span class="date"><span class="day">26</span> <span class="month">Jul<span>y</span></span> <span class="year">2016</span></span>
						<ul class="stats">
							<li><a href="#" class="icon fa-comment">?</a></li>
							<li><a href="#" class="icon fa-heart">?</a></li>
							<li><a href="#" class="icon fa-twitter">?</a></li>
							<li><a href="#" class="icon fa-facebook">?</a></li>
						</ul>
					</div>
					<p>A while ago in the <a href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/">Transparent SSH host-jumping (Advanced)</a> post I
described a technique on how one could jump quite effortlessly through a chain
of intermediate hosts. However, there was a catch: the user names and ports
across the whole chain should be the same and there was no easy way to change
that.</p>
<p>Given that I <a href="https://dmitry.khlebnikov.net/2016/07/25/ssh-interactive-proxycommand/">recently</a> paid quite a lot of attention to the ProxyCommand
directive I decided to look into the implementation of the helper script that
will allow one to tweak parameters for the hosts in the chain.</p>
<p>You can read the <a href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/">original</a> post for the details of how this host-jumping
technique works, here I am only going to provide the proxy script and the
corresponding ssh config parameter block to use the script.</p>
<p>The goal was to support the following syntax:</p>
<pre class="highlight"><code class="language-bash">$ ssh default_user@userA^hostA/userB^hostB:port/hostC</code></pre>


<p>It was a little challenge to come up with the character for identifying the
user part for intermediate hosts:</p>
<ul>
<li><code>@</code> - cannot be used since SSH parses the command line before providing the
    string to the ProxyCommand script</li>
<li><code>%</code> - cannot be used since SSH was thinking that I&rsquo;m trying to do an
    expansion of the internal SSH variable</li>
<li><code>!</code>, <code>$</code>, <code>(</code>, <code>)</code>, and <code>&amp;</code> - are all shell unfriendly</li>
</ul>
<p>So I decided on the <code>^</code> character as a delimiter.</p>
<p>In the proposed command above the &ldquo;default_user&rdquo; is the user name we ultimately
want to use for logging into the last host in the chain (it happens that this
user name will be used for any host in the chain where no alternative name is
provided).</p>
<p>Each host in the chain could also be provided with the relevant port or, if the
port is omitted, it will use the global port configuration (usually 22/tcp but
can be changed with the <code>-p</code> argument to ssh).  The script is a bit not optimised
(bash is really slow on string processing, but I decided to stick with pure
bash where it was possible):</p>
<pre class="highlight"><code class="language-bash">#!/bin/bash
set -eu -o pipefail
exec 10&lt;&amp;0 11&gt;&amp;1 0&lt;&amp;2 1&gt;&amp;2
DEFAULT_USER=&quot;$1&quot;
DEFAULT_PORT=&quot;$3&quot;
HOST_CHAIN=&quot;$2&quot;
HOST_NEXT=&quot;${HOST_CHAIN%%/*}&quot;
HOST_USER=&quot;${HOST_NEXT%%^*}&quot;
[ &quot;$HOST_USER&quot; == &quot;$HOST_NEXT&quot; ] &amp;&amp; HOST_USER=&quot;$DEFAULT_USER&quot; ||:
HOST_PORT=&quot;${HOST_NEXT##*:}&quot;
[ &quot;$HOST_PORT&quot; == &quot;$HOST_NEXT&quot; ] &amp;&amp; HOST_PORT=&quot;$DEFAULT_PORT&quot; ||:
TARGET_HOST=&quot;${HOST_CHAIN##*/}&quot;
TARGET_PORT=&quot;${TARGET_HOST##*:}&quot;
TARGET_HOST=&quot;${TARGET_HOST%:*}&quot;
[ &quot;$TARGET_PORT&quot; == &quot;$TARGET_HOST&quot; ] &amp;&amp; TARGET_PORT=&quot;$DEFAULT_PORT&quot; ||:
TARGET_HOST=&quot;${TARGET_HOST#*^}&quot;
HOST_NEXT=&quot;${HOST_NEXT#*^}&quot;
HOST_NEXT=&quot;${HOST_NEXT%:*}&quot;
HOST_CHAIN=&quot;${HOST_CHAIN%/*}&quot;
[ &quot;$HOST_CHAIN&quot; == &quot;${HOST_CHAIN#*/}&quot; ] &amp;&amp; HOST_CHAIN= || HOST_CHAIN=&quot;${HOST_CHAIN#*/}&quot;
HOST_CHAIN=&quot;$HOST_NEXT${HOST_CHAIN:+/$HOST_CHAIN}&quot;

if [ ! -d &quot;$HOME/.ssh/.sessions&quot; ]; then
    echo &quot;Creating the sessions directory&quot; &gt;&amp;2
    mkdir -m700 &quot;$HOME/.ssh/.sessions&quot;
fi

CONTROL_SOCKET=$(printf &quot;$HOST_USER@HOST_CHAIN:$HOST_PORT\n&quot; | shasum | cut -f1 -d' ')

exec 0&lt;&amp;10 1&gt;&amp;11
exec ssh \
    -o &quot;ControlMaster auto&quot; \
    -o &quot;ControlPath ~/.ssh/.sessions/$CONTROL_SOCKET&quot; \
    -o &quot;ControlPersist 120s&quot; \
    -l &quot;$HOST_USER&quot; \
    -p &quot;$HOST_PORT&quot; \
    &quot;$HOST_CHAIN&quot; \
    -W &quot;$TARGET_HOST&quot;:&quot;$TARGET_PORT&quot;</code></pre>


<p>The above is a proof of the concept and it &ldquo;works for me&rdquo; :). I am using it
every day when I need to access boxes behind a bastion host. Your mileage may
vary and you are free to create your own version of the script that would
perform better (I would be really glad if a version of such a script could be
shared with me).</p>
<p>The corresponding configuration block in the ssh config file looks as follows:</p>
<pre class="highlight"><code class="language-ssh_config">Host */*
    # if you uncomment ControlPath you also need to uncomment ControlMaster
    #ControlMaster auto
    # For OpenSSH &lt; 6.7 you may uncomment the following, but long chains will fail:
    #ControlPath   ~/.ssh/.sessions/%r@%h:%p
    # For OpenSSH &gt;= 6.7 you should uncomment the following:
    #ControlPath   ~/.ssh/.sessions/%C
    ProxyCommand ~/bin/ssh-helper.sh %r %h %p</code></pre>


<p>Well, this is a bit messy since OpenSSH introduced the <code>%C</code> macro in version 6.7
and without <code>%C</code> the ControlPath string gets too long for OpenSSH to create a
socket on the filesystem for long chains of hosts.</p>
					<ul class="tags">
						<li class="tag">
							<div>
								<a href="/tag/console/" class="tag name">console</a>
							</div>
							<a href="/tag/console/" class="tag count">7</a>
						</li>
						<li class="tag">
							<div>
								<a href="/tag/ssh/" class="tag name">ssh</a>
							</div>
							<a href="/tag/ssh/" class="tag count">4</a>
						</li>
						<li class="tag">
							<div>
								<a href="/tag/howto/" class="tag name">howto</a>
							</div>
							<a href="/tag/howto/" class="tag count">4</a>
						</li>
					</ul>
					<footer>
						Offloaded on
						<time datetime="2016-07-26 10:00:00+10:00">Tue, 26/07/2016 at 10:00 (<a href="https://time.is/AEST" target="_blank" rel="noreferrer">AEST</a>)</time>
						<span class="category-tag"><a href="/category/ssh">ssh</a></span>
					</footer>				</article>
			</div>
		</div>
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-165060547-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());
			gtag('config', 'UA-165060547-1');
		</script>
	</body>
</html>