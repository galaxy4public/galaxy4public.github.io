<!DOCTYPE html>
<html lang="en">
<head>
	<title>Mind Drops :: Automating Static Website Deployment</title>
	<meta name="description" content="A comprehensive guide to setting up a fully automated deployment pipeline for a static website using a private source repository and a public GitHub Pages repository. The author details a process that leverages GitHub Actions to build a Pelican-based site from a private repository — keeping API tokens and experimental code secure—and then deploys the generated static files to a public repository for hosting. Key steps include configuring separate public and private repositories, using a deploy key for secure authentication instead of a personal access token, and creating a detailed GitHub Action workflow. This workflow automates checking out both repositories, restoring file modification times for accurate content generation, installing dependencies, building the site with Pelican, and committing the changes to the public GitHub Pages repository only if new content has been generated." />
	<meta http-equiv="Content-Security-Policy" content="	default-src 'self';object-src 'none';script-src 'self' https://www.googletagmanager.com/gtag/js 'sha256-TelA7VsuYAMqhOKGk7CHgJyuqSJdmqZEp+hn6PWVRwQ=' https://www.google-analytics.com/analytics.js https://static.cloudflareinsights.com/beacon.min.js;img-src 'self' data: https://www.google-analytics.com/r/collect https://www.google-analytics.com/collect https://stats.g.doubleclick.net/r/collect https://*/ads/ga-audiences https://www.googletagmanager.com/a;style-src 'self' 'sha256-fszvBX/J9dhPxFSJ5wUrq/Pvg6HrnTkWyshMZpaxSQY=';connect-src 'self' https://www.google-analytics.com/j/collect https://stats.g.doubleclick.net/j/collect; " />
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
	<link rel="preload" href="/theme/fonts/Oswald/Oswald-VariableFont_wght.woff2" crossorigin="anonymous" as="font" type="font/woff2">
	<link rel="preload" href="/theme/fonts/Exo2/Exo2-VariableFont_wght.woff2" crossorigin="anonymous" as="font" type="font/woff2">	<link rel="stylesheet" href="/theme/css/fonts/Icons.css" />
	<link rel="stylesheet" href="/theme/css/fonts/Exo2.css" />
	<link rel="stylesheet" href="/theme/css/fonts/Oswald.css" />
	<link rel="stylesheet" href="/theme/css/fonts/DancingScript.css" />
	<link rel="stylesheet" href="/theme/css/base.css" />
	<link rel="stylesheet" href="/theme/css/pygments/default.css" />
	<link rel="canonical" href="https://dmitry.khlebnikov.net/2020/05/17/automating-static-website-deployment/" />

	<script type="application/ld+json">
	{
		"@context" : "https://schema.org",
		"@type" : "BlogPosting",
		"author": [{
			"@type": "Person",
			"name": "(GalaxyMaster)",
			"url": "https://dmitry.khlebnikov.net/about"
		}],
		"headline" : "Automating Static Website Deployment",
		"datePublished" : "2020-05-17T21:32:00+10:00",
		"dateModified" : "2025-10-15T23:06:20+11:00"
	}
	</script>
</head>

<body>
	<header>
		<span class="flex" data-nosnippet>
			<!--
			<button class="menu-toggle" type="button" tabindex="0" aria-label="Menu Toggle"><div></div></button>
			-->
			<nav class="menu-toggle" tabindex="0" aria-label="Menu Toggle"><div></div></nav>
			<a href="/" class="logo">
				<picture>
					<source srcset="/images/logo.svg" type="image/svg+xml">
					<source srcset="/images/.svg" type="image/svg+xml">
					<source srcset="/images/.webp" type="image/webp">
					<img width="100%" height="100%" src="/images/" alt="Logo">
				</picture>
				<span class="title">Mind Drops</span>
			</a>
			<nav>
				<ul>
					<li><a class="icon home" href="/">Home</a></li>
					<li><a class="icon user" href="/about">About</a></li>
					<li><a class="icon phone" href="/contact">Contact</a></li>
				</ul>
			</nav>
			<form id="search" role="search" autocomplete="off" method="get" action="/search">
				<label for="q" class="icon search">Search</label>
				<input type="text" name="q" id="q" placeholder="Search..." />
				<div class="help" aria-label="Search ">
					<dl>
						<dt>"search terms"</dt><dd>exact-match</dd>
						<dt>term1 | term2</dt><dd>term1 or term2</dd>
						<dt>term1 * term2</dt><dd>term1 followed by term2</dd>
						<dt>-term</dt><dd>exclude term</dd>
						<dt>(search terms)</dt><dd>groups terms</dd>
						<dt>ext:pdf</dt><dd>file type</dd>
					</dl>
				</div>
			</form>
			<ul class="taskbar">
				<li class="search-toggle"><label for="q" class="icon search offscreen" title="Toggle the search bar">Search</label></li>
				<!-- Not Implemented Yet
				<li><a href="#bug-report" class="icon bug offscreen" title="Report a spotted bug on the page">Report a bug</a></li>
				<li><a href="#preferences" class="icon cog offscreen" title="Configure personal preferences">Preferences</a></li>
				 -->
			</ul>
		</span>
	</header>
<!--
	<aside class="modal">
		<div id="bug-report">
			<a href="#" class="close"></a>
			<div class="content">
				<h1>Bug report</h1>
				<form id="bug-report-form" autocomplete="off">
					<textarea id="bug-report-body" name="bug-report-body">
					</textarea>
					<input type="submit" value="Submit">
				</form>
			</div>
		</div>
		<div id="preferences">
		</div>
	</aside>
 -->
	<main>
			<article id="automating-static-website-deployment">
				<header>
					<h1><a href="/2020/05/17/automating-static-website-deployment/" rel="bookmark" title="Permalink to Automating Static Website Deployment">Automating Static Website Deployment</a></h1>
				</header>
				<aside>
				</aside>
				<div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#setting-up-github-pages">Setting up GitHub Pages</a></li>
<li><a href="#setting-up-the-private-code-repository">Setting up the private, code repository</a></li>
<li><a href="#configuring-the-github-action-for-publishing">Configuring the GitHub Action for publishing</a></li>
</ul>
</div>
<p>In this post I am going to document the steps I took to implement a fully
automated deployment of my blog using GitHub Actions and GitHub Pages.</p>
<p>As always, I started my journey with the definition of what I really wanted to
get at the end:</p>
<ul>
<li>
<p>The website is published on GitHub pages</p>
<p>Since the website is static and all of its content can be easily downloaded
using a web crawler (like <code>wget --mirror https://website.tld</code>) I was OK
with exposing the structure in the public repository, which is what GitHub
offers on a free plan.</p>
</li>
<li>
<p>The code to generate the website should be private</p>
<p>I do a lot of work on the <abbr title="Static Site Generator">SSG</abbr> (which is Pelican in my case) itself: extend
it with plug-ins that may contain <abbr title="Application Programming Interface">API</abbr> tokens to reach out to some third
party <span><abbr title="Application Programming Interface">API</abbr></span>s, hack the core code when I want to quickly test stuff, etc. &ndash;
so, I really did not have any desire to publish publicly all the commotions
I did in the background (sometimes I do more than a hundred commits per day
just to experiment with different ideas I have).</p>
</li>
<li>
<p>There should be a valid history of changes in both repositories</p>
<p>Well, I would get the history on my private repository for free, since it
is the core value of maintaining a repository in the <abbr title="Version Control System">VCS</abbr>, but I also wanted
to have clean history of changes to the content I publish publicly.</p>
<p>It would be a pleasant bonus if the changes in the public repository could
refer back to the corresponding commit in the private repository.</p>
</li>
</ul>
<p>One may say that to do what I set out to do I would need to subscribe for a
paid account with GitHub since according to their <a href="https://help.github.com/en/github/working-with-github-pages/getting-started-with-github-pages">help page</a> GitHub Pages
for private repositories are only available on the paid plans.</p>
<p>However, as I pointed out above, it does not make sense to hide the content of
the actual static website, hence all I needed to do is to find a way how to
&ldquo;publish&rdquo; the resulting artefact to the GitHub Pages repository, and,
preferably, that &ldquo;publishing&rdquo; should happen on GitHub&rsquo;s side.</p>
<p>Luckily for me, GitHub started to support GitHub Actions on the free plan some
time ago and as long as it is not abused according to their terms and
conditions, it is a perfect vehicle for what I am trying to do, in my opinion.</p>
<h2 id="setting-up-github-pages">Setting up GitHub Pages</h2>
<p>There are multiple howtos and tutorials on the Internet regarding how to set GitHub
Pages up, including <a href="https://help.github.com/en/github/working-with-github-pages/getting-started-with-github-pages">the official help section on this topic</a>, so I will
only elaborate on details where I did something specific for the purposes of
achieving my goals.</p>
<p>There are different types of GitHub Pages:</p>
<ul>
<li>user or organisation</li>
<li>per-project</li>
</ul>
<p>The difference between two is subtle (the former requires a dedicated
repository for your website, while the latter allows you to keep it in a branch
of the existing repository), but for the purposes of this article I am assuming
that we are working with the user level GitHub pages which are residing in the
repository named &ldquo;<strong>&lt;username&gt;</strong>.github.io&rdquo; (where <strong>&lt;username&gt;</strong>
is your GitHub user name) as per the official documentation.</p>
<p>A few caveats I found and spent some time solving after following the official
documentation are listed below:</p>
<ul>
<li>
<p>GitHub&rsquo;s documentation assumes use of Jekyll for the site generation.</p>
<p>It is not obvious how to use a different <abbr title="Static Site Generator">SSG</abbr> (like Pelican).  As far as I
understand, there are multiple triggers for GitHub to consider that the
web site is in a &ldquo;published&rdquo; state, so just ignore any references to Jekyll
in the documentation: you will trip one of the triggers sooner or later,
for example by pushing HTML files into your repository.</p>
</li>
<li>
<p>Configure your <abbr title="Domain Name System">DNS</abbr> <em>before</em> setting the custom domain name in GitHub Pages.</p>
<p>Pushing the <code>CNAME</code> file with the name of your custom domain within will
trigger a <abbr title="Domain Name System">DNS</abbr> check from GitHub to see that your custom domain name is
pointing back to GitHub Pages.</p>
<p><abbr title="Domain Name System">DNS</abbr> heavily relies on caching and depending on the <abbr title="Time To Live">TTL</abbr> settings in your
zone: if a negative check is performed (that is, when GitHub fails to
retrieve the corresponding record) you will likely need to wait for quite a
while for GitHub to retry.</p>
<p>Setting up the <code>CNAME</code> record in advance and then verifying it with a query
<em>before</em> you commit the <code>CNAME</code> file to your repository ensures that you
will get the quickest validation response from GitHub, e.g. I set up my
<code>CNAME</code> records and then verified it from the command line (before)
submitting the request to GitHub:</p>
<pre id="code1" class="highlight" data-user="user"><input type="radio" name="code_menu7b7d79f5964a012ca92dac47c79d82161c28b82f" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu7b7d79f5964a012ca92dac47c79d82161c28b82f" class="line-numbers icon list-numbered"><code class="language-console"><div id="code1.1" class="line"><a href="#code1.1" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>host<span class="w"> </span>-t<span class="w"> </span>cname<span class="w"> </span>dmitry.khlebnikov.net<span class="w"> </span><span class="m">8</span>.8.8.8
</div><div id="code1.2" class="line"><a href="#code1.2" aria-hidden="true"></a><span class="go">Using domain server:</span>
</div><div id="code1.3" class="line"><a href="#code1.3" aria-hidden="true"></a><span class="go">Name: 8.8.8.8</span>
</div><div id="code1.4" class="line"><a href="#code1.4" aria-hidden="true"></a><span class="go">Address: 8.8.8.8#53</span>
</div><div id="code1.5" class="line"><a href="#code1.5" aria-hidden="true"></a><span class="go">Aliases:</span>
</div><div id="code1.6" class="line"><a href="#code1.6" aria-hidden="true"></a>
</div><div id="code1.7" class="line"><a href="#code1.7" aria-hidden="true"></a><span class="go">dmitry.khlebnikov.net is an alias for galaxy4public.github.io.</span></div></code></pre>
</li>
<li>
<p>There are some shenanigans with the &ldquo;Enforce HTTPS&rdquo; option.</p>
<p>It is not obvious from the documentation, but the enforcement of HTTPS for
custom domains on GitHub&rsquo;s side is dependent on the several things:</p>
<ul>
<li>before the checkbox is enabled your custom domain name should be
    confirmed by GitHub (your <code>CNAME</code> file is in place and the repository
    settings show that the name was recognised);</li>
<li>the <code>CNAME</code> record should point to your &ldquo;<strong>&lt;username&gt;</strong>.github.io.&rdquo;
    <abbr title="Domain Name System">DNS</abbr> record (or, you can point it directly to GitHub Pages IP addresses
    if you want to conceal the repository name in the <abbr title="Domain Name System">DNS</abbr> output);</li>
<li>if GitHub did not like something and you adjusted anything in the above
    dot points the <strong>only</strong> way to trigger the enforcement of HTTPS is to
    re-submit the <code>CNAME</code> file to the repository (yes, you read it right:
    you need to delete the file and push it to the repository again);</li>
<li>Removing the <code>CNAME</code> file from the repository is a disruptive action &ndash;
    the site will not be accessible for the duration of the file being
    missing.</li>
</ul>
</li>
</ul>
<p>OK, you have your public repository configured the way you want, so let&rsquo;s look
at the settings we need to be able to publish our code to this public
repository.</p>
<p>When I try to automate something, I usually start with writing down manual
steps I would do to achieve the results.  This helps me to see patterns and to
understand what I can easily automate and what will require some brain-storming
to resolve.</p>
<p>In the case of updating the repository it is quite trivial: if I were to push
updates manually, all I need is a private <abbr title="Secure Shell">SSH</abbr> key with the corresponding public
<abbr title="Secure Shell">SSH</abbr> key configured with write privileges for the repository and I could push
with <code>git push</code> from my local copy of the repository.</p>
<blockquote>
<p><a name="quote-private-keys" href="#quote-private-keys" aria-hidden="true"></a> &hellip; private keys are called &ldquo;private&rdquo; for a reason &ndash; they are not supposed
to leave the device under any circumstances. [&hellip;] please pay attention when
you read of hear somebody advising you to upload your private keys somewhere,
it is usually bad advice.</p>
</blockquote>
<p>My private keys are called &ldquo;private&rdquo; for a reason &ndash; they are not supposed to
leave my device(s) under any circumstances (except for backup purposes such as
storing them in a safe).  So, please pay attention when you read or hear
somebody advising you to upload your private keys somewhere, it is usually
bad advice.</p>
<p>For the integration purposes, GitHub provides so-called &ldquo;Deploy keys&rdquo; and
&ldquo;Personal access tokens&rdquo;.  The former is just an <abbr title="Secure Shell">SSH</abbr> key pair associated with a
particular repository (you can configure it in repository&rsquo;s setting) while the
latter is an OAuth access token associated with <em>your</em> account.</p>
<p>While you can successfully use both, I would recommend to use the &ldquo;Deploy keys&rdquo;
only: despite that you can try to scope access down for a personal token,
it would not be good enough and the actions performed using that token will
look like <em>you</em> are executing them.</p>
<p>To configure a &ldquo;Deploy key&rdquo; we need two things:</p>
<ol>
<li>
<p>Generate an <abbr title="Secure Shell">SSH</abbr> key pair, e.g.:</p>
<pre id="code2" class="highlight" data-user="user"><input type="radio" name="code_menu581af6fe2fefabfde633963ec7c488a7e624832f" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu581af6fe2fefabfde633963ec7c488a7e624832f" class="line-numbers icon list-numbered"><code class="language-console"><div id="code2.1" class="line"><a href="#code2.1" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>ed25519<span class="w"> </span>-N<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span>-C<span class="w"> </span><span class="s1">&#39;Updating the blog from GH Action&#39;</span><span class="w"> </span>-f<span class="w"> </span>~/gh-action
</div><div id="code2.2" class="line"><a href="#code2.2" aria-hidden="true"></a><span class="go">Generating public/private ed25519 key pair.</span>
</div><div id="code2.3" class="line"><a href="#code2.3" aria-hidden="true"></a><span class="go">Your identification has been saved in /home/user/gh-action</span>
</div><div id="code2.4" class="line"><a href="#code2.4" aria-hidden="true"></a><span class="go">Your public key has been saved in /home/user/gh-action.pub</span>
</div><div id="code2.5" class="line"><a href="#code2.5" aria-hidden="true"></a><span class="go">The key fingerprint is:</span>
</div><div id="code2.6" class="line"><a href="#code2.6" aria-hidden="true"></a><span class="go">SHA256:7W9pUV5IlrRVE0RAVkjLgKJz4RdtVbH7GKQu8AfYITw Updating the blog from GH Action</span>
</div><div id="code2.7" class="line"><a href="#code2.7" aria-hidden="true"></a><span class="go">The key&#39;s randomart image is:</span>
</div><div id="code2.8" class="line"><a href="#code2.8" aria-hidden="true"></a><span class="go">+--[ED25519 256]--+</span>
</div><div id="code2.9" class="line"><a href="#code2.9" aria-hidden="true"></a><span class="go">|          o.+BOX*|</span>
</div><div id="code2.10" class="line"><a href="#code2.10" aria-hidden="true"></a><span class="go">|       + o o+.=oo|</span>
</div><div id="code2.11" class="line"><a href="#code2.11" aria-hidden="true"></a><span class="go">|      o E +  =oo |</span>
</div><div id="code2.12" class="line"><a href="#code2.12" aria-hidden="true"></a><span class="go">|     o o B . oo o|</span>
</div><div id="code2.13" class="line"><a href="#code2.13" aria-hidden="true"></a><span class="go">|      o S + .o.o |</span>
</div><div id="code2.14" class="line"><a href="#code2.14" aria-hidden="true"></a><span class="go">|         + o. .o.|</span>
</div><div id="code2.15" class="line"><a href="#code2.15" aria-hidden="true"></a><span class="go">|          + oo. .|</span>
</div><div id="code2.16" class="line"><a href="#code2.16" aria-hidden="true"></a><span class="go">|           ++    |</span>
</div><div id="code2.17" class="line"><a href="#code2.17" aria-hidden="true"></a><span class="go">|           o.    |</span>
</div><div id="code2.18" class="line"><a href="#code2.18" aria-hidden="true"></a><span class="go">+----[SHA256]-----+</span></div></code></pre>
<p>Here, I chose the <code>ed25519</code> key type since it is the shortest from the
GitHub supported key types at the moment, yet it is strong enough.</p>
<p>I also made the key pair passphrase-less (<code>-N ''</code>) since the purpose of the
key pair is to automate things in the unattended fashion and there will be
nobody to type in the passphrase.</p>
<p>The key pair comment just makes it easier to maintain your keys, but is optional.</p>
<p>Finally, the <code>-f ~/gh-action</code> option specifies where the generated private
key is going to be stored.  The public counterpart will use the same path with
the <code>.pub</code> suffix appended to it.</p>
</li>
<li>
<p>Set the newly generated <em>public</em> key up as the &ldquo;Deploy key&rdquo;:</p>
<p>All you need to do is to go to the repository settings page for the public
 repository you created for GitHub Pages, click on &ldquo;Deploy keys&rdquo; in the
 left side menu, then click on the &ldquo;Add deploy key&rdquo; button in the upper
 right corner.</p>
<p>On the next page, provide a sensible description for the deploy key (I
 used the same text as I put into the keys comment, i.e. &ldquo;Updating the blog
 from GH Action&rdquo;) and copy and paste the recently generated <em>public</em> key.
 GitHub does not allow you to upload files over there, so you need to copy
 the content of the <strong>public</strong> key file and paste it into the form, e.g.:</p>
<pre id="code3" class="highlight"><input type="radio" name="code_menub22e806c4d34ece0b29796b1b2792941793e2f85" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menub22e806c4d34ece0b29796b1b2792941793e2f85" class="line-numbers icon list-numbered"><code class="language-text" data-file="~/gh-action.pub"><div id="code3.1" class="line"><a href="#code3.1" aria-hidden="true"></a>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGHCy+stVCBjsrVO2ld1DwKCwcKL9+i1sjxcZu4u4lFQ Updating the blog from GH Action</div></code></pre>
<p><strong>NOTE</strong>: You need to ensure that you tick the &ldquo;Allow write access&rdquo; checkbox,
 otherwise it would not be possible to push to the repository with the
 corresponding private key.</p>
</li>
</ol>
<p>This, actually, concludes the configuration of the GitHub Pages repository for
now &ndash; in later articles I will document how one could leverage the repository
Issues for managing comments on the web site and maintain the counters for
likes on the pages, but it would be a completely separate post :).</p>
<h2 id="setting-up-the-private-code-repository">Setting up the private, code repository</h2>
<p>A typical Pelican repository layout is quite simple and comprises one
mandatory directory, one semi-mandatory file, and everything else is optional,
but could be used to enhance your experience.</p>
<p>The mandatory directory is the so-called
&ldquo;<a href="https://docs.getpelican.com/en/stable/install.html#kickstart-your-site">content</a>&rdquo;
directory (in Pelican&rsquo;s terms).  The name of the directory can be anything you
want, but it is better be reflected in <a href="https://docs.getpelican.com/en/stable/settings.html#PATH">the <code>PATH =</code>
directive</a> of the
setting file.</p>
<p>I am saying &ldquo;better be&rdquo; since Pelican can operate without any configuration
files, but the result will be limited, hence I call the <code>pelicanconf.py</code> file
(which is the default name for the configuration file) to be &ldquo;semi-mandatory&rdquo;.
The name of the configuration file can be also anything you like, however, I
suggest to stick with the default for now.</p>
<p>Basically, you can quickly start by following the Pelican documentation and
doing something as follows:</p>
<pre id="code4" class="highlight" data-user="user"><input type="radio" name="code_menu4e3d0d353455bb070e13d4f240c48f1a94002886" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu4e3d0d353455bb070e13d4f240c48f1a94002886" class="line-numbers icon list-numbered"><code class="language-console"><div id="code4.1" class="line"><a href="#code4.1" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>virtualenv<span class="w"> </span>~/venv/pelican
</div><div id="code4.2" class="line"><a href="#code4.2" aria-hidden="true"></a><span class="go">created virtual environment CPython3.8.2.final.0-64 in 477ms</span>
</div><div id="code4.3" class="line"><a href="#code4.3" aria-hidden="true"></a><span class="go">  creator CPython3Posix(dest=/home/user/venv/pelican, clear=False, global=False)</span>
</div><div id="code4.4" class="line"><a href="#code4.4" aria-hidden="true"></a><span class="go">  seeder FromAppData(download=False, pip=latest, setuptools=latest, wheel=latest, via=copy, app_data_dir=/home/user/.local/share/virtualenv/seed-app-data/v1.0.1)</span>
</div><div id="code4.5" class="line"><a href="#code4.5" aria-hidden="true"></a><span class="go">  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator</span>
</div><div id="code4.6" class="line"><a href="#code4.6" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>.<span class="w"> </span>~/venv/pelican/bin/activate
</div><div id="code4.7" class="line"><a href="#code4.7" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>mkdir<span class="w"> </span>~/blog
</div><div id="code4.8" class="line"><a href="#code4.8" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>~/blog
</div><div id="code4.9" class="line"><a href="#code4.9" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>git<span class="w"> </span>init
</div><div id="code4.10" class="line"><a href="#code4.10" aria-hidden="true"></a><span class="go">Initialized empty Git repository in /home/user/blog/.git/</span>
</div><div id="code4.11" class="line"><a href="#code4.11" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>git<span class="w"> </span>config<span class="w"> </span>--local<span class="w"> </span>user.email<span class="w"> </span><span class="s2">&quot;your@github-email.here&quot;</span>
</div><div id="code4.12" class="line"><a href="#code4.12" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>git<span class="w"> </span>config<span class="w"> </span>--local<span class="w"> </span>user.name<span class="w"> </span><span class="s2">&quot;Joe Happy&quot;</span>
</div><div id="code4.13" class="line"><a href="#code4.13" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>pelican-quickstart<span class="w"> </span>
</div><div id="code4.14" class="line"><a href="#code4.14" aria-hidden="true"></a><span class="go">Welcome to pelican-quickstart v4.2.0.</span>
</div><div id="code4.15" class="line"><a href="#code4.15" aria-hidden="true"></a>
</div><div id="code4.16" class="line"><a href="#code4.16" aria-hidden="true"></a><span class="go">This script will help you create a new Pelican-based website.</span>
</div><div id="code4.17" class="line"><a href="#code4.17" aria-hidden="true"></a>
</div><div id="code4.18" class="line"><a href="#code4.18" aria-hidden="true"></a><span class="go">Please answer the following questions so this script can generate the files</span>
</div><div id="code4.19" class="line"><a href="#code4.19" aria-hidden="true"></a><span class="go">needed by Pelican.</span>
</div><div id="code4.20" class="line"><a href="#code4.20" aria-hidden="true"></a>
</div><div id="code4.21" class="line"><a href="#code4.21" aria-hidden="true"></a>
</div><div id="code4.22" class="line"><a href="#code4.22" aria-hidden="true"></a><span class="go">&gt; Where do you want to create your new web site? [.] </span>
</div><div id="code4.23" class="line"><a href="#code4.23" aria-hidden="true"></a><span class="go">&gt; What will be the title of this web site? My Awesome Blog</span>
</div><div id="code4.24" class="line"><a href="#code4.24" aria-hidden="true"></a><span class="go">&gt; Who will be the author of this web site? Joe Happy</span>
</div><div id="code4.25" class="line"><a href="#code4.25" aria-hidden="true"></a><span class="go">&gt; What will be the default language of this web site? [en] </span>
</div><div id="code4.26" class="line"><a href="#code4.26" aria-hidden="true"></a><span class="go">&gt; Do you want to specify a URL prefix? e.g., https://example.com   (Y/n) n</span>
</div><div id="code4.27" class="line"><a href="#code4.27" aria-hidden="true"></a><span class="go">&gt; Do you want to enable article pagination? (Y/n) </span>
</div><div id="code4.28" class="line"><a href="#code4.28" aria-hidden="true"></a><span class="go">&gt; How many articles per page do you want? [10] </span>
</div><div id="code4.29" class="line"><a href="#code4.29" aria-hidden="true"></a><span class="go">&gt; What is your time zone? [Europe/Paris] Australia/Melbourne</span>
</div><div id="code4.30" class="line"><a href="#code4.30" aria-hidden="true"></a><span class="go">&gt; Do you want to generate a tasks.py/Makefile to automate generation and publishing? (Y/n) n</span>
</div><div id="code4.31" class="line"><a href="#code4.31" aria-hidden="true"></a><span class="go">Done. Your new project is available at /home/user/blog</span>
</div><div id="code4.32" class="line"><a href="#code4.32" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>ls<span class="w"> </span>-l
</div><div id="code4.33" class="line"><a href="#code4.33" aria-hidden="true"></a><span class="go">total 16</span>
</div><div id="code4.34" class="line"><a href="#code4.34" aria-hidden="true"></a><span class="go">drwxr-xr-x 2   user   user 4096 May 10 00:31 content</span>
</div><div id="code4.35" class="line"><a href="#code4.35" aria-hidden="true"></a><span class="go">drwxr-xr-x 2   user   user 4096 May 10 00:31 output</span>
</div><div id="code4.36" class="line"><a href="#code4.36" aria-hidden="true"></a><span class="go">-rw-r--r-- 1   user   user  869 May 10 00:31 pelicanconf.py</span>
</div><div id="code4.37" class="line"><a href="#code4.37" aria-hidden="true"></a><span class="go">-rw-r--r-- 1   user   user  589 May 10 00:31 publishconf.py</span>
</div><div id="code4.38" class="line"><a href="#code4.38" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>rm<span class="w"> </span>-rf<span class="w"> </span>output<span class="w"> </span>publishconf.py
</div><div id="code4.39" class="line"><a href="#code4.39" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>content<span class="w"> </span>pelicanconf.py<span class="w"> </span>
</div><div id="code4.40" class="line"><a href="#code4.40" aria-hidden="true"></a><span class="gp gp-VirtualEnv">(pelican)</span> <span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s1">&#39;Initial commit&#39;</span>
</div><div id="code4.41" class="line"><a href="#code4.41" aria-hidden="true"></a><span class="go">[master (root-commit) f077002] Initial commit</span>
</div><div id="code4.42" class="line"><a href="#code4.42" aria-hidden="true"></a><span class="go"> 1 file changed, 35 insertions(+)</span>
</div><div id="code4.43" class="line"><a href="#code4.43" aria-hidden="true"></a><span class="go"> create mode 100644 pelicanconf.py</span></div></code></pre>
<p>A short break down of the above session snippet is:</p>
<ul>
<li>On line 1 we create a virtual Python environment, so we could install Pelican locally;</li>
<li>We enter the newly created virtual environment on line 2, which makes Pelican available to us;</li>
<li>We create an empty repository (<code>~/blog</code>) and initialise it using Pelican&rsquo;s quickstart;</li>
<li>Since we are not using the default publishing capabilities and we are not interested in storing the generated pages in our code repository, we clean things up a bit;</li>
<li>Finally, we commit the generated skeleton to Git.</li>
</ul>
<p>A good test at this stage would be to ensure that Pelican is working and likes our structure:</p>
<pre id="code5" class="highlight" data-user="user"><input type="radio" name="code_menu8a566a24f2ca636cc191c159bc82a32404f4e709" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu8a566a24f2ca636cc191c159bc82a32404f4e709" class="line-numbers icon list-numbered"><code class="language-console"><div id="code5.1" class="line"><a href="#code5.1" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>pelican
</div><div id="code5.2" class="line"><a href="#code5.2" aria-hidden="true"></a><span class="go">WARNING: No valid files found in content for the active readers:</span>
</div><div id="code5.3" class="line"><a href="#code5.3" aria-hidden="true"></a><span class="go">  | BaseReader (static)</span>
</div><div id="code5.4" class="line"><a href="#code5.4" aria-hidden="true"></a><span class="go">  | HTMLReader (htm, html)</span>
</div><div id="code5.5" class="line"><a href="#code5.5" aria-hidden="true"></a><span class="go">  | MarkdownReader (md, markdown, mkd, mdown)</span>
</div><div id="code5.6" class="line"><a href="#code5.6" aria-hidden="true"></a><span class="go">  | RstReader (rst)</span>
</div><div id="code5.7" class="line"><a href="#code5.7" aria-hidden="true"></a><span class="go">Done: Processed 0 articles, 0 drafts, 0 pages, 0 hidden pages and 0 draft pages in 0.07 seconds.</span></div></code></pre>
<p>So far so good, but it is not a real test, since there are no source files to generate something from, so let&rsquo;s give Pelican something to work on:</p>
<pre id="code6" class="highlight" data-user="user"><input type="radio" name="code_menuc0b5ea6abd49d4192e82ca1f3af9008e430a5c61" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menuc0b5ea6abd49d4192e82ca1f3af9008e430a5c61" class="line-numbers icon list-numbered"><code class="language-console"><div id="code6.1" class="line"><a href="#code6.1" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span><span class="nb">printf</span><span class="w"> </span><span class="s1">&#39;Title: First Post\nDate: 2020-05-10\n\n#First post\nPelican is awesome!&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>content/first.md
</div><div id="code6.2" class="line"><a href="#code6.2" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>pelican
</div><div id="code6.3" class="line"><a href="#code6.3" aria-hidden="true"></a><span class="go">Done: Processed 1 article, 0 drafts, 0 pages, 0 hidden pages and 0 draft pages in 0.12 seconds.</span>
</div><div id="code6.4" class="line"><a href="#code6.4" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>elinks<span class="w"> </span>-dump<span class="w"> </span>output/index.html<span class="w"> </span>
</div><div id="code6.5" class="line"><a href="#code6.5" aria-hidden="true"></a><span class="go">                               [1]My Awesome Blog</span>
</div><div id="code6.6" class="line"><a href="#code6.6" aria-hidden="true"></a>
</div><div id="code6.7" class="line"><a href="#code6.7" aria-hidden="true"></a><span class="go">     • [2]misc</span>
</div><div id="code6.8" class="line"><a href="#code6.8" aria-hidden="true"></a>
</div><div id="code6.9" class="line"><a href="#code6.9" aria-hidden="true"></a><span class="go">                                 [3]First Post</span>
</div><div id="code6.10" class="line"><a href="#code6.10" aria-hidden="true"></a>
</div><div id="code6.11" class="line"><a href="#code6.11" aria-hidden="true"></a><span class="go">   Published: Sun 10 May 2020</span>
</div><div id="code6.12" class="line"><a href="#code6.12" aria-hidden="true"></a>
</div><div id="code6.13" class="line"><a href="#code6.13" aria-hidden="true"></a><span class="go">    By [4]Joe Happy</span>
</div><div id="code6.14" class="line"><a href="#code6.14" aria-hidden="true"></a>
</div><div id="code6.15" class="line"><a href="#code6.15" aria-hidden="true"></a><span class="go">   In [5]misc.</span>
</div><div id="code6.16" class="line"><a href="#code6.16" aria-hidden="true"></a>
</div><div id="code6.17" class="line"><a href="#code6.17" aria-hidden="true"></a><span class="go">                                   First post</span>
</div><div id="code6.18" class="line"><a href="#code6.18" aria-hidden="true"></a>
</div><div id="code6.19" class="line"><a href="#code6.19" aria-hidden="true"></a><span class="go">   Pelican is awesome!</span></div></code></pre>
<p>The output from <code>elinks</code> was truncated on purpose since I just wanted to
showcase that Pelican has indeed generated the structure for a static website
from just one article file we created.</p>
<p>Before we push our local repository to GitHub we may want to do some house
keeping first, e.g. create the <code>.gitignore</code> file and list the temporary
things we do not want Git to track.  A good enough version of the <code>.gitignore</code>
file I am using for my code repository is the following:</p>
<pre id="code7" class="highlight"><input type="radio" name="code_menu7f4cf7b3cc8f2931067f3492b670d7935d5d410b" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu7f4cf7b3cc8f2931067f3492b670d7935d5d410b" class="line-numbers icon list-numbered"><code class="language-txt" data-file=".gitignore"><div id="code7.1" class="line"><a href="#code7.1" aria-hidden="true"></a>*~
</div><div id="code7.2" class="line"><a href="#code7.2" aria-hidden="true"></a><span class="gs">*.pyc</span>
</div><div id="code7.3" class="line"><a href="#code7.3" aria-hidden="true"></a><span class="gs">.*</span>.swp
</div><div id="code7.4" class="line"><a href="#code7.4" aria-hidden="true"></a>
</div><div id="code7.5" class="line"><a href="#code7.5" aria-hidden="true"></a>**/__pycache__
</div><div id="code7.6" class="line"><a href="#code7.6" aria-hidden="true"></a>
</div><div id="code7.7" class="line"><a href="#code7.7" aria-hidden="true"></a>/output</div></code></pre>
<p>Do not forget to actually commit that <code>.gitignore</code> file to your local
repository using the <code>git add .gitignore &amp;&amp; git commit -m 'Added .gitignore'</code>,
by the way.</p>
<p>Now, we need to create a private repository on GitHub, so jump into your
browser, go to your GitHub account, press the &ldquo;+&rdquo; icon in the upper right
corner (right next to your profile icon), and select &ldquo;New repository&rdquo;.</p>
<p>On the &ldquo;Create repository&rdquo; page put whatever you desire as the name and the
description of the repository you are about to create.  Ensure that the
&ldquo;Private&rdquo; radio button is selected and uncheck the &ldquo;Initialize this repository
with a README&rdquo; if it was checked.</p>
<p>Once the repository is created, you will be presented with a page that
enumerates your options for the next step, but I will just go ahead and show a
session dump of what you will need to do.  In the following session snippet
<code>blog</code> is the repository name I chose for my private code repository and you
will need to replace it with your private repository name (the working
directory is our newly created local repository):</p>
<pre id="code8" class="highlight" data-user="user"><input type="radio" name="code_menu7b580f92d15ee786ed72ac7b08c50a0d61b38d6f" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu7b580f92d15ee786ed72ac7b08c50a0d61b38d6f" class="line-numbers icon list-numbered"><code class="language-console"><div id="code8.1" class="line"><a href="#code8.1" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>git<span class="w"> </span>remote<span class="w"> </span>add<span class="w"> </span>origin<span class="w"> </span>git@github.com:galaxy4public/blog.git
</div><div id="code8.2" class="line"><a href="#code8.2" aria-hidden="true"></a><span class="gp">[user@localhost ~]$ </span>git<span class="w"> </span>push<span class="w"> </span>-u<span class="w"> </span>origin<span class="w"> </span>master
</div><div id="code8.3" class="line"><a href="#code8.3" aria-hidden="true"></a><span class="go">Enter passphrase for key &#39;/home/user/.ssh/keys/github&#39;: </span>
</div><div id="code8.4" class="line"><a href="#code8.4" aria-hidden="true"></a><span class="go">Enumerating objects: 6, done.</span>
</div><div id="code8.5" class="line"><a href="#code8.5" aria-hidden="true"></a><span class="go">Counting objects: 100% (6/6), done.</span>
</div><div id="code8.6" class="line"><a href="#code8.6" aria-hidden="true"></a><span class="go">Delta compression using up to 4 threads</span>
</div><div id="code8.7" class="line"><a href="#code8.7" aria-hidden="true"></a><span class="go">Compressing objects: 100% (4/4), done.</span>
</div><div id="code8.8" class="line"><a href="#code8.8" aria-hidden="true"></a><span class="go">Writing objects: 100% (6/6), 1008 bytes | 1008.00 KiB/s, done.</span>
</div><div id="code8.9" class="line"><a href="#code8.9" aria-hidden="true"></a><span class="go">Total 6 (delta 0), reused 0 (delta 0), pack-reused 0</span>
</div><div id="code8.10" class="line"><a href="#code8.10" aria-hidden="true"></a><span class="go">To github.com:galaxy4public/blog.git</span>
</div><div id="code8.11" class="line"><a href="#code8.11" aria-hidden="true"></a><span class="go"> * [new branch]      master -&gt; master</span>
</div><div id="code8.12" class="line"><a href="#code8.12" aria-hidden="true"></a><span class="go">Branch &#39;master&#39; set up to track remote branch &#39;master&#39; from &#39;origin&#39;.</span></div></code></pre>
<p>Do you remember how we generated a deploy key pair earlier and installed the
public key part into the public blog repository, so GitHub would allow the
bearer of the private key to authenticate and deploy changes to the public blog
repository?  Well, since the purpose of this article is to introduce the full
automation, the bearer of the key would be the GitHub Action associated with
the private repository, hence we need to provide the action with the private
key somehow.</p>
<p>GitHub has a feature called &ldquo;repository secrets&rdquo; and it is a perfect candidate
to pass the private key to the GitHub Action.  We need to follow the <a href="https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets#creating-encrypted-secrets-for-a-repository">official
documentation for the feature</a> and create a secret called &ldquo;DEPLOY_KEY&rdquo; with the
content of the private part of the deploy key.  This will be used in the last step
of the GitHub Action we are about to define.</p>
<h2 id="configuring-the-github-action-for-publishing">Configuring the GitHub Action for publishing</h2>
<p>Everything is well and good, but &ldquo;where is the automation?&rdquo; you may ask.  After
all, I suspect this was the primary reason you are reading this post.  Well, we
are about to start to look into the automation part and it is rather short in
comparison to all the steps we did to set repositories up.</p>
<p>Our automation relies on the GitHub Action feature of GitHub.  In plain terms,
GitHub Action is a free compute resource provided by GitHub (there are some
limits, but for the purposes of a personal blog it is unlikely that you will
ever hit these limits).</p>
<p>Each GitHub Action is associated with a specific repository and is defined
using quite a simple <abbr title="YAML Ain't Markup Language">YAML</abbr> configuration file which instructs GitHub on how to
provision a required compute environment and what to run inside that
environment.  The <abbr title="YAML Ain't Markup Language">YAML</abbr> file can be arbitrarily named and resides in the
<code>.github/workflows/</code> subdirectory (starting from the root of the corresponding
repository).</p>
<p>The GitHub Action I am using for my blog web site is stored in
<code>.github/workflows/pelican.yml</code> and contains the following (we will dissect it
further down the post):</p>
<pre id="code9" class="highlight"><input type="radio" name="code_menu606d183290ef7658eed278296fc46835e3446c0f" class="no-line-numbers icon list-numbered"><input type="radio" name="code_menu606d183290ef7658eed278296fc46835e3446c0f" class="line-numbers icon list-numbered"><code class="language-yaml" data-file=".github/workflows/pelican.yml"><div id="code9.1" class="line"><a href="#code9.1" aria-hidden="true"></a><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Static Website Generator</span>
</div><div id="code9.2" class="line"><a href="#code9.2" aria-hidden="true"></a>
</div><div id="code9.3" class="line"><a href="#code9.3" aria-hidden="true"></a><span class="nt">on</span><span class="p">:</span>
</div><div id="code9.4" class="line"><a href="#code9.4" aria-hidden="true"></a><span class="w">  </span><span class="nt">push</span><span class="p">:</span>
</div><div id="code9.5" class="line"><a href="#code9.5" aria-hidden="true"></a><span class="w">    </span><span class="nt">branches</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="nv">master</span><span class="w"> </span><span class="p p-Indicator">]</span>
</div><div id="code9.6" class="line"><a href="#code9.6" aria-hidden="true"></a>
</div><div id="code9.7" class="line"><a href="#code9.7" aria-hidden="true"></a><span class="nt">env</span><span class="p">:</span>
</div><div id="code9.8" class="line"><a href="#code9.8" aria-hidden="true"></a><span class="w">  </span><span class="nt">LANG</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">en_AU.UTF-8</span>
</div><div id="code9.9" class="line"><a href="#code9.9" aria-hidden="true"></a>
</div><div id="code9.10" class="line"><a href="#code9.10" aria-hidden="true"></a><span class="nt">jobs</span><span class="p">:</span>
</div><div id="code9.11" class="line"><a href="#code9.11" aria-hidden="true"></a><span class="w">  </span><span class="nt">build</span><span class="p">:</span>
</div><div id="code9.12" class="line"><a href="#code9.12" aria-hidden="true"></a>
</div><div id="code9.13" class="line"><a href="#code9.13" aria-hidden="true"></a><span class="w">    </span><span class="nt">runs-on</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-latest</span>
</div><div id="code9.14" class="line"><a href="#code9.14" aria-hidden="true"></a>
</div><div id="code9.15" class="line"><a href="#code9.15" aria-hidden="true"></a><span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
</div><div id="code9.16" class="line"><a href="#code9.16" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialise locale</span>
</div><div id="code9.17" class="line"><a href="#code9.17" aria-hidden="true"></a><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</div><div id="code9.18" class="line"><a href="#code9.18" aria-hidden="true"></a><span class="w">        </span><span class="no">if [ &quot;$LANG&quot; != &#39;C&#39; -a &quot;{$LANG:0:2}&quot; != &#39;C.&#39; ]; then</span>
</div><div id="code9.19" class="line"><a href="#code9.19" aria-hidden="true"></a><span class="w">          </span><span class="no">CP=&quot;${LANG#*.}&quot; &amp;&amp; [ -z &quot;$CP&quot; ] &amp;&amp; CP=UTF-8 ||:</span>
</div><div id="code9.20" class="line"><a href="#code9.20" aria-hidden="true"></a><span class="w">          </span><span class="no">sudo sed -i -E &quot;/^\s*$LANG(\s|\$)/{:a;n;ba;q};\$a$LANG $CP&quot; /etc/locale.gen</span>
</div><div id="code9.21" class="line"><a href="#code9.21" aria-hidden="true"></a><span class="w">          </span><span class="no">sudo locale-gen</span>
</div><div id="code9.22" class="line"><a href="#code9.22" aria-hidden="true"></a><span class="w">          </span><span class="no">sudo localectl set-locale LANG=&quot;${LANG:-C.UTF-8}&quot;</span>
</div><div id="code9.23" class="line"><a href="#code9.23" aria-hidden="true"></a><span class="w">        </span><span class="no">fi</span>
</div><div id="code9.24" class="line"><a href="#code9.24" aria-hidden="true"></a><span class="w">        </span><span class="no">locale -a</span>
</div><div id="code9.25" class="line"><a href="#code9.25" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout the primary repo</span>
</div><div id="code9.26" class="line"><a href="#code9.26" aria-hidden="true"></a><span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
</div><div id="code9.27" class="line"><a href="#code9.27" aria-hidden="true"></a><span class="w">      </span><span class="nt">with</span><span class="p">:</span>
</div><div id="code9.28" class="line"><a href="#code9.28" aria-hidden="true"></a><span class="w">        </span><span class="nt">fetch-depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</div><div id="code9.29" class="line"><a href="#code9.29" aria-hidden="true"></a><span class="w">        </span><span class="nt">submodules</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">recursive</span>
</div><div id="code9.30" class="line"><a href="#code9.30" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Restore modification times for content</span>
</div><div id="code9.31" class="line"><a href="#code9.31" aria-hidden="true"></a><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</div><div id="code9.32" class="line"><a href="#code9.32" aria-hidden="true"></a><span class="w">        </span><span class="no">git log --pretty=tformat:&quot;%at&quot; --name-status --no-merges -- \</span>
</div><div id="code9.33" class="line"><a href="#code9.33" aria-hidden="true"></a><span class="w">            </span><span class="no">content \</span>
</div><div id="code9.34" class="line"><a href="#code9.34" aria-hidden="true"></a><span class="w">            </span><span class="no">themes/mind-drops/content \</span>
</div><div id="code9.35" class="line"><a href="#code9.35" aria-hidden="true"></a><span class="w">        </span><span class="no">| sed -nE &#39;</span>
</div><div id="code9.36" class="line"><a href="#code9.36" aria-hidden="true"></a><span class="w">            </span><span class="no">/^\s*$/d;/^[[:digit:]]+$/{h;d};</span>
</div><div id="code9.37" class="line"><a href="#code9.37" aria-hidden="true"></a><span class="w">            </span><span class="no">/^[UXB]/d;</span>
</div><div id="code9.38" class="line"><a href="#code9.38" aria-hidden="true"></a><span class="w">            </span><span class="no">/^[AMT]/{s,^\S\s+,,;G;s,^(.+)\n(.+),\2 \1,;p};</span>
</div><div id="code9.39" class="line"><a href="#code9.39" aria-hidden="true"></a><span class="w">            </span><span class="no">/^[DR]/{</span>
</div><div id="code9.40" class="line"><a href="#code9.40" aria-hidden="true"></a><span class="w">              </span><span class="no">s,^(D|[CR][[:digit:]]+)\s+,\1 ,;G;</span>
</div><div id="code9.41" class="line"><a href="#code9.41" aria-hidden="true"></a><span class="w">              </span><span class="no">s,^(\S+) ([^[=\t=]]+[[=\t=]])?(.*)\n(.+),\4\1 \3,;</span>
</div><div id="code9.42" class="line"><a href="#code9.42" aria-hidden="true"></a><span class="w">              </span><span class="no">p</span>
</div><div id="code9.43" class="line"><a href="#code9.43" aria-hidden="true"></a><span class="w">            </span><span class="no">}&#39; \</span>
</div><div id="code9.44" class="line"><a href="#code9.44" aria-hidden="true"></a><span class="w">        </span><span class="no">| LC_ALL=C sort -k2 -k1rn | uniq -f1 \</span>
</div><div id="code9.45" class="line"><a href="#code9.45" aria-hidden="true"></a><span class="w">        </span><span class="no">| sed -E &#39;/^[[:digit:]]+D /d&#39; \</span>
</div><div id="code9.46" class="line"><a href="#code9.46" aria-hidden="true"></a><span class="w">        </span><span class="no">| while read TSTAMP FILE; do</span>
</div><div id="code9.47" class="line"><a href="#code9.47" aria-hidden="true"></a><span class="w">            </span><span class="no">if [ -f &quot;$FILE&quot; ]; then</span>
</div><div id="code9.48" class="line"><a href="#code9.48" aria-hidden="true"></a><span class="w">                </span><span class="no">echo &quot;$FILE =&gt; $(date -d @$TSTAMP)&quot;</span>
</div><div id="code9.49" class="line"><a href="#code9.49" aria-hidden="true"></a><span class="w">                </span><span class="no">touch -m -d &quot;@$TSTAMP&quot; -- &quot;$FILE&quot;</span>
</div><div id="code9.50" class="line"><a href="#code9.50" aria-hidden="true"></a><span class="w">            </span><span class="no">fi</span>
</div><div id="code9.51" class="line"><a href="#code9.51" aria-hidden="true"></a><span class="w">        </span><span class="no">done</span>
</div><div id="code9.52" class="line"><a href="#code9.52" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Checkout Pages repo</span>
</div><div id="code9.53" class="line"><a href="#code9.53" aria-hidden="true"></a><span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/checkout@v2</span>
</div><div id="code9.54" class="line"><a href="#code9.54" aria-hidden="true"></a><span class="w">      </span><span class="nt">with</span><span class="p">:</span>
</div><div id="code9.55" class="line"><a href="#code9.55" aria-hidden="true"></a><span class="w">        </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">galaxy4public/galaxy4public.github.io</span>
</div><div id="code9.56" class="line"><a href="#code9.56" aria-hidden="true"></a><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
</div><div id="code9.57" class="line"><a href="#code9.57" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set up Python</span>
</div><div id="code9.58" class="line"><a href="#code9.58" aria-hidden="true"></a><span class="w">      </span><span class="nt">uses</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">actions/setup-python@v2</span>
</div><div id="code9.59" class="line"><a href="#code9.59" aria-hidden="true"></a><span class="w">      </span><span class="nt">with</span><span class="p">:</span>
</div><div id="code9.60" class="line"><a href="#code9.60" aria-hidden="true"></a><span class="w">        </span><span class="nt">python-version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.x</span>
</div><div id="code9.61" class="line"><a href="#code9.61" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install dependencies</span>
</div><div id="code9.62" class="line"><a href="#code9.62" aria-hidden="true"></a><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</div><div id="code9.63" class="line"><a href="#code9.63" aria-hidden="true"></a><span class="w">        </span><span class="no">python -m pip install --upgrade pip</span>
</div><div id="code9.64" class="line"><a href="#code9.64" aria-hidden="true"></a><span class="w">        </span><span class="no">pip install -r requirements.txt</span>
</div><div id="code9.65" class="line"><a href="#code9.65" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Generate the website</span>
</div><div id="code9.66" class="line"><a href="#code9.66" aria-hidden="true"></a><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</div><div id="code9.67" class="line"><a href="#code9.67" aria-hidden="true"></a><span class="w">        </span><span class="no">ls -laR content/</span>
</div><div id="code9.68" class="line"><a href="#code9.68" aria-hidden="true"></a><span class="w">        </span><span class="no">rm -rf output/*</span>
</div><div id="code9.69" class="line"><a href="#code9.69" aria-hidden="true"></a><span class="w">        </span><span class="no">ls -la output/</span>
</div><div id="code9.70" class="line"><a href="#code9.70" aria-hidden="true"></a><span class="w">        </span><span class="no">TIMEZONE=$(sed -nE &#39;s|^\s*TIMEZONE\s*=\s*[&#39;&quot;&#39;&quot;&#39;&quot;]([^&#39;&quot;&#39;&quot;&#39;&quot;]+)[&#39;&quot;&#39;&quot;&#39;&quot;].*|\1|;T;p&#39; pelicanconf.py)</span>
</div><div id="code9.71" class="line"><a href="#code9.71" aria-hidden="true"></a><span class="w">        </span><span class="no">TZ=&quot;${TIMEZONE:-UTC}&quot; pelican</span>
</div><div id="code9.72" class="line"><a href="#code9.72" aria-hidden="true"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Publish to GitHub Pages</span>
</div><div id="code9.73" class="line"><a href="#code9.73" aria-hidden="true"></a><span class="w">      </span><span class="nt">env</span><span class="p">:</span>
</div><div id="code9.74" class="line"><a href="#code9.74" aria-hidden="true"></a><span class="w">        </span><span class="nt">DEPLOY_KEY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${{ secrets.DEPLOY_KEY }}</span>
</div><div id="code9.75" class="line"><a href="#code9.75" aria-hidden="true"></a><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</div><div id="code9.76" class="line"><a href="#code9.76" aria-hidden="true"></a><span class="w">        </span><span class="no">cd output</span>
</div><div id="code9.77" class="line"><a href="#code9.77" aria-hidden="true"></a><span class="w">        </span><span class="no">git config --local user.email &quot;action@github.com&quot;</span>
</div><div id="code9.78" class="line"><a href="#code9.78" aria-hidden="true"></a><span class="w">        </span><span class="no">git config --local user.name &quot;GitHub Action&quot;</span>
</div><div id="code9.79" class="line"><a href="#code9.79" aria-hidden="true"></a><span class="w">        </span><span class="no">if output=$(git status --porcelain) &amp;&amp; [ -z &quot;$output&quot; ]; then</span>
</div><div id="code9.80" class="line"><a href="#code9.80" aria-hidden="true"></a><span class="w">          </span><span class="no">echo &quot;No new content was generated, exiting gracefully&quot;</span>
</div><div id="code9.81" class="line"><a href="#code9.81" aria-hidden="true"></a><span class="w">        </span><span class="no">else </span>
</div><div id="code9.82" class="line"><a href="#code9.82" aria-hidden="true"></a><span class="w">          </span><span class="no">git add -A</span>
</div><div id="code9.83" class="line"><a href="#code9.83" aria-hidden="true"></a><span class="w">          </span><span class="no">git commit -m &quot;Updated content on $(date)&quot;</span>
</div><div id="code9.84" class="line"><a href="#code9.84" aria-hidden="true"></a><span class="w">          </span><span class="no">eval $(ssh-agent)</span>
</div><div id="code9.85" class="line"><a href="#code9.85" aria-hidden="true"></a><span class="w">          </span><span class="no">echo &quot;$DEPLOY_KEY&quot; | ssh-add -t 5m /dev/stdin</span>
</div><div id="code9.86" class="line"><a href="#code9.86" aria-hidden="true"></a><span class="w">          </span><span class="no">ssh-add -l</span>
</div><div id="code9.87" class="line"><a href="#code9.87" aria-hidden="true"></a><span class="w">          </span><span class="no">git push git@github.com:galaxy4public/galaxy4public.github.io.git</span>
</div><div id="code9.88" class="line"><a href="#code9.88" aria-hidden="true"></a><span class="w">          </span><span class="no">ssh-add -D</span>
</div><div id="code9.89" class="line"><a href="#code9.89" aria-hidden="true"></a><span class="w">          </span><span class="no">ssh-agent -k</span>
</div><div id="code9.90" class="line"><a href="#code9.90" aria-hidden="true"></a><span class="w">        </span><span class="no">fi</span>
</div><div id="code9.91" class="line"><a href="#code9.91" aria-hidden="true"></a><span class="w">        </span><span class="no">cd ..</span>
</div><div id="code9.92" class="line"><a href="#code9.92" aria-hidden="true"></a><span class="w">        </span><span class="no">echo Completed</span></div></code></pre>
<p>This is a copy of my live GitHub Action for deploying my blog that you are most
likely reading right now and I decided not to edit anything, so if you just
want to re-use it you will need to replace a few things, namely:</p>
<ul>
<li><code>en_AU.UTF-8</code> =&gt; to a locale you are using (you can run <code>locale -a</code> if you
    are running Linux to see the list of locales available on your system);</li>
<li><code>content</code> =&gt; you may need to change that to the name of your content
    directory (if you did not use the default name);</li>
<li><code>themes/mind-drops/content</code> =&gt; you will need to drop this line since it is
    my theme&rsquo;s content directory and you would not have it;</li>
<li><code>galaxy4public/galaxy4public.github.io</code> =&gt; to <strong>&lt;your_username/your_blog_repo_name&gt;</strong>, obviously :)</li>
</ul>
<p>Let&rsquo;s look a bit more closely to understand how this GitHub Action is
structured and what each step is doing.</p>
<p>It all starts with the definition of the action itself, the conditions of
how it is triggered, and how it runs: you can get a formal description of
the <abbr title="YAML Ain't Markup Language">YAML</abbr> structure of this configuration file in the official GitHub
documentation on <a href="https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions">Workflows</a>.</p>
<p>Here, we are only going to focus on steps defined under the &ldquo;jobs:&rdquo; section of
the file since these steps are defining the logic we are after.</p>
<p>The &ldquo;Initialise locale&rdquo; step is quite important for Pelican since with a
misconfigured locale Pelican tends to produce incorrect output (which is kind
of expected).  So in this step we are trying to determine whether the user (us
:) ) has supplied the <code>LANG</code> variable and if they did we update
<code>/etc/locale.gen</code> file, run the <code>locale-gen</code> command to update the
corresponding files, and set the locale of the container to the
requested locale.</p>
<p>The &ldquo;Checkout the primary repo&rdquo; step is leveraging the official &ldquo;Checkout V2&rdquo;
Action and checks out a full copy of the source code repository of our blog
and all the linked submodules.  Initially, I was using a shallow copy using
<code>fetch-depth: 1</code>, but the next step was requiring the full repository history
to do its job reliably and I changed it to be a full history clone.</p>
<p>Since <code>git</code> <a href="https://git.wiki.kernel.org/index.php/GitFaq#Why_isn.27t_Git_preserving_modification_time_on_files.3F">does not store timestamps</a> for the files and directories under its
control, yet Pelican relies on timestamps to populate the modification time of
the artefacts &ndash; we need to find a way to reconstruct at least file timestamps
after the tree was checked out.  One of the possible approaches would be to
create a plugin that could determine whether we are inside a <code>git</code> working tree
or not and depending on that apply different timestamp extraction policies, but
I thought that a much easier way would be to prepare the checked out tree,
hence making it compatible with the way Pelican expects things to be.</p>
<p>The &ldquo;Restore modification times for content&rdquo; step is my variant of how one
could reconstruct the timestamps for files close enough to make it possible to
use with Pelican.  The approach relies on the fact that <code>git</code> records the
timestamp of each commit including adding, updating, and deleting files.  We
create a list of all these file events using <code>git log</code> for file trees under
&ldquo;content&rdquo; (where our blog content lives) and &ldquo;themes/mind-drops/content&rdquo; (where
my custom theme injects some content such as the Web service worker script),
then we use <code>sed</code> to filter and to re-arrange the output a bit, followed by
reverse sorting to help to remove the entries that were introduced and later
deleted.  In the end, we have a list of file names with timestamps, so we go
through the list in a loop and set the timestamps to files using <code>touch</code>.</p>
<p>The &ldquo;Checkout Pages repo&rdquo; step is cloning the public blog repository into the
&ldquo;output&rdquo; directory where Pelican will put the generated files.  This is needed
to ensure that we can track the changes to the public repository, since Pelican
is careful enough (if not instructed otherwise) only to update the files it
generates and leave everything else in place as is.  We use this later to
determine whether any new content has been generated or not.</p>
<p>The &ldquo;Set up Python&rdquo; and the &ldquo;Install dependencies&rdquo; steps are pretty generic:
the former is using the official GitHub Action to install and configure the
latest available version of Python 3.x and the latter is leveraging <code>pip</code> to
install all blog&rsquo;s dependencies (including Pelican itself).</p>
<p>The &ldquo;Generate the website&rdquo; step is running <code>pelican</code> to process our articles
and pages and to generate the result in the &ldquo;output&rdquo; directory.  There are a
couple of tricks with this step, though.</p>
<p>The first trick, which is not that obvious, is that we are removing the content
of the &ldquo;output&rdquo; directory.  It seems a bit weird since we just checked it out
several steps before, does not it?  Well, we are removing everything <strong>except</strong>
hidden files and directories which happen to contain the &ldquo;.git&rdquo; subdirectory
with all the actual data about the repository.  Why do we do it?  It is simple,
this helps us to determine a situation if some file or directory was removed,
so we could propagate that knowledge to the public blog repository.  If we did
not clean up the content of the &ldquo;output&rdquo; directory we would only append new
changes and would never remove anything &ndash; this is how it was before I stumbled
upon the problem, by the way. :)</p>
<p>The second trick of the &ldquo;Generate the website&rdquo; step is the extraction of the
time zone information from the configuration files and is setting the <code>TZ</code>
variable correctly just before we call <code>pelican</code>.  Without this either Pelican
may fail or if it does not it will produce <abbr title="Coordinated Universal Time">UTC</abbr> based date and times, which
would be undesirable (at least for me, since my time zone is in Australia).</p>
<p>The final step is to push the updated content to the public blog repository,
which will make it visible via GitHub Pages.  Several things to notice there
are:</p>
<ol>
<li>In the <code>env:</code> section we are setting up the <code>DEPLOY_KEY</code> variable &ndash; this
     syntax is used to retrieve a named secret value from the associated secret
     key for a repository.  We store the private part of the deploy key we
     specifically generated for this purpose at the beginning of this article
     in the private repository secret.</li>
<li><code>git status</code> is used to determine whether there are any changes between
     what we have in the working tree and the repository index.  If no changes
     were detected we just exit gracefully.</li>
<li>If any change to the generated content was detected, we temporarily load
     the private part of the deploy key into the <code>ssh-agent</code> (for 5 minutes),
     push changes to the public blog repository, then clean up the key from
     the agent and kill the agent itself.</li>
</ol>
<p>From this point on, any push to the private codebase repository will trigger
the GitHub Action and if the change has resulted in any updated content such
content will be published to GitHub Pages!</p>
<p>There are quite a few things we could improve: such as introducing a broken
links check, doing some sanity checks, etc. &ndash; but this would be for another
article, I guess. :)</p>
				<footer>
					<span><span class="contextual">Offloaded on </span><time datetime="2020-05-17T21:32:00+10:00">
						<span class="month"><a href="/2020/05/" title="A link to the archives for May of 2020">May<span class="month full"></span></a></span>
						<span class="day">17</span>
						<span class="year"><a href="/2020/" title="A link to the archives for the year of 2020">2020</a></span>
					</time></span>
						<span class="contextual">into </span><span class="category"><a href="/category/blog/" title="A link to a collection of articles in the 'blog' category">blog</a></span>
					<span class="contextual">and tagged with:</span>
					<ul class="tags">
						<li class="tag">
							<span>
								<a href="/tag/pelican/" rel="tag" title="A link to the collection tagged with 'pelican'" data-count="2" ><span>pelican</span></a>
							</span>
						</li>
						<li class="tag">
							<span>
								<a href="/tag/blog/" rel="tag" title="A link to the collection tagged with 'blog'" data-count="2" ><span>blog</span></a>
							</span>
						</li>
						<li class="tag">
							<span>
								<a href="/tag/github/" rel="tag" title="A link to the collection tagged with 'github'" data-count="1" ><span>github</span></a>
							</span>
						</li>
						</ul>
				</footer>
			</article>
		<footer>
		</footer>
	</main>
	<footer>
	</footer>
	<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "f80f2e7159db484087eabffc4719e0cd"}' />
	<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "4c47621129eb46dea5f11b57a5c41a70"}' />
</body>
</html>