<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Mind Drops</title><link href="https://dmitry.khlebnikov.net/" rel="alternate"></link><link href="https://dmitry.khlebnikov.net/feeds/all-en.atom.xml" rel="self"></link><id>https://dmitry.khlebnikov.net/</id><updated>2020-05-17T22:13:06+10:00</updated><entry><title>Automating Static Website Deployment</title><link href="https://dmitry.khlebnikov.net/2020/05/17/automating-static-website-deployment/" rel="alternate"></link><published>2020-05-17T21:32:00+10:00</published><updated>2020-05-17T22:13:06+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2020-05-17:/2020/05/17/automating-static-website-deployment/</id><summary type="html">&lt;div class="toc"&gt;&lt;span class="toctitle"&gt;Table of Contents&lt;/span&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#setting-up-github-pages"&gt;Setting up GitHub Pages&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#setting-up-the-private-code-repository"&gt;Setting up the private, code repository&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#configuring-the-github-action-for-publishing"&gt;Configuring the GitHub Action for publishing&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;In this post I am going to document the steps I took to implement a fully
automated deployment of my blog using GitHub Actions and GitHub Pages.&lt;/p&gt;
&lt;p&gt;As always, I started my journey with the definition of what I really wanted to
get at the end:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The website is published on GitHub pages&lt;/p&gt;
&lt;p&gt;Since the website is static and all of its content can be easily downloaded
using a web crawler (like &lt;code&gt;wget --mirror https://website.tld&lt;/code&gt;) I was OK
with &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;&lt;/li&gt;&lt;/ul&gt;</summary><content type="html">&lt;div class="toc"&gt;&lt;span class="toctitle"&gt;Table of Contents&lt;/span&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#setting-up-github-pages"&gt;Setting up GitHub Pages&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#setting-up-the-private-code-repository"&gt;Setting up the private, code repository&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#configuring-the-github-action-for-publishing"&gt;Configuring the GitHub Action for publishing&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;In this post I am going to document the steps I took to implement a fully
automated deployment of my blog using GitHub Actions and GitHub Pages.&lt;/p&gt;
&lt;p&gt;As always, I started my journey with the definition of what I really wanted to
get at the end:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;The website is published on GitHub pages&lt;/p&gt;
&lt;p&gt;Since the website is static and all of its content can be easily downloaded
using a web crawler (like &lt;code&gt;wget --mirror https://website.tld&lt;/code&gt;) I was OK
with exposing the structure in the public repository, which is what GitHub
offers on a free plan.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The code to generate the website should be private&lt;/p&gt;
&lt;p&gt;I do a lot of work on the SSG (which is Pelican in my case) itself: extend
it with plug-ins that may contain &lt;abbr title="Application Programming Interface"&gt;API&lt;/abbr&gt; tokens to reach out to some third
party &lt;span&gt;&lt;abbr title="Application Programming Interface"&gt;API&lt;/abbr&gt;&lt;/span&gt;s, hack the core code when I want to quickly test stuff, etc. &amp;ndash;
so, I really did not have any desire to publish publicly all the commotions
I did in the background (sometimes I do more than a hundred commits per day
just to experiment with different ideas I have).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There should be a valid history of changes in both repositories&lt;/p&gt;
&lt;p&gt;Well, I would get the history on my private repository for free, since it
is the core value of maintaining a repository in the &lt;abbr title="Version Control System"&gt;VCS&lt;/abbr&gt;, but I also wanted
to have clean history of changes to the content I publish publicly.&lt;/p&gt;
&lt;p&gt;It would be a pleasant bonus if the changes in the public repository could
refer back to the corresponding commit in the private repository.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;One may say that to do what I set out to do I would need to subscribe for a
paid account with GitHub since according to their &lt;a href="https://help.github.com/en/github/working-with-github-pages/getting-started-with-github-pages"&gt;help page&lt;/a&gt; GitHub Pages
for private repositories are only available on the paid plans.&lt;/p&gt;
&lt;p&gt;However, as I pointed out above, it does not make sense to hide the content of
the actual static website, hence all I needed to do is to find a way how to
&amp;ldquo;publish&amp;rdquo; the resulting artefact to the GitHub Pages repository, and,
preferably, that &amp;ldquo;publishing&amp;rdquo; should happen on GitHub&amp;rsquo;s side.&lt;/p&gt;
&lt;p&gt;Luckily for me, GitHub started to support GitHub Actions on the free plan some
time ago and as long as it is not abused according to their terms and
conditions, it is a perfect vehicle for what I am trying to do, in my opinion.&lt;/p&gt;
&lt;h2 id="setting-up-github-pages"&gt;Setting up GitHub Pages&lt;/h2&gt;
&lt;p&gt;There are multiple howtos and tutorials in the Internet on how to set GitHub
Pages up, including &lt;a href="https://help.github.com/en/github/working-with-github-pages/getting-started-with-github-pages"&gt;the official help section on this topic&lt;/a&gt;, so I will
only elaborate on details where I did something specific for the purposes of
achieving my goals.&lt;/p&gt;
&lt;p&gt;There are different types of GitHub Pages:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;user or organisation&lt;/li&gt;
&lt;li&gt;per-project&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The difference between two is subtle (the former requires a dedicated
repository for your website, while the latter allows you to keep it in a branch
of the existing repository), but for the purposes of this article I am assuming
that we are working with the user level GitHub pages which are residing in the
repository named &amp;ldquo;&lt;strong&gt;&amp;lt;username&amp;gt;&lt;/strong&gt;.github.io&amp;rdquo; (where &lt;strong&gt;&amp;lt;username&amp;gt;&lt;/strong&gt;
is your GitHub user name) as per the official documentation.&lt;/p&gt;
&lt;p&gt;A few caveat I found and spent some time solving after following the official
documentation a listed below:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;GitHub&amp;rsquo;s documentation assumes use of Jekyll for site generation.&lt;/p&gt;
&lt;p&gt;It is not obvious how to use a different SSG (like Pelican).  As far as I
understand there are multiple triggers for GitHub to consider that the
web site is in &amp;ldquo;published&amp;rdquo; state, so just ignore any references to Jekyll
in the documentation: you will trip one of the triggers sooner or later,
for example by pushing HTML files into your repository.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Configure your DNS &lt;em&gt;before&lt;/em&gt; setting the custom domain name in GitHub Pages.&lt;/p&gt;
&lt;p&gt;Pushing the &lt;code&gt;CNAME&lt;/code&gt; file with the name of your custom domain within will
trigger a DNS check from GitHub to see that your custom domain name is
pointing back to GitHub Pages.&lt;/p&gt;
&lt;p&gt;DNS heavily relies on caching and depending on the TTL settings in your
zone if a negative check is performed (that is, when GitHub fails to
retrieve the corresponding record) you will likely need to wait for quite a
while for GitHub to retry.&lt;/p&gt;
&lt;p&gt;Setting up the CNAME record in advance and then verifying it with a query
&lt;em&gt;before&lt;/em&gt; you commit the &lt;code&gt;CNAME&lt;/code&gt; file to your repository ensures that you
will get the quickest validation response from GitHub, e.g. I set up my
CNAME records and then verified it from the command line (before)
submitting the request to GitHub:&lt;/p&gt;
&lt;pre id="code1" class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div id="code1.1" class="lines"&gt;&lt;a href="#code1.1"&gt;&lt;/a&gt;[user@localhost ~]$ host -t cname dmitry.khlebnikov.net 8.8.8.8
&lt;/div&gt;&lt;div id="code1.2" class="lines"&gt;&lt;a href="#code1.2"&gt;&lt;/a&gt;Using domain server:
&lt;/div&gt;&lt;div id="code1.3" class="lines"&gt;&lt;a href="#code1.3"&gt;&lt;/a&gt;Name: 8.8.8.8
&lt;/div&gt;&lt;div id="code1.4" class="lines"&gt;&lt;a href="#code1.4"&gt;&lt;/a&gt;Address: 8.8.8.8#53
&lt;/div&gt;&lt;div id="code1.5" class="lines"&gt;&lt;a href="#code1.5"&gt;&lt;/a&gt;Aliases:
&lt;/div&gt;&lt;div id="code1.6" class="lines"&gt;&lt;a href="#code1.6"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code1.7" class="lines"&gt;&lt;a href="#code1.7"&gt;&lt;/a&gt;dmitry.khlebnikov.net is an alias for galaxy4public.github.io.&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;There are some shenanigans with the &amp;ldquo;Enforce HTTPS&amp;rdquo; option.&lt;/p&gt;
&lt;p&gt;It is not obvious from the documentation, but the enforcement of HTTPS for
custom domains on GitHub&amp;rsquo;s side is dependent on the several things:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;before the checkbox is enabled your custom domain name should be
    confirmed by GitHub (your &lt;code&gt;CNAME&lt;/code&gt; file is in place and the repository
    settings show that the name was recognised);&lt;/li&gt;
&lt;li&gt;the CNAME record should point to your &amp;ldquo;&lt;strong&gt;&amp;lt;&lt;username&gt;&amp;gt;&lt;/strong&gt;.github.io.&amp;rdquo;
    DNS record (or, you can point it directly to GitHub Pages IP addresses
    if you want to conceal the repository name in the DNS output);&lt;/li&gt;
&lt;li&gt;if GitHub did not like something and you adjusted anything in the above
    dot points the &lt;strong&gt;only&lt;/strong&gt; way to trigger the enforcement of HTTPS is to
    re-submit the &lt;code&gt;CNAME&lt;/code&gt; file to the repository (yes, you read it right:
    you need to delete the file and push it to the repository again);&lt;/li&gt;
&lt;li&gt;Removing the &lt;code&gt;CNAME&lt;/code&gt; file from the repository is a disruptive action &amp;ndash;
    the site will not be accessible for the duration of the file being
    missing.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;OK, you have your public repository configured the way you want, so let&amp;rsquo;s look
at the settings we need to be able to publish our code to this public
repository.&lt;/p&gt;
&lt;p&gt;When I try to automate something, I usually start with writing down manual
steps I would do to achieve the results.  This helps me to see patterns and to
understand what I can easily automate and what will require some brain-storming
to resolve.&lt;/p&gt;
&lt;p&gt;In the case of updating the repository it is quite trivial: if I were to push
updates manually all I need is a private SSH key with the corresponding public
SSH key configured with write privileges for the repository and I could push
with &lt;code&gt;git push&lt;/code&gt; from my local copy of the repository.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a name="quote-private-keys" href="#quote-private-keys"&gt;&lt;/a&gt; &amp;hellip; private keys are called &amp;ldquo;private&amp;rdquo; for a reason &amp;ndash; they are not supposed
to leave the device under any circumstances. [&amp;hellip;] please pay attention when
you read of hear somebody advising you to upload your private keys somewhere,
it is usually bad advice.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;My private keys are called &amp;ldquo;private&amp;rdquo; for a reason &amp;ndash; they are not supposed to
leave my device(s) under any circumstances (except for backup purposes such as
storing them in a safe).  So, please pay attention when you read or hear
somebody advising you to upload your private keys somewhere, it is usually
bad advice.&lt;/p&gt;
&lt;p&gt;For the integration purposes, GitHub provides so-called &amp;ldquo;Deploy keys&amp;rdquo; and
&amp;ldquo;Personal access tokens&amp;rdquo;.  The former is just an SSH key pair associated with a
particular repository (you can configure it in repository&amp;rsquo;s setting) while the
latter is an OAuth access token associated with &lt;em&gt;your&lt;/em&gt; account.&lt;/p&gt;
&lt;p&gt;While you can successfully use both, I would recommend to use the &amp;ldquo;Deploy keys&amp;rdquo;
only, since despite that you can try to scope access down for a personal token
it would not be good enough and the actions performed using that token will
look like &lt;em&gt;you&lt;/em&gt; are executing them.&lt;/p&gt;
&lt;p&gt;To configure a &amp;ldquo;Deploy key&amp;rdquo; we need to do two things:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;Generate an SSH key pair, e.g.:&lt;/p&gt;
&lt;pre id="code2" class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div id="code2.1" class="lines"&gt;&lt;a href="#code2.1"&gt;&lt;/a&gt;[user@localhost ~]$ ssh-keygen -t ed25519 -N '' -C 'Updating the blog from GH Action' -f ~/gh-action
&lt;/div&gt;&lt;div id="code2.2" class="lines"&gt;&lt;a href="#code2.2"&gt;&lt;/a&gt;Generating public/private ed25519 key pair.
&lt;/div&gt;&lt;div id="code2.3" class="lines"&gt;&lt;a href="#code2.3"&gt;&lt;/a&gt;Your identification has been saved in /home/user/gh-action
&lt;/div&gt;&lt;div id="code2.4" class="lines"&gt;&lt;a href="#code2.4"&gt;&lt;/a&gt;Your public key has been saved in /home/user/gh-action.pub
&lt;/div&gt;&lt;div id="code2.5" class="lines"&gt;&lt;a href="#code2.5"&gt;&lt;/a&gt;The key fingerprint is:
&lt;/div&gt;&lt;div id="code2.6" class="lines"&gt;&lt;a href="#code2.6"&gt;&lt;/a&gt;SHA256:7W9pUV5IlrRVE0RAVkjLgKJz4RdtVbH7GKQu8AfYITw Updating the blog from GH Action
&lt;/div&gt;&lt;div id="code2.7" class="lines"&gt;&lt;a href="#code2.7"&gt;&lt;/a&gt;The key's randomart image is:
&lt;/div&gt;&lt;div id="code2.8" class="lines"&gt;&lt;a href="#code2.8"&gt;&lt;/a&gt;+--[ED25519 256]--+
&lt;/div&gt;&lt;div id="code2.9" class="lines"&gt;&lt;a href="#code2.9"&gt;&lt;/a&gt;|          o.+BOX*|
&lt;/div&gt;&lt;div id="code2.10" class="lines"&gt;&lt;a href="#code2.10"&gt;&lt;/a&gt;|       + o o+.=oo|
&lt;/div&gt;&lt;div id="code2.11" class="lines"&gt;&lt;a href="#code2.11"&gt;&lt;/a&gt;|      o E +  =oo |
&lt;/div&gt;&lt;div id="code2.12" class="lines"&gt;&lt;a href="#code2.12"&gt;&lt;/a&gt;|     o o B . oo o|
&lt;/div&gt;&lt;div id="code2.13" class="lines"&gt;&lt;a href="#code2.13"&gt;&lt;/a&gt;|      o S + .o.o |
&lt;/div&gt;&lt;div id="code2.14" class="lines"&gt;&lt;a href="#code2.14"&gt;&lt;/a&gt;|         + o. .o.|
&lt;/div&gt;&lt;div id="code2.15" class="lines"&gt;&lt;a href="#code2.15"&gt;&lt;/a&gt;|          + oo. .|
&lt;/div&gt;&lt;div id="code2.16" class="lines"&gt;&lt;a href="#code2.16"&gt;&lt;/a&gt;|           ++    |
&lt;/div&gt;&lt;div id="code2.17" class="lines"&gt;&lt;a href="#code2.17"&gt;&lt;/a&gt;|           o.    |
&lt;/div&gt;&lt;div id="code2.18" class="lines"&gt;&lt;a href="#code2.18"&gt;&lt;/a&gt;+----[SHA256]-----+&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, I chose the &lt;code&gt;ed25519&lt;/code&gt; key type since it is the shortest from the
GitHub supported key types at the moment, yet it is strong enough.&lt;/p&gt;
&lt;p&gt;I also made the key pair passphrase-less (&lt;code&gt;-N ''&lt;/code&gt;) since the purpose of the
key pair is to automate things in the unattended fashion and there will be
no one to type in the passphrase.&lt;/p&gt;
&lt;p&gt;The key pair comment just makes it easier to maintain your keys, but optional.&lt;/p&gt;
&lt;p&gt;Finally, the &lt;code&gt;-f ~/gh-action&lt;/code&gt; option specifies where the generated private
key is going to be stored.  The public counterpart will use the same path with
the &lt;code&gt;.pub&lt;/code&gt; suffix appended to it.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Set the newly generated &lt;em&gt;public&lt;/em&gt; key up as the &amp;ldquo;Deploy key&amp;rdquo;:&lt;/p&gt;
&lt;p&gt;All you need to do is to go to the repository setting for the public
 repository you created for GitHub Pages, click on &amp;ldquo;Deploy keys&amp;rdquo; in the
 left side menu, then click on the &amp;ldquo;Add deploy key&amp;rdquo; button in the upper
 right corner.&lt;/p&gt;
&lt;p&gt;On the next page, provide a sensible description for the deploy key (I
 used the same text as I put into the keys comment, i.e. &amp;ldquo;Updating the blog
 from GH Action&amp;rdquo;) and copy and paste the recently generated &lt;em&gt;public&lt;/em&gt; key.
 GitHub does not allow you to upload files over there, so you need to copy
 the content of the &lt;strong&gt;public&lt;/strong&gt; key file and paste it into the form, e.g.:&lt;/p&gt;
&lt;pre id="code3" class="highlight" data-file="~/gh-action.pub"&gt;&lt;code class="language-text"&gt;&lt;div id="code3.1" class="lines"&gt;&lt;a href="#code3.1"&gt;&lt;/a&gt;ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIGHCy+stVCBjsrVO2ld1DwKCwcKL9+i1sjxcZu4u4lFQ Updating the blog from GH Action&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt;: You need to ensure that you tick the &amp;ldquo;Allow write access&amp;rdquo; checkbox,
 otherwise we would not be able to push to the repository with the
 corresponding private key.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This, actually, concludes the configuration of the GitHub Pages repository for
now &amp;ndash; in later articles I will document how one could leverage the repository
Issues for managing comments on the web site and maintain the counters for
likes on the pages, but it would be a completely separate post :).&lt;/p&gt;
&lt;h2 id="setting-up-the-private-code-repository"&gt;Setting up the private, code repository&lt;/h2&gt;
&lt;p&gt;A typical Pelican repository layout is quite simple and comprises of one
mandatory directory, one semi-mandatory file, and everything else is optional,
but could be used to enhance your experience.&lt;/p&gt;
&lt;p&gt;The mandatory directory is the so-called
&amp;ldquo;&lt;a href="https://docs.getpelican.com/en/stable/install.html#kickstart-your-site"&gt;content&lt;/a&gt;&amp;rdquo;
directory (in Pelican&amp;rsquo;s terms).  The name of the directory can be anything you
want, but it is better be reflected in &lt;a href="https://docs.getpelican.com/en/stable/settings.html#PATH"&gt;the &lt;code&gt;PATH =&lt;/code&gt;
directive&lt;/a&gt; of the
setting file.&lt;/p&gt;
&lt;p&gt;I am saying &amp;ldquo;better be&amp;rdquo; since Pelican can operate without any configuration
files, but the result will be limited, hence I call the &lt;code&gt;pelicanconf.py&lt;/code&gt; file
(which is the default name for the configuration file) to be &amp;ldquo;semi-mandatory&amp;rdquo;.
The name of the configuration file can be also anything you like, however, I
suggest to stick with the default for now.&lt;/p&gt;
&lt;p&gt;Basically, you can quickly start by following the Pelican documentation, by
doing something as follows:&lt;/p&gt;
&lt;pre id="code3" class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div id="code3.1" class="lines"&gt;&lt;a href="#code3.1"&gt;&lt;/a&gt;[user@localhost ~]$ virtualenv ~/venv/pelican
&lt;/div&gt;&lt;div id="code3.2" class="lines"&gt;&lt;a href="#code3.2"&gt;&lt;/a&gt;created virtual environment CPython3.8.2.final.0-64 in 477ms
&lt;/div&gt;&lt;div id="code3.3" class="lines"&gt;&lt;a href="#code3.3"&gt;&lt;/a&gt;  creator CPython3Posix(dest=/home/user/venv/pelican, clear=False, global=False)
&lt;/div&gt;&lt;div id="code3.4" class="lines"&gt;&lt;a href="#code3.4"&gt;&lt;/a&gt;  seeder FromAppData(download=False, pip=latest, setuptools=latest, wheel=latest, via=copy, app_data_dir=/home/user/.local/share/virtualenv/seed-app-data/v1.0.1)
&lt;/div&gt;&lt;div id="code3.5" class="lines"&gt;&lt;a href="#code3.5"&gt;&lt;/a&gt;  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator
&lt;/div&gt;&lt;div id="code3.6" class="lines"&gt;&lt;a href="#code3.6"&gt;&lt;/a&gt;[user@localhost ~]$ . ~/venv/pelican/bin/activate
&lt;/div&gt;&lt;div id="code3.7" class="lines"&gt;&lt;a href="#code3.7"&gt;&lt;/a&gt;(pelican) $ mkdir ~/blog
&lt;/div&gt;&lt;div id="code3.8" class="lines"&gt;&lt;a href="#code3.8"&gt;&lt;/a&gt;(pelican) $ cd ~/blog
&lt;/div&gt;&lt;div id="code3.9" class="lines"&gt;&lt;a href="#code3.9"&gt;&lt;/a&gt;(pelican) $ git init
&lt;/div&gt;&lt;div id="code3.10" class="lines"&gt;&lt;a href="#code3.10"&gt;&lt;/a&gt;Initialized empty Git repository in /home/user/blog/.git/
&lt;/div&gt;&lt;div id="code3.11" class="lines"&gt;&lt;a href="#code3.11"&gt;&lt;/a&gt;(pelican) $ git config --local user.email &amp;quot;your@github-email.here&amp;quot;
&lt;/div&gt;&lt;div id="code3.12" class="lines"&gt;&lt;a href="#code3.12"&gt;&lt;/a&gt;(pelican) $ git config --local user.name &amp;quot;Joe Happy&amp;quot;
&lt;/div&gt;&lt;div id="code3.13" class="lines"&gt;&lt;a href="#code3.13"&gt;&lt;/a&gt;(pelican) $ pelican-quickstart 
&lt;/div&gt;&lt;div id="code3.14" class="lines"&gt;&lt;a href="#code3.14"&gt;&lt;/a&gt;Welcome to pelican-quickstart v4.2.0.
&lt;/div&gt;&lt;div id="code3.15" class="lines"&gt;&lt;a href="#code3.15"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code3.16" class="lines"&gt;&lt;a href="#code3.16"&gt;&lt;/a&gt;This script will help you create a new Pelican-based website.
&lt;/div&gt;&lt;div id="code3.17" class="lines"&gt;&lt;a href="#code3.17"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code3.18" class="lines"&gt;&lt;a href="#code3.18"&gt;&lt;/a&gt;Please answer the following questions so this script can generate the files
&lt;/div&gt;&lt;div id="code3.19" class="lines"&gt;&lt;a href="#code3.19"&gt;&lt;/a&gt;needed by Pelican.
&lt;/div&gt;&lt;div id="code3.20" class="lines"&gt;&lt;a href="#code3.20"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code3.21" class="lines"&gt;&lt;a href="#code3.21"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code3.22" class="lines"&gt;&lt;a href="#code3.22"&gt;&lt;/a&gt;&amp;gt; Where do you want to create your new web site? [.] 
&lt;/div&gt;&lt;div id="code3.23" class="lines"&gt;&lt;a href="#code3.23"&gt;&lt;/a&gt;&amp;gt; What will be the title of this web site? My Awesome Blog
&lt;/div&gt;&lt;div id="code3.24" class="lines"&gt;&lt;a href="#code3.24"&gt;&lt;/a&gt;&amp;gt; Who will be the author of this web site? Joe Happy
&lt;/div&gt;&lt;div id="code3.25" class="lines"&gt;&lt;a href="#code3.25"&gt;&lt;/a&gt;&amp;gt; What will be the default language of this web site? [en] 
&lt;/div&gt;&lt;div id="code3.26" class="lines"&gt;&lt;a href="#code3.26"&gt;&lt;/a&gt;&amp;gt; Do you want to specify a URL prefix? e.g., https://example.com   (Y/n) n
&lt;/div&gt;&lt;div id="code3.27" class="lines"&gt;&lt;a href="#code3.27"&gt;&lt;/a&gt;&amp;gt; Do you want to enable article pagination? (Y/n) 
&lt;/div&gt;&lt;div id="code3.28" class="lines"&gt;&lt;a href="#code3.28"&gt;&lt;/a&gt;&amp;gt; How many articles per page do you want? [10] 
&lt;/div&gt;&lt;div id="code3.29" class="lines"&gt;&lt;a href="#code3.29"&gt;&lt;/a&gt;&amp;gt; What is your time zone? [Europe/Paris] Australia/Melbourne
&lt;/div&gt;&lt;div id="code3.30" class="lines"&gt;&lt;a href="#code3.30"&gt;&lt;/a&gt;&amp;gt; Do you want to generate a tasks.py/Makefile to automate generation and publishing? (Y/n) n
&lt;/div&gt;&lt;div id="code3.31" class="lines"&gt;&lt;a href="#code3.31"&gt;&lt;/a&gt;Done. Your new project is available at /home/user/blog
&lt;/div&gt;&lt;div id="code3.32" class="lines"&gt;&lt;a href="#code3.32"&gt;&lt;/a&gt;(pelican) $ ls -l
&lt;/div&gt;&lt;div id="code3.33" class="lines"&gt;&lt;a href="#code3.33"&gt;&lt;/a&gt;total 16
&lt;/div&gt;&lt;div id="code3.34" class="lines"&gt;&lt;a href="#code3.34"&gt;&lt;/a&gt;drwxr-xr-x 2   user   user 4096 May 10 00:31 content
&lt;/div&gt;&lt;div id="code3.35" class="lines"&gt;&lt;a href="#code3.35"&gt;&lt;/a&gt;drwxr-xr-x 2   user   user 4096 May 10 00:31 output
&lt;/div&gt;&lt;div id="code3.36" class="lines"&gt;&lt;a href="#code3.36"&gt;&lt;/a&gt;-rw-r--r-- 1   user   user  869 May 10 00:31 pelicanconf.py
&lt;/div&gt;&lt;div id="code3.37" class="lines"&gt;&lt;a href="#code3.37"&gt;&lt;/a&gt;-rw-r--r-- 1   user   user  589 May 10 00:31 publishconf.py
&lt;/div&gt;&lt;div id="code3.38" class="lines"&gt;&lt;a href="#code3.38"&gt;&lt;/a&gt;(pelican) $ rm -rf output publishconf.py
&lt;/div&gt;&lt;div id="code3.39" class="lines"&gt;&lt;a href="#code3.39"&gt;&lt;/a&gt;(pelican) $ git add content pelicanconf.py 
&lt;/div&gt;&lt;div id="code3.40" class="lines"&gt;&lt;a href="#code3.40"&gt;&lt;/a&gt;(pelican) $ git commit -m 'Initial commit'
&lt;/div&gt;&lt;div id="code3.41" class="lines"&gt;&lt;a href="#code3.41"&gt;&lt;/a&gt;[master (root-commit) f077002] Initial commit
&lt;/div&gt;&lt;div id="code3.42" class="lines"&gt;&lt;a href="#code3.42"&gt;&lt;/a&gt; 1 file changed, 35 insertions(+)
&lt;/div&gt;&lt;div id="code3.43" class="lines"&gt;&lt;a href="#code3.43"&gt;&lt;/a&gt; create mode 100644 pelicanconf.py&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A short break down of the above session snippet is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;On line 1 we create a virtual Python environment, so we could install Pelican locally;&lt;/li&gt;
&lt;li&gt;We enter the newly created virtual environment on line 2, which makes Pelican available to us;&lt;/li&gt;
&lt;li&gt;We create an empty repository (&lt;code&gt;~/blog&lt;/code&gt;) and initialise it using Pelican&amp;rsquo;s quickstart;&lt;/li&gt;
&lt;li&gt;Since we are not using the default publishing capabilities and we are not interested in storing the generated pages in our code repository, we clean things up a bit;&lt;/li&gt;
&lt;li&gt;Finally, we commit the generated skeleton to Git.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A good test at this stage would be to ensure that Pelican is working and likes our structure:&lt;/p&gt;
&lt;pre id="code4" class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div id="code4.1" class="lines"&gt;&lt;a href="#code4.1"&gt;&lt;/a&gt;[user@localhost ~]$ pelican
&lt;/div&gt;&lt;div id="code4.2" class="lines"&gt;&lt;a href="#code4.2"&gt;&lt;/a&gt;WARNING: No valid files found in content for the active readers:
&lt;/div&gt;&lt;div id="code4.3" class="lines"&gt;&lt;a href="#code4.3"&gt;&lt;/a&gt;  | BaseReader (static)
&lt;/div&gt;&lt;div id="code4.4" class="lines"&gt;&lt;a href="#code4.4"&gt;&lt;/a&gt;  | HTMLReader (htm, html)
&lt;/div&gt;&lt;div id="code4.5" class="lines"&gt;&lt;a href="#code4.5"&gt;&lt;/a&gt;  | MarkdownReader (md, markdown, mkd, mdown)
&lt;/div&gt;&lt;div id="code4.6" class="lines"&gt;&lt;a href="#code4.6"&gt;&lt;/a&gt;  | RstReader (rst)
&lt;/div&gt;&lt;div id="code4.7" class="lines"&gt;&lt;a href="#code4.7"&gt;&lt;/a&gt;Done: Processed 0 articles, 0 drafts, 0 pages, 0 hidden pages and 0 draft pages in 0.07 seconds.&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So far so good, but it is not a real test since there are no source files to generate something from, so let&amp;rsquo;s give Pelican something to work on:&lt;/p&gt;
&lt;pre id="code5" class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div id="code5.1" class="lines"&gt;&lt;a href="#code5.1"&gt;&lt;/a&gt;[user@localhost ~]$ printf 'Title: First Post\nDate: 2020-05-10\n\n#First post\nPelican is awesome!' &amp;gt; content/first.md
&lt;/div&gt;&lt;div id="code5.2" class="lines"&gt;&lt;a href="#code5.2"&gt;&lt;/a&gt;[user@localhost ~]$ pelican
&lt;/div&gt;&lt;div id="code5.3" class="lines"&gt;&lt;a href="#code5.3"&gt;&lt;/a&gt;Done: Processed 1 article, 0 drafts, 0 pages, 0 hidden pages and 0 draft pages in 0.12 seconds.
&lt;/div&gt;&lt;div id="code5.4" class="lines"&gt;&lt;a href="#code5.4"&gt;&lt;/a&gt;[user@localhost ~]$ elinks -dump output/index.html 
&lt;/div&gt;&lt;div id="code5.5" class="lines"&gt;&lt;a href="#code5.5"&gt;&lt;/a&gt;                               [1]My Awesome Blog
&lt;/div&gt;&lt;div id="code5.6" class="lines"&gt;&lt;a href="#code5.6"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.7" class="lines"&gt;&lt;a href="#code5.7"&gt;&lt;/a&gt;     • [2]misc
&lt;/div&gt;&lt;div id="code5.8" class="lines"&gt;&lt;a href="#code5.8"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.9" class="lines"&gt;&lt;a href="#code5.9"&gt;&lt;/a&gt;                                 [3]First Post
&lt;/div&gt;&lt;div id="code5.10" class="lines"&gt;&lt;a href="#code5.10"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.11" class="lines"&gt;&lt;a href="#code5.11"&gt;&lt;/a&gt;   Published: Sun 10 May 2020
&lt;/div&gt;&lt;div id="code5.12" class="lines"&gt;&lt;a href="#code5.12"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.13" class="lines"&gt;&lt;a href="#code5.13"&gt;&lt;/a&gt;    By [4]Joe Happy
&lt;/div&gt;&lt;div id="code5.14" class="lines"&gt;&lt;a href="#code5.14"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.15" class="lines"&gt;&lt;a href="#code5.15"&gt;&lt;/a&gt;   In [5]misc.
&lt;/div&gt;&lt;div id="code5.16" class="lines"&gt;&lt;a href="#code5.16"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.17" class="lines"&gt;&lt;a href="#code5.17"&gt;&lt;/a&gt;                                   First post
&lt;/div&gt;&lt;div id="code5.18" class="lines"&gt;&lt;a href="#code5.18"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code5.19" class="lines"&gt;&lt;a href="#code5.19"&gt;&lt;/a&gt;   Pelican is awesome!&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The output from &lt;code&gt;elinks&lt;/code&gt; was truncated on purpose since I just wanted to
showcase that Pelican has indeed generated the structure for a static website
from just one article file we created.&lt;/p&gt;
&lt;p&gt;Before we push our local repository to GitHub we may want to do some house
keeping first, such as create the &lt;code&gt;.gitignore&lt;/code&gt; file and list the temporary
things we do not want Git to track.  A good enough version of the &lt;code&gt;.gitignore&lt;/code&gt;
file I am using for my code repository is the following:&lt;/p&gt;
&lt;pre id="code6" class="highlight" data-file=".gitignore"&gt;&lt;code class="language-txt"&gt;&lt;div id="code6.1" class="lines"&gt;&lt;a href="#code6.1"&gt;&lt;/a&gt;*~
&lt;/div&gt;&lt;div id="code6.2" class="lines"&gt;&lt;a href="#code6.2"&gt;&lt;/a&gt;*.pyc
&lt;/div&gt;&lt;div id="code6.3" class="lines"&gt;&lt;a href="#code6.3"&gt;&lt;/a&gt;.*.swp
&lt;/div&gt;&lt;div id="code6.4" class="lines"&gt;&lt;a href="#code6.4"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code6.5" class="lines"&gt;&lt;a href="#code6.5"&gt;&lt;/a&gt;**/__pycache__
&lt;/div&gt;&lt;div id="code6.6" class="lines"&gt;&lt;a href="#code6.6"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code6.7" class="lines"&gt;&lt;a href="#code6.7"&gt;&lt;/a&gt;/output&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Do not forget to actually commit that &lt;code&gt;.gitignore&lt;/code&gt; file to your local
repository using the &lt;code&gt;git add .gitignore &amp;amp;&amp;amp; git commit -m 'Added .gitignore'&lt;/code&gt;,
by the way.&lt;/p&gt;
&lt;p&gt;Now, we need to create a private repository on GitHub, so jump into your
browser, go to your GitHub account, press the &amp;ldquo;+&amp;rdquo; icon in the upper right
corner (right next to your profile icon), and select &amp;ldquo;New repository&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;On the &amp;ldquo;Create repository&amp;rdquo; page put whatever you desire as the name and the
description of the repository you are about to create.  Ensure that the
&amp;ldquo;Private&amp;rdquo; radio button is selected and uncheck the &amp;ldquo;Initialize this repository
with a README&amp;rdquo; if it was checked.&lt;/p&gt;
&lt;p&gt;Once the repository is created, you will be presented with a page that
enumerates your options for the next step, but I will just go ahead and show a
session dump of what you will need to do.  In the following session snippet
&lt;code&gt;blog&lt;/code&gt; is the repository name I chose for my private code repository and you
will need to replace it with your private repository name (the working
directory is our newly created local repository):&lt;/p&gt;
&lt;pre id="code7" class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div id="code7.1" class="lines"&gt;&lt;a href="#code7.1"&gt;&lt;/a&gt;[user@localhost ~]$ git remote add origin git@github.com:galaxy4public/blog.git
&lt;/div&gt;&lt;div id="code7.2" class="lines"&gt;&lt;a href="#code7.2"&gt;&lt;/a&gt;[user@localhost ~]$ git push -u origin master
&lt;/div&gt;&lt;div id="code7.3" class="lines"&gt;&lt;a href="#code7.3"&gt;&lt;/a&gt;Enter passphrase for key '/home/user/.ssh/keys/github': 
&lt;/div&gt;&lt;div id="code7.4" class="lines"&gt;&lt;a href="#code7.4"&gt;&lt;/a&gt;Enumerating objects: 6, done.
&lt;/div&gt;&lt;div id="code7.5" class="lines"&gt;&lt;a href="#code7.5"&gt;&lt;/a&gt;Counting objects: 100% (6/6), done.
&lt;/div&gt;&lt;div id="code7.6" class="lines"&gt;&lt;a href="#code7.6"&gt;&lt;/a&gt;Delta compression using up to 4 threads
&lt;/div&gt;&lt;div id="code7.7" class="lines"&gt;&lt;a href="#code7.7"&gt;&lt;/a&gt;Compressing objects: 100% (4/4), done.
&lt;/div&gt;&lt;div id="code7.8" class="lines"&gt;&lt;a href="#code7.8"&gt;&lt;/a&gt;Writing objects: 100% (6/6), 1008 bytes | 1008.00 KiB/s, done.
&lt;/div&gt;&lt;div id="code7.9" class="lines"&gt;&lt;a href="#code7.9"&gt;&lt;/a&gt;Total 6 (delta 0), reused 0 (delta 0), pack-reused 0
&lt;/div&gt;&lt;div id="code7.10" class="lines"&gt;&lt;a href="#code7.10"&gt;&lt;/a&gt;To github.com:galaxy4public/blog.git
&lt;/div&gt;&lt;div id="code7.11" class="lines"&gt;&lt;a href="#code7.11"&gt;&lt;/a&gt; * [new branch]      master -&amp;gt; master
&lt;/div&gt;&lt;div id="code7.12" class="lines"&gt;&lt;a href="#code7.12"&gt;&lt;/a&gt;Branch 'master' set up to track remote branch 'master' from 'origin'.&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id="configuring-the-github-action-for-publishing"&gt;Configuring the GitHub Action for publishing&lt;/h2&gt;
&lt;p&gt;Everything is well and good, but &amp;ldquo;where is the automation?&amp;rdquo; you may ask.  After
all, I suspect this was the primary reason you are reading this post.  Well, we
are about to start to look into the automation part and it is rather short in
comparison to all the steps we did to set repositories up.&lt;/p&gt;
&lt;p&gt;Our automation relies on the GitHub Action feature of GitHub.  In plain terms,
GitHub Action is free compute resource provided by GitHub (there are some
limits, but for the purposes of a personal blog it is unlikely that you will
ever hit these limits).&lt;/p&gt;
&lt;p&gt;Each GitHub Action is associated with a specific repository and is defined
using quite a simple YAML configuration file that instructs GitHub on how to
provision a required compute environment and what to run inside that
environment.&lt;/p&gt;
&lt;p&gt;The GitHub Action I am using for my blog web site is the following (we will
dissect it further down the post):&lt;/p&gt;
&lt;pre id="code8" class="highlight" data-file=".github/workflows/pelican.yml"&gt;&lt;code class="language-yaml"&gt;&lt;div id="code8.1" class="lines"&gt;&lt;a href="#code8.1"&gt;&lt;/a&gt;name: Static Website Generator
&lt;/div&gt;&lt;div id="code8.2" class="lines"&gt;&lt;a href="#code8.2"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code8.3" class="lines"&gt;&lt;a href="#code8.3"&gt;&lt;/a&gt;on:
&lt;/div&gt;&lt;div id="code8.4" class="lines"&gt;&lt;a href="#code8.4"&gt;&lt;/a&gt;  push:
&lt;/div&gt;&lt;div id="code8.5" class="lines"&gt;&lt;a href="#code8.5"&gt;&lt;/a&gt;    branches: [ master ]
&lt;/div&gt;&lt;div id="code8.6" class="lines"&gt;&lt;a href="#code8.6"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code8.7" class="lines"&gt;&lt;a href="#code8.7"&gt;&lt;/a&gt;env:
&lt;/div&gt;&lt;div id="code8.8" class="lines"&gt;&lt;a href="#code8.8"&gt;&lt;/a&gt;  LANG: en_AU.UTF-8
&lt;/div&gt;&lt;div id="code8.9" class="lines"&gt;&lt;a href="#code8.9"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code8.10" class="lines"&gt;&lt;a href="#code8.10"&gt;&lt;/a&gt;jobs:
&lt;/div&gt;&lt;div id="code8.11" class="lines"&gt;&lt;a href="#code8.11"&gt;&lt;/a&gt;  build:
&lt;/div&gt;&lt;div id="code8.12" class="lines"&gt;&lt;a href="#code8.12"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code8.13" class="lines"&gt;&lt;a href="#code8.13"&gt;&lt;/a&gt;    runs-on: ubuntu-latest
&lt;/div&gt;&lt;div id="code8.14" class="lines"&gt;&lt;a href="#code8.14"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="code8.15" class="lines"&gt;&lt;a href="#code8.15"&gt;&lt;/a&gt;    steps:
&lt;/div&gt;&lt;div id="code8.16" class="lines"&gt;&lt;a href="#code8.16"&gt;&lt;/a&gt;    - name: Initialise locale
&lt;/div&gt;&lt;div id="code8.17" class="lines"&gt;&lt;a href="#code8.17"&gt;&lt;/a&gt;      run: |
&lt;/div&gt;&lt;div id="code8.18" class="lines"&gt;&lt;a href="#code8.18"&gt;&lt;/a&gt;        if [ &amp;quot;$LANG&amp;quot; != 'C' -a &amp;quot;{$LANG:0:2}&amp;quot; != 'C.' ]; then
&lt;/div&gt;&lt;div id="code8.19" class="lines"&gt;&lt;a href="#code8.19"&gt;&lt;/a&gt;          CP=&amp;quot;${LANG#*.}&amp;quot; &amp;amp;&amp;amp; [ -z &amp;quot;$CP&amp;quot; ] &amp;amp;&amp;amp; CP=UTF-8 ||:
&lt;/div&gt;&lt;div id="code8.20" class="lines"&gt;&lt;a href="#code8.20"&gt;&lt;/a&gt;          sudo sed -i -E &amp;quot;/^\s*$LANG(\s|\$)/{:a;n;ba;q};\$a$LANG $CP&amp;quot; /etc/locale.gen
&lt;/div&gt;&lt;div id="code8.21" class="lines"&gt;&lt;a href="#code8.21"&gt;&lt;/a&gt;          sudo locale-gen
&lt;/div&gt;&lt;div id="code8.22" class="lines"&gt;&lt;a href="#code8.22"&gt;&lt;/a&gt;          sudo localectl set-locale LANG=&amp;quot;${LANG:-C.UTF-8}&amp;quot;
&lt;/div&gt;&lt;div id="code8.23" class="lines"&gt;&lt;a href="#code8.23"&gt;&lt;/a&gt;        fi
&lt;/div&gt;&lt;div id="code8.24" class="lines"&gt;&lt;a href="#code8.24"&gt;&lt;/a&gt;        locale -a
&lt;/div&gt;&lt;div id="code8.25" class="lines"&gt;&lt;a href="#code8.25"&gt;&lt;/a&gt;    - name: Checkout the primary repo
&lt;/div&gt;&lt;div id="code8.26" class="lines"&gt;&lt;a href="#code8.26"&gt;&lt;/a&gt;      uses: actions/checkout@v2
&lt;/div&gt;&lt;div id="code8.27" class="lines"&gt;&lt;a href="#code8.27"&gt;&lt;/a&gt;      with:
&lt;/div&gt;&lt;div id="code8.28" class="lines"&gt;&lt;a href="#code8.28"&gt;&lt;/a&gt;        fetch-depth: 0
&lt;/div&gt;&lt;div id="code8.29" class="lines"&gt;&lt;a href="#code8.29"&gt;&lt;/a&gt;        submodules: recursive
&lt;/div&gt;&lt;div id="code8.30" class="lines"&gt;&lt;a href="#code8.30"&gt;&lt;/a&gt;    - name: Restore modification times for content
&lt;/div&gt;&lt;div id="code8.31" class="lines"&gt;&lt;a href="#code8.31"&gt;&lt;/a&gt;      run: |
&lt;/div&gt;&lt;div id="code8.32" class="lines"&gt;&lt;a href="#code8.32"&gt;&lt;/a&gt;        git log --pretty=tformat:&amp;quot;%at&amp;quot; --name-status --no-merges -- \
&lt;/div&gt;&lt;div id="code8.33" class="lines"&gt;&lt;a href="#code8.33"&gt;&lt;/a&gt;            content \
&lt;/div&gt;&lt;div id="code8.34" class="lines"&gt;&lt;a href="#code8.34"&gt;&lt;/a&gt;            themes/mind-drops/content \
&lt;/div&gt;&lt;div id="code8.35" class="lines"&gt;&lt;a href="#code8.35"&gt;&lt;/a&gt;        | sed -nE '
&lt;/div&gt;&lt;div id="code8.36" class="lines"&gt;&lt;a href="#code8.36"&gt;&lt;/a&gt;            /^\s*$/d;/^[[:digit:]]+$/{h;d};
&lt;/div&gt;&lt;div id="code8.37" class="lines"&gt;&lt;a href="#code8.37"&gt;&lt;/a&gt;            /^[UXB]/d;
&lt;/div&gt;&lt;div id="code8.38" class="lines"&gt;&lt;a href="#code8.38"&gt;&lt;/a&gt;            /^[AMT]/{s,^\S\s+,,;G;s,^(.+)\n(.+),\2 \1,;p};
&lt;/div&gt;&lt;div id="code8.39" class="lines"&gt;&lt;a href="#code8.39"&gt;&lt;/a&gt;            /^[DR]/{
&lt;/div&gt;&lt;div id="code8.40" class="lines"&gt;&lt;a href="#code8.40"&gt;&lt;/a&gt;              s,^(D|[CR][[:digit:]]+)\s+,\1 ,;G;
&lt;/div&gt;&lt;div id="code8.41" class="lines"&gt;&lt;a href="#code8.41"&gt;&lt;/a&gt;              s,^(\S+) ([^[=\t=]]+[[=\t=]])?(.*)\n(.+),\4\1 \3,;
&lt;/div&gt;&lt;div id="code8.42" class="lines"&gt;&lt;a href="#code8.42"&gt;&lt;/a&gt;              p
&lt;/div&gt;&lt;div id="code8.43" class="lines"&gt;&lt;a href="#code8.43"&gt;&lt;/a&gt;            }' \
&lt;/div&gt;&lt;div id="code8.44" class="lines"&gt;&lt;a href="#code8.44"&gt;&lt;/a&gt;        | LC_ALL=C sort -k2 -k1rn | uniq -f1 \
&lt;/div&gt;&lt;div id="code8.45" class="lines"&gt;&lt;a href="#code8.45"&gt;&lt;/a&gt;        | sed -E '/^[[:digit:]]+D /d' \
&lt;/div&gt;&lt;div id="code8.46" class="lines"&gt;&lt;a href="#code8.46"&gt;&lt;/a&gt;        | while read TSTAMP FILE; do
&lt;/div&gt;&lt;div id="code8.47" class="lines"&gt;&lt;a href="#code8.47"&gt;&lt;/a&gt;            if [ -f &amp;quot;$FILE&amp;quot; ]; then
&lt;/div&gt;&lt;div id="code8.48" class="lines"&gt;&lt;a href="#code8.48"&gt;&lt;/a&gt;                echo &amp;quot;$FILE =&amp;gt; $(date -d @$TSTAMP)&amp;quot;
&lt;/div&gt;&lt;div id="code8.49" class="lines"&gt;&lt;a href="#code8.49"&gt;&lt;/a&gt;                touch -m -d &amp;quot;@$TSTAMP&amp;quot; -- &amp;quot;$FILE&amp;quot;
&lt;/div&gt;&lt;div id="code8.50" class="lines"&gt;&lt;a href="#code8.50"&gt;&lt;/a&gt;            fi
&lt;/div&gt;&lt;div id="code8.51" class="lines"&gt;&lt;a href="#code8.51"&gt;&lt;/a&gt;        done
&lt;/div&gt;&lt;div id="code8.52" class="lines"&gt;&lt;a href="#code8.52"&gt;&lt;/a&gt;    - name: Checkout Pages repo
&lt;/div&gt;&lt;div id="code8.53" class="lines"&gt;&lt;a href="#code8.53"&gt;&lt;/a&gt;      uses: actions/checkout@v2
&lt;/div&gt;&lt;div id="code8.54" class="lines"&gt;&lt;a href="#code8.54"&gt;&lt;/a&gt;      with:
&lt;/div&gt;&lt;div id="code8.55" class="lines"&gt;&lt;a href="#code8.55"&gt;&lt;/a&gt;        repository: galaxy4public/galaxy4public.github.io
&lt;/div&gt;&lt;div id="code8.56" class="lines"&gt;&lt;a href="#code8.56"&gt;&lt;/a&gt;        path: output
&lt;/div&gt;&lt;div id="code8.57" class="lines"&gt;&lt;a href="#code8.57"&gt;&lt;/a&gt;    - name: Set up Python
&lt;/div&gt;&lt;div id="code8.58" class="lines"&gt;&lt;a href="#code8.58"&gt;&lt;/a&gt;      uses: actions/setup-python@v2
&lt;/div&gt;&lt;div id="code8.59" class="lines"&gt;&lt;a href="#code8.59"&gt;&lt;/a&gt;      with:
&lt;/div&gt;&lt;div id="code8.60" class="lines"&gt;&lt;a href="#code8.60"&gt;&lt;/a&gt;        python-version: 3.x
&lt;/div&gt;&lt;div id="code8.61" class="lines"&gt;&lt;a href="#code8.61"&gt;&lt;/a&gt;    - name: Install dependencies
&lt;/div&gt;&lt;div id="code8.62" class="lines"&gt;&lt;a href="#code8.62"&gt;&lt;/a&gt;      run: |
&lt;/div&gt;&lt;div id="code8.63" class="lines"&gt;&lt;a href="#code8.63"&gt;&lt;/a&gt;        python -m pip install --upgrade pip
&lt;/div&gt;&lt;div id="code8.64" class="lines"&gt;&lt;a href="#code8.64"&gt;&lt;/a&gt;        pip install -r requirements.txt
&lt;/div&gt;&lt;div id="code8.65" class="lines"&gt;&lt;a href="#code8.65"&gt;&lt;/a&gt;    - name: Generate the website
&lt;/div&gt;&lt;div id="code8.66" class="lines"&gt;&lt;a href="#code8.66"&gt;&lt;/a&gt;      run: |
&lt;/div&gt;&lt;div id="code8.67" class="lines"&gt;&lt;a href="#code8.67"&gt;&lt;/a&gt;        ls -laR content/
&lt;/div&gt;&lt;div id="code8.68" class="lines"&gt;&lt;a href="#code8.68"&gt;&lt;/a&gt;        rm -rf output/*
&lt;/div&gt;&lt;div id="code8.69" class="lines"&gt;&lt;a href="#code8.69"&gt;&lt;/a&gt;        ls -la output/
&lt;/div&gt;&lt;div id="code8.70" class="lines"&gt;&lt;a href="#code8.70"&gt;&lt;/a&gt;        TIMEZONE=$(sed -nE 's|^\s*TIMEZONE\s*=\s*['&amp;quot;'&amp;quot;'&amp;quot;]([^'&amp;quot;'&amp;quot;'&amp;quot;]+)['&amp;quot;'&amp;quot;'&amp;quot;].*|\1|;T;p' pelicanconf.py)
&lt;/div&gt;&lt;div id="code8.71" class="lines"&gt;&lt;a href="#code8.71"&gt;&lt;/a&gt;        TZ=&amp;quot;${TIMEZONE:-UTC}&amp;quot; pelican
&lt;/div&gt;&lt;div id="code8.72" class="lines"&gt;&lt;a href="#code8.72"&gt;&lt;/a&gt;    - name: Publish to GitHub Pages
&lt;/div&gt;&lt;div id="code8.73" class="lines"&gt;&lt;a href="#code8.73"&gt;&lt;/a&gt;      env:
&lt;/div&gt;&lt;div id="code8.74" class="lines"&gt;&lt;a href="#code8.74"&gt;&lt;/a&gt;        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
&lt;/div&gt;&lt;div id="code8.75" class="lines"&gt;&lt;a href="#code8.75"&gt;&lt;/a&gt;      run: |
&lt;/div&gt;&lt;div id="code8.76" class="lines"&gt;&lt;a href="#code8.76"&gt;&lt;/a&gt;        cd output
&lt;/div&gt;&lt;div id="code8.77" class="lines"&gt;&lt;a href="#code8.77"&gt;&lt;/a&gt;        git config --local user.email &amp;quot;action@github.com&amp;quot;
&lt;/div&gt;&lt;div id="code8.78" class="lines"&gt;&lt;a href="#code8.78"&gt;&lt;/a&gt;        git config --local user.name &amp;quot;GitHub Action&amp;quot;
&lt;/div&gt;&lt;div id="code8.79" class="lines"&gt;&lt;a href="#code8.79"&gt;&lt;/a&gt;        if output=$(git status --porcelain) &amp;amp;&amp;amp; [ -z &amp;quot;$output&amp;quot; ]; then
&lt;/div&gt;&lt;div id="code8.80" class="lines"&gt;&lt;a href="#code8.80"&gt;&lt;/a&gt;          echo &amp;quot;No new content was generated, exiting gracefully&amp;quot;
&lt;/div&gt;&lt;div id="code8.81" class="lines"&gt;&lt;a href="#code8.81"&gt;&lt;/a&gt;        else 
&lt;/div&gt;&lt;div id="code8.82" class="lines"&gt;&lt;a href="#code8.82"&gt;&lt;/a&gt;          git add -A
&lt;/div&gt;&lt;div id="code8.83" class="lines"&gt;&lt;a href="#code8.83"&gt;&lt;/a&gt;          git commit -m &amp;quot;Updated content on $(date)&amp;quot;
&lt;/div&gt;&lt;div id="code8.84" class="lines"&gt;&lt;a href="#code8.84"&gt;&lt;/a&gt;          eval $(ssh-agent)
&lt;/div&gt;&lt;div id="code8.85" class="lines"&gt;&lt;a href="#code8.85"&gt;&lt;/a&gt;          echo &amp;quot;$DEPLOY_KEY&amp;quot; | ssh-add -t 5m /dev/stdin
&lt;/div&gt;&lt;div id="code8.86" class="lines"&gt;&lt;a href="#code8.86"&gt;&lt;/a&gt;          ssh-add -l
&lt;/div&gt;&lt;div id="code8.87" class="lines"&gt;&lt;a href="#code8.87"&gt;&lt;/a&gt;          git push git@github.com:galaxy4public/galaxy4public.github.io.git
&lt;/div&gt;&lt;div id="code8.88" class="lines"&gt;&lt;a href="#code8.88"&gt;&lt;/a&gt;          ssh-add -D
&lt;/div&gt;&lt;div id="code8.89" class="lines"&gt;&lt;a href="#code8.89"&gt;&lt;/a&gt;          ssh-agent -k
&lt;/div&gt;&lt;div id="code8.90" class="lines"&gt;&lt;a href="#code8.90"&gt;&lt;/a&gt;        fi
&lt;/div&gt;&lt;div id="code8.91" class="lines"&gt;&lt;a href="#code8.91"&gt;&lt;/a&gt;        cd ..
&lt;/div&gt;&lt;div id="code8.92" class="lines"&gt;&lt;a href="#code8.92"&gt;&lt;/a&gt;        echo Completed&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is a copy of my live GitHub Action for deploying my blog that you are most
likely reading right now, and I decided not to edit anything, so if you just
want to re-use it you will need to replace a few things, namely:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;en_AU.UTF-8&lt;/code&gt; =&amp;gt; to a locale you are using (you can run &lt;code&gt;locale -a&lt;/code&gt; if you
    are running Linux to see the list of locales available on your system);&lt;/li&gt;
&lt;li&gt;&lt;code&gt;content&lt;/code&gt; =&amp;gt; you may need to change that to the name of your content
    directory (if you did not use the default name);&lt;/li&gt;
&lt;li&gt;&lt;code&gt;themes/mind-drops/content&lt;/code&gt; =&amp;gt; you will need to drop this line since it is
    my theme&amp;rsquo;s content directory and you would not have it;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;galaxy4public/galaxy4public.github.io&lt;/code&gt; =&amp;gt; to &lt;strong&gt;&amp;lt;your_username/your_blog_repo_name&amp;gt;&lt;/strong&gt;, obviously :)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This being sorted, let&amp;rsquo;s look a bit more closely to understand how this GitHub
Action is structured and what each step is doing.&lt;/p&gt;
&lt;p&gt;It all starts with the definition of the action itself and the conditions of
how it is triggered and how does it run.&lt;/p&gt;
&lt;p&gt;[I ran out of time for this session :(, will update the post with more details shortly ]&lt;/p&gt;</content><category term="blog"></category><category term="pelican"></category><category term="blog"></category><category term="github"></category></entry><entry><title>Wrap indicator in &lt;pre&gt; blocks</title><link href="https://dmitry.khlebnikov.net/2020/05/10/wrap-indicator-in-pre-blocks/" rel="alternate"></link><published>2020-05-10T21:00:00+10:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2020-05-10:/2020/05/10/wrap-indicator-in-pre-blocks/</id><summary type="html">&lt;p&gt;I am not a front-end developer, not a UI designer, nor a UX guru, but I am an
engineer, so when I face a puzzle worth solving my brain switches on and I
cannot let it go until I find a satisfactory solution to the puzzle.&lt;/p&gt;
&lt;p&gt;My blog heavily relies on me sharing session dumps and file excerpts using the
code blocks.  I am using &lt;a href="https://prismjs.com"&gt;PrismJS&lt;/a&gt; to highlight syntax in these blocks.  However,
after a while I found that there is one thing that really irritates me: these
code blocks are not designed to be truly responsive, for instance &amp;ndash; when &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I am not a front-end developer, not a UI designer, nor a UX guru, but I am an
engineer, so when I face a puzzle worth solving my brain switches on and I
cannot let it go until I find a satisfactory solution to the puzzle.&lt;/p&gt;
&lt;p&gt;My blog heavily relies on me sharing session dumps and file excerpts using the
code blocks.  I am using &lt;a href="https://prismjs.com"&gt;PrismJS&lt;/a&gt; to highlight syntax in these blocks.  However,
after a while I found that there is one thing that really irritates me: these
code blocks are not designed to be truly responsive, for instance &amp;ndash; when a
line wraps there is no easy to spot indication that such a wrap happened.&lt;/p&gt;
&lt;p&gt;I quick search on the topic highlighted that this is kind of an unresolved
issue and I found just &lt;a href="https://blog.iany.me/2012/02/css-line-wrap-indicator/"&gt;&lt;em&gt;one&lt;/em&gt; blog post&lt;/a&gt; from 2012 by Ian Yang
after I already implemented my solution.&lt;/p&gt;
&lt;p&gt;The approaches are quite close, but I like mine better since I think it is more
semantically correct (I am using &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; instead of &lt;code&gt;&amp;lt;span&amp;gt;&lt;/code&gt; and I did a bit
deeper research into how to make it universal).&lt;/p&gt;
&lt;p&gt;So, below I present you with my version of the solution and I would appreciate
any feedback you may have, especially if it could help to find a nicer solution
in the end.&lt;/p&gt;
&lt;p&gt;Before we dive into details on how I come up with the solution, feel free to
play with the basic demo &amp;ndash; try to resize the box by dragging the bottom right
corner and see how the text inside responds (if you are using anything than
the Chrome browser you may be out of luck with the resizable &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt;s, sorry):&lt;/p&gt;
&lt;div class="demo resizable"&gt;
    &lt;style&gt;
        div[class^='demo'].resizable {
            position: relative;
            overflow: auto;
            resize: both;
            border: solid 0.25em rgba(0,0,0,0.5);
            max-width: 100%;
            min-width: 4.1em;
            padding: 0.6em 1.2em;
            border-radius: 0.5em;
            margin-bottom: 1.5em;
        }

        div[class^='demo'] pre {
            word-break: break-word;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            font-size: 1em;
            line-height: 1.2;
        }

        div.demo pre div.line {
            position: relative;
            min-height: 1em;
        }

        div.demo pre div.line::after {
            content: '';
            position: absolute;
            display: block;
            font-family: inherit;
            font-size: inherit;
            width: 1.2em;
            right: -1.2em;
            background-size: 1.2em 1.2em;
            margin-bottom: 1.2em;
            clip: rect(1.2em 1.2em 100vh 0);
            height: 100%;
            bottom: 0;
            opacity: .5;
            background:
                url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
                no-repeat repeat;
        }
    &lt;/style&gt;
    &lt;pre&gt;&lt;div class="line"&gt;This is quite a long line.  It is long enough to ensure that it will wrap no matter how big your screen is.  Well, it is possible that in 20 years from the moment I type this humanity will invent a medium that could display the whole line with no breaks, but until then it should be good enough for the demonstration purposes.&lt;/div&gt;&lt;div class="line"&gt;A very short line.&lt;/div&gt;&lt;div class="line"&gt;The short line above is used to demonstrate that it stays clear of additional info when its neighbour lines are wrapped.&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;I hope that demo gods were not angry at me and the demo above worked for you as
expected, so if you want to understand how it works let&amp;rsquo;s dive under the hood
of this solution :)&lt;/p&gt;
&lt;h2 id="preparation"&gt;Preparation&lt;/h2&gt;
&lt;p&gt;First of all, we need to define what we have and what we want to achieve &amp;ndash; it
helps to stay on course, to understand when we reached a solution, and to
assess how good the solution is:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;we have one or more code blocks expressed through the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; HTML element;&lt;/li&gt;
&lt;li&gt;these code blocks may have continuous white space that we want to preserve;&lt;/li&gt;
&lt;li&gt;our page layout is flexible and there are no guarantees that the width of a
    particular viewport (a window through which a browser renders the visible
    part of the page) is enough to display the whole line of code;&lt;/li&gt;
&lt;li&gt;we want to ensure that layout does not break when a very long code line is
    encountered, so we expect that line to be wrapped to the next line upon
    hitting width of the containing box;&lt;/li&gt;
&lt;li&gt;we need to present the reader (a user who is consuming information) a
    visual indicator that the line was wrapped;&lt;/li&gt;
&lt;li&gt;we also want the syntax highlighter (such as &lt;a href="https://prismjs.com"&gt;PrismJS&lt;/a&gt; in my case) not to be
    affected by whatever we come up with.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I think the above quite a solid definition of the goals and requirements for
our little project.  It is time to assess the artefacts we have and what we can
do with them.&lt;/p&gt;
&lt;h2 id="analysis"&gt;Analysis&lt;/h2&gt;
&lt;p&gt;Our primary artefact is the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; element.  It contains the information we
want to share with the world and we want to do this in the most easy to digest
way.&lt;/p&gt;
&lt;p&gt;By default, the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; element is quite a simplistic container.  Its semantic
meaning dictates that the content preserves the original formatting (such as
amount and type of white space on the lines).  The element also provides some
basic functionality: you can define the size of the container and browsers are
supposed to present you with controls to scroll the content if it does not fit
the size of the container.&lt;/p&gt;
&lt;p&gt;The following is just such bare almost not styled &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; block wrapped into a
resizable &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; container, so you could play with the dimensions of the
container (in order to preserve the layout I am keeping the wrapping styles, so
the box would fit into the layout):&lt;/p&gt;
&lt;div class="demo1 resizable"&gt;
    &lt;pre&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should
be able to resize it by dragging the bottom right corner (but if you are
using anything other than Chrome you may be out of luck with the resizing).

This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;However, if you played with the above container you may have noticed that at
some point all lines are so mixed up together and it is really hard to tell
that the original text comprised of five separate lines.&lt;/p&gt;
&lt;p&gt;Unfortunately, the CSS standards do not provide any selectors or
pseudo-elements to anchor the soft breaks.  All we can do with the CSS
selectors on the contained text is to choose the first letter (with
&lt;code&gt;:first-letter&lt;/code&gt;) and the first line of the text inside the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; element
(with &lt;code&gt;:first-line&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;This is not good enough if you ask me.  I would love to see some CSS selectors
for soft breaks in the future iterations of the standard, but we are not there
yet, so we have to work with what we have got.&lt;/p&gt;
&lt;p&gt;And all we have is the standard &lt;a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Model/Introduction_to_the_CSS_box_model" title="Introduction to the CSS box model"&gt;CSS basic box model&lt;/a&gt; presentation focused
selectors such as &lt;code&gt;::before&lt;/code&gt; and &lt;code&gt;::after&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So, if we look how text is rendered inside the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; block (browser&amp;rsquo;s
DevTools is a really good tool to do the observations, by the way) we will
notice that the browser considers the entire text as a single entity &amp;ndash; there
are no lines or anything, just a blob of text.&lt;/p&gt;
&lt;p&gt;Therefore, the first piece of the puzzle would be to introduce something that
could make the distinction between different lines of text possible.&lt;/p&gt;
&lt;p&gt;Assuming that we can solve the above issue with introducing lines, the next
step would be to display a marker on the right side of the line.  That marker
should follow the height of the line box as the line wraps.&lt;/p&gt;
&lt;p&gt;Finally, we will need to figure out how not to display the marker on the last
line of the wrapped multiline text to denote the end of wrapped line.&lt;/p&gt;
&lt;h2 id="implementation"&gt;Implementation&lt;/h2&gt;
&lt;p&gt;Since the &lt;a href="https://html.spec.whatwg.org/multipage/grouping-content.html#the-pre-element"&gt;definition of the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; element&lt;/a&gt; only stipulates that the content of
the element is pre-formatted with white space we can use other tags inside,
e.g. we can wrap each physical line (a line that is terminated by a newline
character) in a block element such as &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s see how it looks on our sample &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; block when we wrap each physical
line in &lt;code&gt;&amp;lt;div class="line"&amp;gt;&lt;/code&gt;&amp;hellip;&lt;code&gt;&amp;lt;/div&amp;gt;&lt;/code&gt;.  Keep in mind that &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; is a block
element, so in order not to introduce unintended line breaks we need to ensure
that every newline character in the original text except the very first one is
replaced with the combination of the closing and opening tags such as
&lt;code&gt;&amp;lt;/div&amp;gt;&amp;lt;div class="line"&amp;gt;&lt;/code&gt;, below is the result of such a change on our sample:&lt;/p&gt;
&lt;div class="demo2 resizable"&gt;
&lt;pre&gt;&lt;div class="line"&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should&lt;/div&gt;&lt;div class="line"&gt;be able to resize it by dragging the bottom right corner (but if you are&lt;/div&gt;&lt;div class="line"&gt;using anything than Chrome you may be out of luck with the resizing).&lt;/div&gt;&lt;div class="line"&gt;&lt;/div&gt;&lt;div class="line"&gt;This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Visually, it is almost exactly the same as the original sample we presented in
the &amp;ldquo;Analysis&amp;rdquo; section, however there is a couple of differences.&lt;/p&gt;
&lt;p&gt;The first one is visual and is obvious: the empty line (the fourth line of the
sample) has collapsed into nothing.  This is an undesired side effect and the
reason for that is that the corresponding &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; block has no content, hence
it has zero height.  We can fix it by defining the &lt;code&gt;min-height&lt;/code&gt; attribute for
out &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt;s defining line boundaries.&lt;/p&gt;
&lt;p&gt;The second difference is not so obvious, but if you inspect any line of this
&lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; block using your browser&amp;rsquo;s DevTools you will see that now we can
differentiate between lines (when you walk through the DOM in your DevTools
your browser will highlight the corresponding line inside the &lt;code&gt;&amp;lt;pre&amp;gt;&lt;/code&gt; block and
this is what we wanted to achieve at this step!&lt;/p&gt;
&lt;p&gt;The next step is to display a marker on the right side of the line and that
marker should occupy the exactly the same height as the line block we are
attaching it to.  Well, this can be easily done with the &lt;code&gt;::after&lt;/code&gt;
pseudo-element:&lt;/p&gt;
&lt;pre id="demo3" class="highlight line-numbers"&gt;&lt;code class="language-css"&gt;&lt;div id="demo3.1" class="lines"&gt;&lt;a href="#demo3.1"&gt;&lt;/a&gt;pre div.line {
&lt;/div&gt;&lt;div id="demo3.2" class="lines"&gt;&lt;a href="#demo3.2"&gt;&lt;/a&gt;    position: relative; /* so we could position the child */
&lt;/div&gt;&lt;div id="demo3.3" class="lines"&gt;&lt;a href="#demo3.3"&gt;&lt;/a&gt;    min-height: 1em;    /* to avoid collapsing empty lines */
&lt;/div&gt;&lt;div id="demo3.4" class="lines"&gt;&lt;a href="#demo3.4"&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div id="demo3.5" class="lines"&gt;&lt;a href="#demo3.5"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="demo3.6" class="lines"&gt;&lt;a href="#demo3.6"&gt;&lt;/a&gt;pre div.line::after {
&lt;/div&gt;&lt;div id="demo3.7" class="lines"&gt;&lt;a href="#demo3.7"&gt;&lt;/a&gt;    content: '';        /* we need content for pseudo elements */
&lt;/div&gt;&lt;div id="demo3.8" class="lines"&gt;&lt;a href="#demo3.8"&gt;&lt;/a&gt;    position: absolute;
&lt;/div&gt;&lt;div id="demo3.9" class="lines"&gt;&lt;a href="#demo3.9"&gt;&lt;/a&gt;    display: block;
&lt;/div&gt;&lt;div id="demo3.10" class="lines"&gt;&lt;a href="#demo3.10"&gt;&lt;/a&gt;    width: 1em;     /* without width it will be invisible */
&lt;/div&gt;&lt;div id="demo3.11" class="lines"&gt;&lt;a href="#demo3.11"&gt;&lt;/a&gt;    height: 100%;       /* to match the height of the parent */
&lt;/div&gt;&lt;div id="demo3.12" class="lines"&gt;&lt;a href="#demo3.12"&gt;&lt;/a&gt;    top: 0;
&lt;/div&gt;&lt;div id="demo3.13" class="lines"&gt;&lt;a href="#demo3.13"&gt;&lt;/a&gt;    right: -1em;
&lt;/div&gt;&lt;div id="demo3.14" class="lines"&gt;&lt;a href="#demo3.14"&gt;&lt;/a&gt;    background-color: blue; /* temporary, to make it visible */
&lt;/div&gt;&lt;div id="demo3.15" class="lines"&gt;&lt;a href="#demo3.15"&gt;&lt;/a&gt;}&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that we also introduced &lt;code&gt;position: relative&lt;/code&gt; to our &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt;&amp;lsquo;s.  It is
needed since if we want to position our pseudo-element relative to its parent,
the parent needs to have the position attribute set to anything but &lt;code&gt;static&lt;/code&gt;.
In our context, &lt;code&gt;relative&lt;/code&gt; is the desired positioning for the &lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; element.
The corresponding rendered sample with the above stylesheet applied follows:&lt;/p&gt;
&lt;div class="demo3 resizable"&gt;
    &lt;style&gt;
        div.demo3 pre div.line {
            min-height: 1em;
            position: relative;
        }

        div.demo3 pre div.line::after {
            content: '';
            position: absolute;
            display: block;
            width: 1em;
            height: 100%;
            top: 0;
            right: -1em;
            background-color: blue;
        }
    &lt;/style&gt;
&lt;pre&gt;&lt;div class="line"&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should&lt;/div&gt;&lt;div class="line"&gt;be able to resize it by dragging the bottom right corner (but if you are&lt;/div&gt;&lt;div class="line"&gt;using anything than Chrome you may be out of luck with the resizing).&lt;/div&gt;&lt;div class="line"&gt;&lt;/div&gt;&lt;div class="line"&gt;This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;So far so good!  We have a blue coloured strip hanging on the right side just
next to our text.  Let&amp;rsquo;s style it a bit so it looks more appealing.&lt;/p&gt;
&lt;p&gt;We have a couple of options here:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;we can just use a transparent bitmap image with the desired marker;&lt;/li&gt;
&lt;li&gt;we can leverage SVG as the source of the image.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The issue I have with transparent bitmap images is that they are not very
responsive: to accomodate to all the possible resolutions I would end up with
creating many bitmaps of different sizes to ensure that the marker looks good
no matter what device is rendering the page.&lt;/p&gt;
&lt;p&gt;On the other hand, the SVG graphics was not well supported on some browsers
like Internet Explorer 6, etc. &amp;ndash; The support is much better now, hence I would
choose SVG everytime.&lt;/p&gt;
&lt;p&gt;Ideally, I did not want to use an image, but I could not figure out how I could
put a repeating text block next to my lines, hence I found the following
compromise (this is the content of the SVG file I created):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-svg"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;&amp;lt;svg xmlns=&amp;quot;http://www.w3.org/2000/svg&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;        version=&amp;quot;1.1&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;        viewBox=&amp;quot;0 0 24 24&amp;quot;&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    &amp;lt;text x=&amp;quot;0&amp;quot; y=&amp;quot;19&amp;quot;&amp;gt;&amp;amp;#x23ce;&amp;lt;/text&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;&amp;lt;/svg&amp;gt;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first two lines are mandatory and describe to a browser that it works with
an SVG image file.&lt;/p&gt;
&lt;p&gt;The third line (&lt;code&gt;viewBox=&lt;/code&gt;) is really important since it allows the SVG image
to be scaleable, basically it says that the dimensions of the image are 25 by
25 units (the units are abstract, but you may think of them as pixels if it
makes it easier).&lt;/p&gt;
&lt;p&gt;Finally, the &lt;code&gt;&amp;lt;text&amp;gt;&lt;/code&gt; element puts a text box with just a single Unicode
character for the return symbol (&amp;#x23ce;), since I think it is quite an
adequate symbol to represent a line wrap point.&lt;/p&gt;
&lt;p&gt;There are different ways how you can incorporate an SVG image into CSS rule,
but since the content of the SVG file is so small and I did not want to host it
externally (it would be an additional fetch request and more maintenance), I
just did the following:&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ cat nl.svg 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;&amp;lt;svg xmlns=&amp;quot;http://www.w3.org/2000/svg&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;        version=&amp;quot;1.1&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;        viewBox=&amp;quot;0 0 24 24&amp;quot;&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    &amp;lt;text x=&amp;quot;0&amp;quot; y=&amp;quot;19&amp;quot;&amp;gt;&amp;amp;#x23ce;&amp;lt;/text&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;&amp;lt;/svg&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ sed -n '1{h;d};$!H;${H;x;s,\s\+, ,g;s,&amp;gt;\s*&amp;lt;,&amp;gt;&amp;lt;,g;p}' nl.svg | base64 -w 0 ; echo
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In other words, I removed all the white space, then deleted all line breaks, so
I got a single line SVG body, and I converted it to Base64.  The resulting line
is usable as the inline definition of an image.  Let&amp;rsquo;s update our stylesheet
with the new values (we just replaced the last line to change the &lt;code&gt;background&lt;/code&gt;
to &lt;code&gt;background-image&lt;/code&gt;) and added dimensions for the background itself:&lt;/p&gt;
&lt;pre id="demo4" class="highlight line-numbers"&gt;&lt;code class="language-css"&gt;&lt;div id="demo4.1" class="lines"&gt;&lt;a href="#demo4.1"&gt;&lt;/a&gt;pre div.line {
&lt;/div&gt;&lt;div id="demo4.2" class="lines"&gt;&lt;a href="#demo4.2"&gt;&lt;/a&gt;    position: relative; /* so we could position the child */
&lt;/div&gt;&lt;div id="demo4.3" class="lines"&gt;&lt;a href="#demo4.3"&gt;&lt;/a&gt;    min-height: 1em;    /* to avoid collapsing empty lines */
&lt;/div&gt;&lt;div id="demo4.4" class="lines"&gt;&lt;a href="#demo4.4"&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div id="demo4.5" class="lines"&gt;&lt;a href="#demo4.5"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="demo4.6" class="lines"&gt;&lt;a href="#demo4.6"&gt;&lt;/a&gt;pre div.line::after {
&lt;/div&gt;&lt;div id="demo4.7" class="lines"&gt;&lt;a href="#demo4.7"&gt;&lt;/a&gt;    content: '';        /* we need content for pseudo elements */
&lt;/div&gt;&lt;div id="demo4.8" class="lines"&gt;&lt;a href="#demo4.8"&gt;&lt;/a&gt;    position: absolute;
&lt;/div&gt;&lt;div id="demo4.9" class="lines"&gt;&lt;a href="#demo4.9"&gt;&lt;/a&gt;    display: block;
&lt;/div&gt;&lt;div id="demo4.10" class="lines"&gt;&lt;a href="#demo4.10"&gt;&lt;/a&gt;    width: 1em;     /* without width it will be invisible */
&lt;/div&gt;&lt;div id="demo4.11" class="lines"&gt;&lt;a href="#demo4.11"&gt;&lt;/a&gt;    height: 100%;       /* to match the height of the parent */
&lt;/div&gt;&lt;div id="demo4.12" class="lines"&gt;&lt;a href="#demo4.12"&gt;&lt;/a&gt;    top: 0;
&lt;/div&gt;&lt;div id="demo4.13" class="lines"&gt;&lt;a href="#demo4.13"&gt;&lt;/a&gt;    right: -1em;
&lt;/div&gt;&lt;div id="demo4.14" class="lines"&gt;&lt;a href="#demo4.14"&gt;&lt;/a&gt;    background-image:
&lt;/div&gt;&lt;div id="demo4.15" class="lines"&gt;&lt;a href="#demo4.15"&gt;&lt;/a&gt;        url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
&lt;/div&gt;&lt;div id="demo4.16" class="lines"&gt;&lt;a href="#demo4.16"&gt;&lt;/a&gt;        no-repeat repeat;
&lt;/div&gt;&lt;div id="demo4.17" class="lines"&gt;&lt;a href="#demo4.17"&gt;&lt;/a&gt;    background-size: 1em 1em;
&lt;/div&gt;&lt;div id="demo4.18" class="lines"&gt;&lt;a href="#demo4.18"&gt;&lt;/a&gt;}&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;div class="demo4 resizable"&gt;
    &lt;style&gt;
        div.demo4 pre div.line {
            position: relative;
            min-height: 1em;
        }

        div.demo4 pre div.line::after {
            content: '';
            position: absolute;
            display: block;
            width: 1em;
            height: 100%;
            top: 0;
            right: -1em;
            background:
                url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
                no-repeat repeat;
            background-size: 1em 1em;
        }
    &lt;/style&gt;
&lt;pre&gt;&lt;div class="line"&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should&lt;/div&gt;&lt;div class="line"&gt;be able to resize it by dragging the bottom right corner (but if you are&lt;/div&gt;&lt;div class="line"&gt;using anything than Chrome you may be out of luck with the resizing).&lt;/div&gt;&lt;div class="line"&gt;&lt;/div&gt;&lt;div class="line"&gt;This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Look at that, it is almost shaping into what we want :).  However, something is
not right &amp;ndash; the alignment of the markers to the corresponding lines is nowhere
to be seen.  It is, like, they are of different sizes despite that the
&lt;code&gt;font-size&lt;/code&gt; property for both of them is the same.  Hmm.&lt;/p&gt;
&lt;p&gt;If we recall that &lt;a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Model/Introduction_to_the_CSS_box_model" title="Introduction to the CSS box model"&gt;CSS basic model document&lt;/a&gt; we will discover in the very last
paragraph that:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a name="CSS_basic_model_line_height" href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Model/Introduction_to_the_CSS_box_model"&gt;&lt;/a&gt;
note that for non-replaced inline elements, the amount of space taken up (the
contribution to the height of the line) is determined by the line-height
property&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Is this our hint?  Let&amp;rsquo;s try to explicitly set the &lt;code&gt;line-height&lt;/code&gt; property for
our lines (reading documentation you may find that the default value is
&lt;code&gt;normal&lt;/code&gt; and you can also find that &lt;code&gt;normal&lt;/code&gt; equals &lt;code&gt;1.2&lt;/code&gt; for the majority of
browsers, but relying on that, I think is a bad idea).  We also need to adjust
our markers with the new information we have got:&lt;/p&gt;
&lt;pre id="demo5" class="highlight"&gt;&lt;code class="language-css"&gt;&lt;div id="demo5.1" class="lines"&gt;&lt;a href="#demo5.1"&gt;&lt;/a&gt;pre div.line {
&lt;/div&gt;&lt;div id="demo5.2" class="lines"&gt;&lt;a href="#demo5.2"&gt;&lt;/a&gt;    position: relative; /* so we could position the child */
&lt;/div&gt;&lt;div id="demo5.3" class="lines"&gt;&lt;a href="#demo5.3"&gt;&lt;/a&gt;    min-height: 1em;    /* to avoid collapsing empty lines */
&lt;/div&gt;&lt;div id="demo5.4" class="lines"&gt;&lt;a href="#demo5.4"&gt;&lt;/a&gt;    line-height: 1.2;   /* set the height explicitly */
&lt;/div&gt;&lt;div id="demo5.5" class="lines"&gt;&lt;a href="#demo5.5"&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div id="demo5.6" class="lines"&gt;&lt;a href="#demo5.6"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="demo5.7" class="lines"&gt;&lt;a href="#demo5.7"&gt;&lt;/a&gt;pre div.line::after {
&lt;/div&gt;&lt;div id="demo5.8" class="lines"&gt;&lt;a href="#demo5.8"&gt;&lt;/a&gt;    content: '';        /* we need content for pseudo elements */
&lt;/div&gt;&lt;div id="demo5.9" class="lines"&gt;&lt;a href="#demo5.9"&gt;&lt;/a&gt;    position: absolute;
&lt;/div&gt;&lt;div id="demo5.10" class="lines"&gt;&lt;a href="#demo5.10"&gt;&lt;/a&gt;    display: block;
&lt;/div&gt;&lt;div id="demo5.11" class="lines"&gt;&lt;a href="#demo5.11"&gt;&lt;/a&gt;    width: 1.2em;       /* without width it will be invisible */
&lt;/div&gt;&lt;div id="demo5.12" class="lines"&gt;&lt;a href="#demo5.12"&gt;&lt;/a&gt;    height: 100%;       /* to match the height of the parent */
&lt;/div&gt;&lt;div id="demo5.13" class="lines"&gt;&lt;a href="#demo5.13"&gt;&lt;/a&gt;    top: 0;
&lt;/div&gt;&lt;div id="demo5.14" class="lines"&gt;&lt;a href="#demo5.14"&gt;&lt;/a&gt;    right: -1.2em;
&lt;/div&gt;&lt;div id="demo5.15" class="lines"&gt;&lt;a href="#demo5.15"&gt;&lt;/a&gt;    background-image:
&lt;/div&gt;&lt;div id="demo5.16" class="lines"&gt;&lt;a href="#demo5.16"&gt;&lt;/a&gt;        url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
&lt;/div&gt;&lt;div id="demo5.17" class="lines"&gt;&lt;a href="#demo5.17"&gt;&lt;/a&gt;        no-repeat repeat;
&lt;/div&gt;&lt;div id="demo5.18" class="lines"&gt;&lt;a href="#demo5.18"&gt;&lt;/a&gt;    background-size: 1.2em 1.2em;
&lt;/div&gt;&lt;div id="demo5.19" class="lines"&gt;&lt;a href="#demo5.19"&gt;&lt;/a&gt;}&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;div class="demo5 resizable"&gt;
    &lt;style&gt;
        div.demo5 pre div.line {
            position: relative;
            min-height: 1em;
            line-height: 1.2;
        }

        div.demo5 pre div.line::after {
            content: '';
            position: absolute;
            display: block;
            width: 1.2em;
            height: 100%;
            top: 0;
            right: -1.2em;
            background:
                url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
                no-repeat repeat;
            background-size: 1.2em 1.2em;
        }
    &lt;/style&gt;
&lt;pre&gt;&lt;div class="line"&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should&lt;/div&gt;&lt;div class="line"&gt;be able to resize it by dragging the bottom right corner (but if you are&lt;/div&gt;&lt;div class="line"&gt;using anything than Chrome you may be out of luck with the resizing).&lt;/div&gt;&lt;div class="line"&gt;&lt;/div&gt;&lt;div class="line"&gt;This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This is an improvement, is not it?  So we just need some final touches to call
it done:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;As it stands, we are showing the marker for the last part of the wrapped line, but we should not;&lt;/li&gt;
&lt;li&gt;The colour of the marker is too bright and matches the text colour of the line wrapping of which we are highlighting.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To address the latter a simple play with the &lt;code&gt;opacity&lt;/code&gt; attribute will suffice,
e.g. I think 50% transparency should make the marker less distracting.&lt;/p&gt;
&lt;p&gt;The former, however, requires some thinking.  Given that the post is already too long, I will just state that out of multiple options I had I chose the following: raise the background image by one &lt;code&gt;line-height&lt;/code&gt; from the bottom, and clip a square 1x1 &lt;code&gt;line-height&lt;/code&gt; at the top to compensate, as follows:&lt;/p&gt;
&lt;pre id="demo6" class="highlight"&gt;&lt;code class="language-css"&gt;&lt;div id="demo6.1" class="lines"&gt;&lt;a href="#demo6.1"&gt;&lt;/a&gt;pre div.line {
&lt;/div&gt;&lt;div id="demo6.2" class="lines"&gt;&lt;a href="#demo6.2"&gt;&lt;/a&gt;    position: relative; /* so we could position the child */
&lt;/div&gt;&lt;div id="demo6.3" class="lines"&gt;&lt;a href="#demo6.3"&gt;&lt;/a&gt;    min-height: 1em;    /* to avoid collapsing empty lines */
&lt;/div&gt;&lt;div id="demo6.4" class="lines"&gt;&lt;a href="#demo6.4"&gt;&lt;/a&gt;    line-height: 1.2;   /* set the height explicitly */
&lt;/div&gt;&lt;div id="demo6.5" class="lines"&gt;&lt;a href="#demo6.5"&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div id="demo6.6" class="lines"&gt;&lt;a href="#demo6.6"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="demo6.7" class="lines"&gt;&lt;a href="#demo6.7"&gt;&lt;/a&gt;pre div.line::after {
&lt;/div&gt;&lt;div id="demo6.8" class="lines"&gt;&lt;a href="#demo6.8"&gt;&lt;/a&gt;    content: '';        /* we need content for pseudo elements */
&lt;/div&gt;&lt;div id="demo6.9" class="lines"&gt;&lt;a href="#demo6.9"&gt;&lt;/a&gt;    position: absolute;
&lt;/div&gt;&lt;div id="demo6.10" class="lines"&gt;&lt;a href="#demo6.10"&gt;&lt;/a&gt;    display: block;
&lt;/div&gt;&lt;div id="demo6.11" class="lines"&gt;&lt;a href="#demo6.11"&gt;&lt;/a&gt;    width: 1.2em;       /* without width it will be invisible */
&lt;/div&gt;&lt;div id="demo6.12" class="lines"&gt;&lt;a href="#demo6.12"&gt;&lt;/a&gt;    height: 100%;       /* to match the height of the parent */
&lt;/div&gt;&lt;div id="demo6.13" class="lines"&gt;&lt;a href="#demo6.13"&gt;&lt;/a&gt;    bottom: 0;
&lt;/div&gt;&lt;div id="demo6.14" class="lines"&gt;&lt;a href="#demo6.14"&gt;&lt;/a&gt;    right: -1.2em;
&lt;/div&gt;&lt;div id="demo6.15" class="lines"&gt;&lt;a href="#demo6.15"&gt;&lt;/a&gt;    background-image:
&lt;/div&gt;&lt;div id="demo6.16" class="lines"&gt;&lt;a href="#demo6.16"&gt;&lt;/a&gt;        url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
&lt;/div&gt;&lt;div id="demo6.17" class="lines"&gt;&lt;a href="#demo6.17"&gt;&lt;/a&gt;        no-repeat repeat;
&lt;/div&gt;&lt;div id="demo6.18" class="lines"&gt;&lt;a href="#demo6.18"&gt;&lt;/a&gt;    background-size: 1.2em 1.2em;
&lt;/div&gt;&lt;div id="demo6.19" class="lines"&gt;&lt;a href="#demo6.19"&gt;&lt;/a&gt;    margin-bottom: 0;
&lt;/div&gt;&lt;div id="demo6.20" class="lines"&gt;&lt;a href="#demo6.20"&gt;&lt;/a&gt;    clip: rect(1.2em 1.2em 100vh 0);
&lt;/div&gt;&lt;div id="demo6.21" class="lines"&gt;&lt;a href="#demo6.21"&gt;&lt;/a&gt;    opacity: .5;
&lt;/div&gt;&lt;div id="demo6.22" class="lines"&gt;&lt;a href="#demo6.22"&gt;&lt;/a&gt;}&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The only tricky part in the added lines is the &lt;code&gt;clip: rect(1.2em 1.2em 100vh
0)&lt;/code&gt; line.  The &lt;code&gt;clip&lt;/code&gt; property defines the visible rectangle the browser should
preserve, but there is a conundrum: the height of the wrapped line is variable,
so we cannot deterministically set this.  The trick here is that it is highly
unlikely (on the border of completely impossible :) ) that the visible height
of the wrapped line would be bigger that the height of the viewport the user is
looking through.&lt;/p&gt;
&lt;p&gt;Therefore, we are setting the height of the clipped area to the height of the
viewport (&lt;code&gt;100vh&lt;/code&gt;), but this will be a rare edge case to actually utilise this
&amp;ndash; in the majority of cases the height of the clipping rectangle will be
limited by the height of the block containing the wrapped line.  Basically,
this is exactly what we want :).&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s see the final result in action:&lt;/p&gt;
&lt;div class="demo6 resizable"&gt;
    &lt;style&gt;
        div.demo6 pre div.line {
            position: relative;
            min-height: 1em;
            line-height: 1.2;
        }

        div.demo6 pre div.line::after {
            content: '';
            position: absolute;
            display: block;
            width: 1.2em;
            height: 100%;
            bottom: 0;
            right: -1.2em;
            background:
                url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
                no-repeat repeat;
            background-size: 1.2em 1.2em;
            margin-bottom: 1.2em;
            clip: rect(1.2em 1.2em 100vh 0);
            opacity: .5;
        }
    &lt;/style&gt;
&lt;pre&gt;&lt;div class="line"&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should&lt;/div&gt;&lt;div class="line"&gt;be able to resize it by dragging the bottom right corner (but if you are&lt;/div&gt;&lt;div class="line"&gt;using anything than Chrome you may be out of luck with the resizing).&lt;/div&gt;&lt;div class="line"&gt;&lt;/div&gt;&lt;div class="line"&gt;This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h2 id="bonus-round"&gt;Bonus Round&lt;/h2&gt;
&lt;p&gt;It should be mentioned, it is also possible to apply the same approach to the
left side of the lines with a bit of a twist.&lt;/p&gt;
&lt;pre id="demo7" class="highlight"&gt;&lt;code class="language-css"&gt;&lt;div id="demo7.1" class="lines"&gt;&lt;a href="#demo7.1"&gt;&lt;/a&gt;pre div.line {
&lt;/div&gt;&lt;div id="demo7.2" class="lines"&gt;&lt;a href="#demo7.2"&gt;&lt;/a&gt;    position: relative; /* so we could position the child */
&lt;/div&gt;&lt;div id="demo7.3" class="lines"&gt;&lt;a href="#demo7.3"&gt;&lt;/a&gt;    min-height: 1em;    /* to avoid collapsing empty lines */
&lt;/div&gt;&lt;div id="demo7.4" class="lines"&gt;&lt;a href="#demo7.4"&gt;&lt;/a&gt;    line-height: 1.2;   /* set the height explicitly */
&lt;/div&gt;&lt;div id="demo7.5" class="lines"&gt;&lt;a href="#demo7.5"&gt;&lt;/a&gt;    text-indent: -1.2em;    /* first line indent */
&lt;/div&gt;&lt;div id="demo7.6" class="lines"&gt;&lt;a href="#demo7.6"&gt;&lt;/a&gt;    padding-left: 1.2em;    /* padding for the line */
&lt;/div&gt;&lt;div id="demo7.7" class="lines"&gt;&lt;a href="#demo7.7"&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div id="demo7.8" class="lines"&gt;&lt;a href="#demo7.8"&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div id="demo7.9" class="lines"&gt;&lt;a href="#demo7.9"&gt;&lt;/a&gt;pre div.line::before {
&lt;/div&gt;&lt;div id="demo7.10" class="lines"&gt;&lt;a href="#demo7.10"&gt;&lt;/a&gt;    content: '';        /* we need content for pseudo elements */
&lt;/div&gt;&lt;div id="demo7.11" class="lines"&gt;&lt;a href="#demo7.11"&gt;&lt;/a&gt;    position: absolute;
&lt;/div&gt;&lt;div id="demo7.12" class="lines"&gt;&lt;a href="#demo7.12"&gt;&lt;/a&gt;    display: block;
&lt;/div&gt;&lt;div id="demo7.13" class="lines"&gt;&lt;a href="#demo7.13"&gt;&lt;/a&gt;    width: 1.2em;       /* without width it will be invisible */
&lt;/div&gt;&lt;div id="demo7.14" class="lines"&gt;&lt;a href="#demo7.14"&gt;&lt;/a&gt;    height: 100%;       /* to match the height of the parent */
&lt;/div&gt;&lt;div id="demo7.15" class="lines"&gt;&lt;a href="#demo7.15"&gt;&lt;/a&gt;    top: 0;
&lt;/div&gt;&lt;div id="demo7.16" class="lines"&gt;&lt;a href="#demo7.16"&gt;&lt;/a&gt;    left: 0;
&lt;/div&gt;&lt;div id="demo7.17" class="lines"&gt;&lt;a href="#demo7.17"&gt;&lt;/a&gt;    background:
&lt;/div&gt;&lt;div id="demo7.18" class="lines"&gt;&lt;a href="#demo7.18"&gt;&lt;/a&gt;        url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
&lt;/div&gt;&lt;div id="demo7.19" class="lines"&gt;&lt;a href="#demo7.19"&gt;&lt;/a&gt;        no-repeat repeat;
&lt;/div&gt;&lt;div id="demo7.20" class="lines"&gt;&lt;a href="#demo7.20"&gt;&lt;/a&gt;    background-size: 1.2em 1.2em;
&lt;/div&gt;&lt;div id="demo7.21" class="lines"&gt;&lt;a href="#demo7.21"&gt;&lt;/a&gt;    clip: rect(1.2em 1.2em 100vh 0);
&lt;/div&gt;&lt;div id="demo7.22" class="lines"&gt;&lt;a href="#demo7.22"&gt;&lt;/a&gt;    opacity: .5;
&lt;/div&gt;&lt;div id="demo7.23" class="lines"&gt;&lt;a href="#demo7.23"&gt;&lt;/a&gt;    transform: rotateY(180deg); /* mirror the arrow */
&lt;/div&gt;&lt;div id="demo7.24" class="lines"&gt;&lt;a href="#demo7.24"&gt;&lt;/a&gt;    transform-origin: left;
&lt;/div&gt;&lt;div id="demo7.25" class="lines"&gt;&lt;a href="#demo7.25"&gt;&lt;/a&gt;}&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The trick here is the play between &lt;code&gt;padding-left&lt;/code&gt; and &lt;code&gt;text-indent&lt;/code&gt; for the
&lt;code&gt;&amp;lt;div&amp;gt;&lt;/code&gt; element since &lt;code&gt;text-indent&lt;/code&gt; will be applied to the first line only
(effectively negating the padding set for the whole element), thus the rest of
wrapped line will be padded to make space for the marker, which we place as
usual with the clipping region to suppress it for the very first part of the
wrapped line.&lt;/p&gt;
&lt;p&gt;The result looks as follows (and I am actually torn which side I like better,
so, maybe, for my blog I may just go with the left-side solution):&lt;/p&gt;
&lt;div class="demo7 resizable"&gt;
    &lt;style&gt;
        div.demo7 pre div.line {
            position: relative;
            min-height: 1em;
            line-height: 1.2;
            text-indent: -1.2em;
            padding-left: 1.2em;
        }

        div.demo7 pre div.line::after {
            content: '';
            position: absolute;
            display: block;
            width: 1.2em;
            height: 100%;
            top: 0;
            left: 1em;
            background:
                url(data:image/svg+xml;charset=utf-8;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDI0IDI0Ij48dGV4dCB4PSIwIiB5PSIxOSI+JiN4MjNjZTs8L3RleHQ+PC9zdmc+Cg==)
                no-repeat repeat;
            background-size: 1.2em 1.2em;
            clip: rect(1.2em 1.2em 100vh 0);
            opacity: .5;
            transform: rotateY(180deg);
            transform-origin: left;
        }
    &lt;/style&gt;
&lt;pre&gt;&lt;div class="line"&gt;This is an example of a basic &amp;lt;pre&amp;gt; container.  You should&lt;/div&gt;&lt;div class="line"&gt;be able to resize it by dragging the bottom right corner (but if you are&lt;/div&gt;&lt;div class="line"&gt;using anything than Chrome you may be out of luck with the resizing).&lt;/div&gt;&lt;div class="line"&gt;&lt;/div&gt;&lt;div class="line"&gt;This line was made specifically long to trigger the line wrapping, so even those who are using a browser that cannot resize should be able to play with it :)&lt;/div&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;This idea for the &lt;code&gt;padding-left&lt;/code&gt; and &lt;code&gt;text-indent&lt;/code&gt; trick came from &lt;a href="http://shaunwagner.com/"&gt;C. Shaun
&amp;ldquo;Kainaw&amp;rdquo; Wagner&lt;/a&gt; when &lt;a href="https://stackoverflow.com/a/48936538/3316011"&gt;he answered a question about
the wrap indicators&lt;/a&gt; on Stack
Overflow (I am sure that it was known before, but this is where I learnt it).&lt;/p&gt;
&lt;h2 id="assessment-of-the-result"&gt;Assessment of the result&lt;/h2&gt;
&lt;p&gt;We started with the following requirement:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;these code blocks may have continuous white space that we want to preserve;&lt;/p&gt;
&lt;p&gt;Achieved: we did some changes to ensure that even empty lines are preseved.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;our page layout is flexible and there are no guarantees that the width of a
    particular viewport (a window through which a browser renders the visible
    part of the page) is enough to display the whole line of code&lt;/p&gt;
&lt;p&gt;Achieved: our blocks are flexible and if a line is too long it is wrapped
in an easy to understand way.  We proved it by ensuring that any block
can be dynamically resized.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;we want to ensure that layout does not break when a very long code line is
    encountered, so we expect that line to be wrapped to the next line upon
    hitting width of the containing box;&lt;/p&gt;
&lt;p&gt;Achieved: ditto as the previous item.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;we need to present the reader (a user who is consuming information) a
    visual indicator that the line was wrapped;&lt;/p&gt;
&lt;p&gt;Achieved: we got our dynamic markers showing when the line was wrapped.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;we also want the syntax highlighter (such as PrismJS in my case) not to be
    affected by whatever we come up with.&lt;/p&gt;
&lt;p&gt;&lt;del&gt;Unknown: I think it would be the material for another post, but I do not
expect a lot of issues since we only replaced the newline characters and
preserved the rest of lines intact.i&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;It turned out, that it was quite a hassle since none of plugins PrismJS
have for working with lines expect semantic markup of the lines inside the
block.  Therefore, I spent some time and came up with a plugin that does it
&amp;ldquo;right&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;It is highly likely, that my plugin will get merged into the Prism tree
(see the corresponding &lt;a href="https://github.com/PrismJS/prism/pull/2389"&gt;Pull Request&lt;/a&gt;).  However, if for some reason it would
not be or you need the functionality &amp;ldquo;here &amp;amp; now&amp;rdquo;, you can always get it
from my &lt;a href="https://github.com/galaxy4public/prism/tree/plugin-lines"&gt;fork of PrismJS&lt;/a&gt; (I will keep the &lt;code&gt;plugin-lines&lt;/code&gt; branch until it
is merged upstream).&lt;/p&gt;
&lt;p&gt;By the way, my Lines plugin is the primary working horse for all syntax
highlighted blocks on this site (so you have already seen it in action).&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I hope this helped you and you learnt something :).  If you have any
constructive feedback, I would appreciate it, specifically if you have ideas on
how to improve the presented solution.&lt;/p&gt;</content><category term="web design"></category><category term="html"></category><category term="css"></category><category term="design"></category></entry><entry><title>Migrating blog to Pelican</title><link href="https://dmitry.khlebnikov.net/2020/05/01/migrating-blog-to-pelican/" rel="alternate"></link><published>2020-05-01T20:00:00+10:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2020-05-01:/2020/05/01/migrating-blog-to-pelican/</id><summary type="html">&lt;p&gt;I had my blog site for more than a decade now, but until now I was not putting
any effort or thoughts into maintaining my audience or promoting the site.  It
was dormant for nearly a decade and I decided to rejuvenate it and start using
it as a platform I could leverage to share some ideas I think which are worth
sharing.&lt;/p&gt;
&lt;p&gt;Before I embarked on the journey of renovating the blog site I needed to set
some goals and requirements up, so I would be able to assess my progress and
estimate how much effort is required.  The &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I had my blog site for more than a decade now, but until now I was not putting
any effort or thoughts into maintaining my audience or promoting the site.  It
was dormant for nearly a decade and I decided to rejuvenate it and start using
it as a platform I could leverage to share some ideas I think which are worth
sharing.&lt;/p&gt;
&lt;p&gt;Before I embarked on the journey of renovating the blog site I needed to set
some goals and requirements up, so I would be able to assess my progress and
estimate how much effort is required.  The primary goal is already known at
this point: I need a tool that would allow me to easily share my ideas, grow
and nurture the audience, and accumulate knowledge in one place over time.&lt;/p&gt;
&lt;p&gt;I started to be increasingly unhappy with the &lt;a href="https://blogger.com"&gt;Blogger&lt;/a&gt;) platform: they were
changing things and as the result parts of my blog became defunct, e.g.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;in 2017, I lost the comment capability and did not have enough time to
    investigate and fix it,&lt;/li&gt;
&lt;li&gt;in 2018, my theme became incompatible with the new trends of the platform,&lt;/li&gt;
&lt;li&gt;and so on.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Therefore, the first requirement became to self-host my blog site, so I would
have full control over the software that is supporting the site.  This would
give the flexibility and determinism of how the site is configured and operates.&lt;/p&gt;
&lt;p&gt;The downside for hosting the site myself is that it would require ongoing
maintenance cost (primarily calculated in the time I spend on the maintenance)
and with my quite busy schedule I was not sure that I could afford it on the
ongoing basis.  So the second requirement became the low maintenance cost of
the solution.  Preferably, I wanted to make changes only when I needed to
change site&amp;rsquo;s functionality.&lt;/p&gt;
&lt;p&gt;I did some research and figured that a static website generator could be a
solution that addressed both aforementioned requirements assuming that I could
find a place where all underlying maintenance of the infrastructure and
application layer handled by somebody else (and, preferably, free of charge).&lt;/p&gt;
&lt;p&gt;There are plenty of static site generators (&lt;abbr title="Static Site Generator"&gt;SSG&lt;/abbr&gt;).  According to some articles,
there are more than 400 different &lt;abbr title="Static Site Generator"&gt;SSG&lt;/abbr&gt; at the moment, so the process of
selecting one that is right for you could be quite challenging.  I decided to
define what I would like to see in the generator I could use and be happy about
it before I start shopping around:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;should be written in one of the scripting languages that are widely adopted&lt;/p&gt;
&lt;p&gt;This requirement comes from my desire of running that software on a
platform that is fully managed by somebody else (my initial thought was to
host the site in an &lt;abbr title="Amazon Web Services"&gt;AWS&lt;/abbr&gt; S3 bucket and generate the site using &lt;abbr title="Amazon Web Services"&gt;AWS&lt;/abbr&gt; Lambda
function)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;should be lean with minimum dependencies for the generator itself&lt;/p&gt;
&lt;p&gt;The more dependencies software has the more likely it is to get an
unexpected behaviour once one of the upstream dependencies make an
undesirable breaking change.  I really wanted stability and to touch the
configuration in rare occasions only when I needed to change the behaviour
of my site and not in an adhoc response to an upstream breaking change.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;should be extensible and should support a plug-in mechanism&lt;/p&gt;
&lt;p&gt;I have a really high bar on what the final result should be, e.g. valid and
standard compliant HTML and CSS documents, semantic structuring, etc.  In
order not to be limited by the generator I needed a way on how I could
influence the generation process without patching or tweaking the core of
the generator itself, since doing it this way would mean maintaining a fork
of the generator and as I mentioned above, it does not fit the second
requirement.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;the template language should be flexible and should allow conditional logic&lt;/p&gt;
&lt;p&gt;Over the years I worked with multiple template engines and I found that the
most comfortable engines are those that potentially allow you to break the
concept of separating design from code.  Not that I recommend doing so, but
having such power gives you yet another flexible interface to express
yourself.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;the architecture of the generator should feel clean, stable, and thought out&lt;/p&gt;
&lt;p&gt;I do not know how to easily describe this, but my understanding of the well
engineered software is when its layout is simple to understand, structured,
yet easily extendable without introducing any invasive changes to the
structure, e.g. callbacks/hooks in the key transition points, so you could
hook the external code up and influence the logic, etc.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A bit more research brought me to the realisation that there is a trend in the
community and it has a name: &lt;a href="https://jamstack.org/"&gt;Javascript, API, and Markup Stack(Jamstack)&lt;/a&gt;.
The ideas behind Jamstack resonate with my vision on how I wanted to run my
blog, so if you want to understand the reasoning behind many choices I made
their website would be a good place to start reading about the approach.&lt;/p&gt;
&lt;p&gt;After a lot of consideration the following three &lt;span&gt;&lt;abbr title="Static Site Generator"&gt;SSG&lt;/abbr&gt;&lt;/span&gt;s were the primary
contenders to become the engine of my blog site:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://jekyllrb.com/"&gt;Jekill&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.gatsbyjs.org/"&gt;Gatsby&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://getpelican.com/"&gt;Pelican&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;All of these three were aligned to the requirements, however I have an
indescribable allergy to NodeJS ecosystem and I prefer Python over Ruby, hence
Pelican was the first generator to spike with and to see whether we are a match
or not.&lt;/p&gt;
&lt;p&gt;The more I worked with Pelican the more I was falling in love with the
software: with less than 600K of source code spread across just 15 files (with
a couple being redundant in my configuration) it is packed with features and is
very extensible through a plug-in system.&lt;/p&gt;
&lt;p&gt;The next step was to create the templates (the collection of templates used to
generate the output is called a theme in Pelican).  While I was spiking I found
a theme I somewhat liked (&lt;a href="https://brutalistpelican.com/"&gt;Brutalist&lt;/a&gt; by Matt
McManus), then I found a free theme that I liked a lot
(&lt;a href="https://html5up.net/striped"&gt;Striped&lt;/a&gt; by AJ), but that theme was just an
HTML/CSS/JavaScript concept which was unrelated to Pelican in any way.&lt;/p&gt;
&lt;p&gt;Initially, I started to port the Striped theme to Pelican using the Brutalist
theme as the wireframe, but in the middle of that work I realised that despite
the Striped theme was posed as &amp;ldquo;&lt;q cite="https://html5up.net/striped"&gt;a free, fully responsive HTML5 site
template&lt;/q&gt;&amp;rdquo; it was generated in a haste and was not that responsive as the
claim would make you think.  There were lots of inconsistencies and no
overarching conventions on how things were structured within.&lt;/p&gt;
&lt;p&gt;After a while, struggling to fix everything I was not happy with in Striped
theme&amp;rsquo;s code, I decided to take a different approach: I decided to re-create
Striped-like Pelican theme from scratch using Pelican&amp;rsquo;s default theme called
&amp;ldquo;simple&amp;rdquo; as the foundation.&lt;/p&gt;
&lt;p&gt;The result (which is still an ongoing process) as you can see has some
resemblance to the theme I was taking inspiration from, but on the other hand
it is quite different and standalone in its own right.  Up until some point I
was even retaining &amp;ldquo;Design by HTML5 UP&amp;rdquo; at the bottom of the left hand side
menu, but when I realised that almost nothing left of the original design and
layout, I removed it, the theme evolved much further that the inspirational
theme I started with.&lt;/p&gt;
&lt;p&gt;This post is already getting too long, so I will conclude with the following:
I am going to publish a series of posts covering the development of this
website, the tips and tricks I learnt over the course of creating it, and the
infrastructure supporting the site and its deployment process in detail.&lt;/p&gt;
&lt;p&gt;All blog posts related to these topics will be tagged with the &amp;ldquo;&lt;a href="/tag/blog/"&gt;blog&lt;/a&gt;&amp;rdquo; tag, so
you should be able to find them easily (or even subscribe to the &lt;a href="/feeds/blog.atom.xml"&gt;blog RSS feed&lt;/a&gt;
(you may need to copy the link into your RSS Reader) to get the latest updates
as soon as I publish them).&lt;/p&gt;</content><category term="blog"></category><category term="pelican"></category><category term="blog"></category></entry><entry><title>nginx + a backend with a dynamic IP (e.g. AWS ELB)</title><link href="https://dmitry.khlebnikov.net/2017/01/13/nginx-a-backend-with-a-dynamic-ip-eg-aws-elb/" rel="alternate"></link><published>2017-01-13T10:00:00+11:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2017-01-13:/2017/01/13/nginx-a-backend-with-a-dynamic-ip-eg-aws-elb/</id><summary type="html">&lt;p&gt;Recently, I wrote about &lt;a href="https://dmitry.khlebnikov.net/2016/09/20/dynamic-resolution-of-upstream-servers-in-nginx/"&gt;the dynamic resolution of upstream servers&lt;/a&gt; in
nginx which was achieved by quite an intrusive patch to the core nginx module.
The patch was invented a while ago and was working very well up until recent
nginx versions were released.&lt;/p&gt;
&lt;p&gt;With the release of nginx 1.10 it was noticed that the patch crashes some
workers under heavy load and this was unacceptable for the production load,
hence a new approach was implemented.&lt;/p&gt;
&lt;p&gt;The beauty of the new solution is that it is non-intrusive and works with any
services that communicate via sockets.&lt;/p&gt;
&lt;p&gt;In a nutshell &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;Recently, I wrote about &lt;a href="https://dmitry.khlebnikov.net/2016/09/20/dynamic-resolution-of-upstream-servers-in-nginx/"&gt;the dynamic resolution of upstream servers&lt;/a&gt; in
nginx which was achieved by quite an intrusive patch to the core nginx module.
The patch was invented a while ago and was working very well up until recent
nginx versions were released.&lt;/p&gt;
&lt;p&gt;With the release of nginx 1.10 it was noticed that the patch crashes some
workers under heavy load and this was unacceptable for the production load,
hence a new approach was implemented.&lt;/p&gt;
&lt;p&gt;The beauty of the new solution is that it is non-intrusive and works with any
services that communicate via sockets.&lt;/p&gt;
&lt;p&gt;In a nutshell, I just looked at the problem from a little bit different angle
after I defined the requirements:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;nginx needs to delegate the requests to a FastCGI server over a socket&lt;/li&gt;
&lt;li&gt;we want to work with the standard packages provided by the distribution&lt;/li&gt;
&lt;li&gt;the FastCGI server could be on a dynamic IP address&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Since we are not allowed to patch the application the only place we can meddle
with the communication between nginx and the FastCGI server is the socket nginx
connects to. Therefore, we need some kind of a proxy that would take requests
from nginx, determine the FastCGI endpoint, and forward the requests to that
endpoint.&lt;/p&gt;
&lt;p&gt;Initially, I thought that I would use something like netcat or a similar tool
for this, but then I found that systemd provides &lt;code&gt;systemd-socket-proxyd&lt;/code&gt; binary
which fits the purpose perfectly and could be configured to be socket
activated.&lt;/p&gt;
&lt;p&gt;Before we dive into the implementation details of this solution, let&amp;rsquo;s describe
what we are going to do and how:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;nginx will be configured to talk to the locally bound socket - there are
    two options, actually: either a local TCP socket or a Unix socket&lt;/li&gt;
&lt;li&gt;a proxy service will be socket activated by a request coming from nginx to
    that local socket&lt;/li&gt;
&lt;li&gt;a proxy service should resolve the target and forward the request there&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The nginx part is easy &amp;ndash; we just need to replace the FastCGI server endpoint
address (in our example below it was &lt;code&gt;remote.php.backend.domain.tld.:9000&lt;/code&gt;)
with our local socket (we are using a unix socket at
&lt;code&gt;/run/systemd-socket-proxyd/fastcgi.sock&lt;/code&gt; in this example):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-nginx"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;upstream php {
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    #server remote.php.backend.domain.tld.:9000;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    server  unix:/run/systemd-socket-proxyd/fastcgi.sock;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;location ~ \.php$ {
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    try_files   $uri = 404;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    fastcgi_pass    php;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    fastcgi_index   index.php;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    include     fastcgi.conf;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;}&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The next step is to define the socket activated proxy service. This generally
requires creating two files in &lt;code&gt;/etc/system/systemd&lt;/code&gt; directory: one for the
socket and the other for the proxy itself. However, in this article we will go
an extra mile and will define template units so the same configuration could be
reused to launch multiple proxies using the same base templates.&lt;/p&gt;
&lt;p&gt;The first template file is for the systemd service which will provide the proxy
capability:&lt;/p&gt;
&lt;pre class="highlight" data-file="/etc/systemd/system/systemd-socket-proxyd@.service"&gt;&lt;code class="language-systemd"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Unit]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Description=&amp;quot;Generic Socket Proxy (%I)&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Documentation=https://www.freedesktop.org/software/systemd/man/systemd-socket-proxyd.html
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;After=network.service
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Service]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;EnvironmentFile=-/etc/sysconfig/systemd-socket-proxyd.%i
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;User=nobody
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Group=nobody
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;OOMScoreAdjust=-1000
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;UMask=077
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ExecStart=/usr/lib/systemd/systemd-socket-proxyd $TARGET
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Restart=on-failure
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;PrivateTmp=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;PrivateDevices=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#PrivateUsers=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#ProtectSystem=strict
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ProtectSystem=full
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#ProtectKernelTunables=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#ProtectControlGroups=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#NoNewPrivileges=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#ProtectKernelModules=true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#MemoryDenyWriteExecute=true&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Depending on the version of your &lt;code&gt;systemd&lt;/code&gt; manager you may be able to uncomment
more lines than was shown in this example, which was tested on CentOS 7.3.1611.&lt;/p&gt;
&lt;p&gt;Also, in the example template given above we are using &lt;code&gt;OOMScoreAdjust=-1000&lt;/code&gt; to
protect this proxy service from being killed in the event the system is
starving for memory &amp;ndash; this may be something you do not need.&lt;/p&gt;
&lt;p&gt;The second template file is for the socket unit that would trigger the
activation of the proxy service when a request arrives on the socket:&lt;/p&gt;
&lt;pre class="highlight" data-file="/etc/systemd/system/systemd-socket-proxyd@.socket"&gt;&lt;code class="language-systemd"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Unit]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Description=&amp;quot;Socket for Generic Socket Proxy (%I)&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Documentation=https://www.freedesktop.org/software/systemd/man/systemd-socket-proxyd.html
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Socket]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ListenStream=/run/systemd-socket-proxyd/%i.sock
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;SocketUser=root
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;SocketGroup=root
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;SocketMode=0660
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;DirectoryMode=0711
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Install]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;WantedBy=sockets.target&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You may notice that the defaults are pretty strict:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the socket is owned by root and only root is allowed to work with the
    socket;&lt;/li&gt;
&lt;li&gt;the directory permissions are set in such a way that the
    &lt;code&gt;/run/systemd-socket-proxyd&lt;/code&gt; directory file list is not readable by anyone
    except root.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These are safe and sane defaults and can be tweaked per instance that was
instantiated using the template as shown later in this article.&lt;/p&gt;
&lt;p&gt;Since our goal is to connect nginx to the backend FastCGI service we need to
ensure that the proxy socket is read/write accessible to nginx&amp;rsquo;es workers, so
we need to tweak the settings of the socket unit:&lt;/p&gt;
&lt;pre class="highlight" data-file="/etc/systemd/system/systemd-socket-proxyd@fastcgi.socket.d/fastcgi.conf"&gt;&lt;code class="language-systemd"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Socket]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;SocketGroup=nginx&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note how we extended the template for a specific named instance of the socket
unit: we defined the &lt;code&gt;systemd-socket-proxyd@fastcgi.socket.d&lt;/code&gt; sub-directory and
put a drop-in configuration snippet there.&lt;/p&gt;
&lt;p&gt;Now, to achieve our goal we need to specify the target endpoint for our proxy
service (the named instance we spawn using the template):&lt;/p&gt;
&lt;pre class="highlight" data-file="/etc/systemd/system/systemd-socket-proxyd@fastcgi.service.d/fastcgi.conf"&gt;&lt;code class="language-systemd"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Service]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Reset the ExecStart, so we could override it
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ExecStart=
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ExecStart=/usr/lib/systemd/systemd-socket-proxyd remote.php.backend.domain.tld.:9000&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The mechanics behind extending the configuration is the same as for the socket
unit, but here we overrode the &lt;code&gt;ExecStart&lt;/code&gt; command to specify the target endpoint
for the proxy.&lt;/p&gt;
&lt;p&gt;OK, we are done with the configuration of &lt;code&gt;systemd&lt;/code&gt;, so it would be a good time
to reload the &lt;code&gt;systemd&lt;/code&gt; daemon:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# systemctl daemon-reload&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If you run a system where SELinux is disabled (why?!) you don&amp;rsquo;t need to do
anything additional and should be good, but if you are security conscious and
want to ensure that you follow the least privilege principle, then read on :)&lt;/p&gt;
&lt;p&gt;Unfortunately, &lt;code&gt;systemd-socket-proxyd&lt;/code&gt; seems not to be used a lot by the
community (most likely people are just unaware of it) so the tool has no
dedicated policy attached to it in the targeted SELinux policy. I plan to push
the change into the SELinux reference policy, but before I do we are going to
use a custom loadable policy module.&lt;/p&gt;
&lt;p&gt;To build a module you need the SELinux reference policy development framework
installed on the instance you are building your policies (it can be the same
instance you are running your proxy on, but I would advise to use a temporary
VM for building/compiling policies since the only time you need that
development stuff is when you are compiling the module from sources).&lt;/p&gt;
&lt;p&gt;On CentOS, you can install all the necessary bits to build a loadable SELinux
module by installing the &lt;code&gt;selinux-policy-devel&lt;/code&gt; package using &lt;code&gt;yum&lt;/code&gt;:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# yum -y install selinux-policy-devel&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note, I skipped the output of the command since it does not provide any useful
information for the purposes of this article.&lt;/p&gt;
&lt;p&gt;Once the SELinux development framework is installed we can start designing our
loadable policy for the &lt;code&gt;systemd-socket-proxyd&lt;/code&gt; service.&lt;/p&gt;
&lt;p&gt;Our policy will consist of two files:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;systemd-socket-proxyd.te&lt;/code&gt; &amp;ndash; the type enforcement ruleset; and&lt;/li&gt;
&lt;li&gt;&lt;code&gt;systemd-socket-proxyd.fc&lt;/code&gt; &amp;ndash; the file context ruleset.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Eventually, we will need to introduce the corresponding module interface
support file too, but for the purposes of this article we should be fine with
the automatically generated one.&lt;/p&gt;
&lt;p&gt;The content of the systemd-socket-proxy.te file is listed below:&lt;/p&gt;
&lt;pre class="highlight" data-file="systemd-socket-proxy.te"&gt;&lt;code class="language-selinux"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;policy_module(systemd-socket-proxyd, 1.0)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## &amp;lt;desc&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;##  &amp;lt;p&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;##  Allow systemd-socket-proxyd to bind any port instead of one labelled
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## with systemd_socket_proxyd_port_t.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;##  &amp;lt;/p&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## &amp;lt;/desc&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gen_tunable(systemd_socket_proxyd_bind_any, false)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## &amp;lt;desc&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## &amp;lt;p&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## Allow systemd-socket-proxyd to connect to any port instead of
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## labelled ones.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## &amp;lt;/p&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;## &amp;lt;/desc&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gen_tunable(systemd_socket_proxyd_connect_any, false)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;systemd_domain_template(systemd_socket_proxyd)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;type systemd_socket_proxyd_unit_file_t;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;systemd_unit_file(systemd_socket_proxyd_unit_file_t)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;sysnet_dns_name_resolve(systemd_socket_proxyd_t)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# resolver
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;allow systemd_socket_proxyd_t self:unix_dgram_socket { create getopt setopt sendto read write };
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# listener
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;type systemd_socket_proxyd_port_t;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;corenet_port(systemd_socket_proxyd_port_t);
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;allow systemd_socket_proxyd_t self:tcp_socket accept;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;tunable_policy(`!systemd_socket_proxyd_bind_any',`
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; allow systemd_socket_proxyd_t systemd_socket_proxyd_port_t:tcp_socket name_bind;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;')
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;tunable_policy(`systemd_socket_proxyd_bind_any',`
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; corenet_tcp_bind_all_ports(systemd_socket_proxyd_t)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;')
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# target
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;tunable_policy(`!systemd_socket_proxyd_connect_any',`
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; allow systemd_socket_proxyd_t port_type:tcp_socket name_connect;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;')
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;tunable_policy(`systemd_socket_proxyd_connect_any',`
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; corenet_tcp_connect_all_ports(systemd_socket_proxyd_t)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;')
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# consumer
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;allow daemon systemd_socket_proxyd_t:unix_stream_socket connectto;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is still work in progress, but so far it works at least for my projects.
Note that there are two SELinux booleans defined which affect the behaviour of
the policy:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;systemd_socket_proxyd_bind_any&lt;/p&gt;
&lt;p&gt;allows to bind proxy to any TCP socket if set to true, otherwise the proxy
would be able to connect to TCP ports labelled with
&lt;code&gt;systemd_socket_proxyd_port_t&lt;/code&gt;;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;systemd_socket_proxyd_connect_any&lt;/p&gt;
&lt;p&gt;allows proxy to connect to any target TCP ports if set to true, otherwise
the target is limited by the ports labelled with
&lt;code&gt;systemd_socket_proxyd_port_t&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Now, to allow the proper transition into the &lt;code&gt;systemd_socket_proxyd_t&lt;/code&gt; domain we
need to label the &lt;code&gt;systemd-socket-proxyd&lt;/code&gt; binary with the
&lt;code&gt;systemd_socket_proxyd_exec_t&lt;/code&gt; label.&lt;/p&gt;
&lt;p&gt;The content of the systemd-socket-proxy.fc file that implements this behavior
is as follows:&lt;/p&gt;
&lt;pre class="highlight" data-file="systemd-socket-proxy.fc"&gt;&lt;code class="language-selinux"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/(usr/lib|etc)/systemd/system/systemd-socket-proxyd\.service  gen_context(system_u:object_r:systemd_socket_proxyd_unit_file_t,s0)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/systemd/systemd-socket-proxyd -- gen_context(system_u:object_r:systemd_socket_proxyd_exec_t,s0)&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this point, we have everything we need to compile a policy module, so let&amp;rsquo;s
just do it now:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# ls -l
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;total 8
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-rw-r--r--. 1 root root  235 Jan  5 05:21 systemd-socket-proxyd.fc
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-rw-r--r--. 1 root root 1467 Jan  6 00:10 systemd-socket-proxyd.te
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# make -f /usr/share/selinux/devel/Makefile
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Compiling targeted systemd-socket-proxyd module
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/bin/checkmodule:  loading policy configuration from tmp/systemd-socket-proxyd.tmp
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/bin/checkmodule:  policy configuration loaded
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/bin/checkmodule:  writing binary representation (version 17) to tmp/systemd-socket-proxyd.mod
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Creating targeted systemd-socket-proxyd.pp policy package
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;rm tmp/systemd-socket-proxyd.mod tmp/systemd-socket-proxyd.mod.fc
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# semodule -i systemd-socket-proxyd.pp
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# restorecon -v /usr/lib/systemd/systemd-socket-proxyd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;restorecon reset /usr/lib/systemd/systemd-socket-proxyd context system_u:object_r:init_exec_t:s0-&amp;gt;system_u:object_r:systemd_socket_proxyd_exec_t:s0&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The &lt;code&gt;semodule -i systemd-socket-proxyd.pp&lt;/code&gt; command has actually installed the
module into the system, but if you were building the module on a different
instance, then instead of installing the module you just need to grab the
resulting &lt;code&gt;systemd-socket-proxyd.pp&lt;/code&gt; file and transfer it to the target instance
where proxy is going to be running and only apply the last two commands
(&lt;code&gt;semodule -i ...&lt;/code&gt; and &lt;code&gt;restorecon&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;We approached the time when we need to perform the pre-flight checks before
launching our new service :). First, we need to check whether the file context
was applied to the &lt;code&gt;systemd-socket-proxyd binary&lt;/code&gt;:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# ls -ldZ /usr/lib/systemd/systemd-socket-proxyd 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-rwxr-xr-x. root root system_u:object_r:systemd_socket_proxyd_exec_t:s0 /usr/lib/systemd/systemd-socket-proxyd&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Looks good! Let&amp;rsquo;s start the socket unit and check the permissions set on the
socket file:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# systemctl start systemd-socket-proxyd@fastcgi.socket
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# ls -ldZ /run/systemd-socket-proxyd{,/fastcgi.sock}
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwx--x--x. root root  system_u:object_r:var_run_t:s0   /run/systemd-socket-proxyd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;srw-rw----. root nginx system_u:object_r:var_run_t:s0   /run/systemd-socket-proxyd/fastcgi.sock&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This also looks as expected. The next test would be to check that our proxy
service is running with the desired set of permissions and in the correct
SELinux domain:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# socat -v unix-client:/run/systemd-socket-proxyd/fastcgi.sock stdin
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;&amp;lt; 2017/01/13 00:59:22.987083  length=1 from=0 to=0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# ps uZ -C systemd-socket-proxyd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;LABEL                           USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;system_u:system_r:systemd_socket_proxyd_t:s0 nobody 28643 0.0  0.0 86628 756 ? Ssl  00:59   0:00 /usr/lib/systemd/systemd-socket-proxyd 127.0.0.1:9000
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# cat /proc/28643/status 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Name: systemd-socket-
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;State: S (sleeping)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Tgid: 28643
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Ngid: 0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Pid: 28643
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;PPid: 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;TracerPid: 0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Uid: 99 99 99 99
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Gid: 99 99 99 99
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;FDSize: 64
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Groups: 99 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[truncated]&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first &lt;code&gt;socat&lt;/code&gt; command was needed to trigger the socket activation that
resulted in the &lt;code&gt;systemd-socket-proxyd.service&lt;/code&gt; being launched.&lt;/p&gt;
&lt;p&gt;The second command confirmed that the service is running under the nobody user
and within the &lt;code&gt;systemd_socket_proxyd_t&lt;/code&gt; domain.&lt;/p&gt;
&lt;p&gt;Finally, the third command confirmed that the privileges were properly dropped
and there is no way the service could regain the escalated privileges back.&lt;/p&gt;
&lt;p&gt;Looks like we are all, so let&amp;rsquo;s make our changes persistent. To achieve this we
just need to enable the &lt;code&gt;systemd-socket-proxyd@fastcgi.socket&lt;/code&gt; unit:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# systemctl enable systemd-socket-proxyd@fastcgi.socket
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Created symlink from /etc/systemd/system/sockets.target.wants/systemd-socket-proxyd@fastcgi.socket to /etc/systemd/system/systemd-socket-proxyd@.socket.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# systemctl status systemd-socket-proxyd@fastcgi.socket | fgrep Loaded:
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;   Loaded: loaded (/etc/systemd/system/systemd-socket-proxyd@.socket; enabled; vendor preset: disabled)&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Just to show that the configuration is working I set a simple lab up in a VM
and followed this article with the only exception of the PHP/FPM location which
I am running on the same VM:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# cat /usr/share/nginx/html/test.php
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;&amp;lt;?php echo &amp;quot;This is the output from PHP\n&amp;quot; ?&amp;gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# cat /etc/nginx/conf.d/php-upstream.conf 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;upstream php {
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    #server        remote.php.backend.domain.tld.:9000
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    server         unix:/run/systemd-socket-proxyd/fastcgi.sock;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# cat /etc/nginx/default.d/php.conf
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;location ~ \.php$ {
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    try_files      $uri = 404;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    fastcgi_pass   php;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    fastcgi_index  index.php;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    include        fastcgi.conf;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;}
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# cat /etc/systemd/system/systemd-socket-proxyd@fastcgi.service.d/fastcgi.conf
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[Service]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Reset the ExecStart, so we could override it
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ExecStart=
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ExecStart=/usr/lib/systemd/systemd-socket-proxyd 127.0.0.1:9000
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# telnet 0 80
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Trying 0.0.0.0...
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Connected to 0.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Escape character is '^]'.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;GET /test.php HTTP/1.0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HTTP/1.1 200 OK
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Server: nginx/1.10.2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Date: Fri, 13 Jan 2017 03:01:16 GMT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Content-Type: text/html
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Connection: close
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;X-Powered-By: PHP/5.4.16
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;This is the output from PHP
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Connection closed by foreign host.&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Works as expected :).&lt;/p&gt;
&lt;p&gt;There is one thing one needs to be aware of: when I started to work on this I
discovered that &lt;code&gt;systemd-socket-proxyd&lt;/code&gt; had a hard-coded limit for the number
of connections set to 256 (I &lt;a href="https://dmitry.khlebnikov.net/2016/09/20/dynamic-resolution-of-upstream-servers-in-nginx/"&gt;introduced the &lt;code&gt;-c&lt;/code&gt; parameter&lt;/a&gt; to
&lt;code&gt;systemd-socket-proxyd&lt;/code&gt;, so one could dynamically set the limit, however it
would take some time until this change is propagated to all major distros).&lt;/p&gt;
&lt;p&gt;Also, it is worth it to mention that the provided configuration is not
efficient if you are using a domain name for the target endpoint for the proxy,
so if this is the case I would advise to run a local DNS caching service (e.g.
&lt;code&gt;dnsmasq&lt;/code&gt;) so you would not spend time on the DNS queries.&lt;/p&gt;
&lt;p&gt;As always, I would appreciate any feedback you may have.&lt;/p&gt;</content><category term="hacking"></category><category term="nginx"></category><category term="patch"></category></entry><entry><title>Dynamic resolution of upstream servers in nginx</title><link href="https://dmitry.khlebnikov.net/2016/09/20/dynamic-resolution-of-upstream-servers-in-nginx/" rel="alternate"></link><published>2016-09-20T10:00:00+10:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2016-09-20:/2016/09/20/dynamic-resolution-of-upstream-servers-in-nginx/</id><summary type="html">&lt;p&gt;UPDATE: This approach was superseded by the &lt;a href="https://dmitry.khlebnikov.net/2017/01/13/nginx-a-backend-with-a-dynamic-ip-eg-aws-elb/"&gt;proxying through
systemd-socket-proxyd&lt;/a&gt; approach.&lt;/p&gt;
&lt;p&gt;Many of my clients are running application stacks consisting of nginx plus some
kind of scripting engine behind it (be it PHP, Ruby, or something else).&lt;/p&gt;
&lt;p&gt;The architecture I designed for this kind of workload involves at least two
load balancers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;an external, frontend load balancer that serves the web requests from
    visitors; and&lt;/li&gt;
&lt;li&gt;an internal, backend load balancer that distributes load between the
    backends.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Everything looks great when you implement this using &amp;ldquo;in-house&amp;rdquo; infrastructure
where you control most of the networking aspects.&lt;/p&gt;
&lt;p&gt;However, the tendency is that most &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;UPDATE: This approach was superseded by the &lt;a href="https://dmitry.khlebnikov.net/2017/01/13/nginx-a-backend-with-a-dynamic-ip-eg-aws-elb/"&gt;proxying through
systemd-socket-proxyd&lt;/a&gt; approach.&lt;/p&gt;
&lt;p&gt;Many of my clients are running application stacks consisting of nginx plus some
kind of scripting engine behind it (be it PHP, Ruby, or something else).&lt;/p&gt;
&lt;p&gt;The architecture I designed for this kind of workload involves at least two
load balancers:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;an external, frontend load balancer that serves the web requests from
    visitors; and&lt;/li&gt;
&lt;li&gt;an internal, backend load balancer that distributes load between the
    backends.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Everything looks great when you implement this using &amp;ldquo;in-house&amp;rdquo; infrastructure
where you control most of the networking aspects.&lt;/p&gt;
&lt;p&gt;However, the tendency is that most enterprises are moving to the cloud
providers and with that we lose some control.&lt;/p&gt;
&lt;p&gt;Specifically, often the cloud providers define their load-balancers as
auto-scaling entities that change their IP addresses depending on the
scale-in/out activity.&lt;/p&gt;
&lt;p&gt;Unfortunately, the community version of nginx does not know how to dynamically
resolve the specified upstream servers (such a functionality is available from
the nginx commercial subscription only), so I spent a couple of evenings to
implement the desired functionality as a &lt;a href="https://github.com/galaxy4public/nginx-upstream-resolve" title="A patch to introduce the dynamic resolution of the upstream servers"&gt;patch&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;a href="https://github.com/galaxy4public/nginx-upstream-resolve" title="A patch to introduce the dynamic resolution of the upstream servers"&gt;patch&lt;/a&gt; implements the dynamic DNS resolution of the specified upstream
servers in the upstream compatible way: we are re-using the very same &amp;ldquo;resolve&amp;rdquo;
keyword on the server line as the commercial version of nginx does ensuring
that if you ever decide to switch to the commercial subscription you would not
need to change your configs.&lt;/p&gt;
&lt;p&gt;The &lt;a href="https://github.com/galaxy4public/nginx-upstream-resolve" title="A patch to introduce the dynamic resolution of the upstream servers"&gt;patch&lt;/a&gt; was originally created for nginx 0.8.6 and was used in
production for the last couple of years. The work on the patch was sponsored by
&lt;a href="https://openwall.com.au"&gt;Openwall (Australia)&lt;/a&gt; and &lt;a href="https://withriley.com"&gt;Data Solutions
Group&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Enjoy! :)&lt;/p&gt;</content><category term="hacking"></category><category term="nginx"></category><category term="patch"></category></entry><entry><title>Transparent SSH host-jumping (Expert)</title><link href="https://dmitry.khlebnikov.net/2016/07/26/transparent-ssh-host-jumping-expert/" rel="alternate"></link><published>2016-07-26T10:00:00+10:00</published><updated>2020-05-17T04:45:11+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2016-07-26:/2016/07/26/transparent-ssh-host-jumping-expert/</id><summary type="html">&lt;p&gt;A while ago in the &lt;a href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/"&gt;Transparent SSH host-jumping (Advanced)&lt;/a&gt; post I
described a technique on how one could jump quite effortlessly through a chain
of intermediate hosts. However, there was a catch: the user names and ports
across the whole chain should be the same and there was no easy way to change
that.&lt;/p&gt;
&lt;p&gt;Given that I &lt;a href="https://dmitry.khlebnikov.net/2016/07/25/ssh-interactive-proxycommand/"&gt;recently&lt;/a&gt; paid quite a lot of attention to the ProxyCommand
directive I decided to look into the implementation of the helper script that
will allow one to tweak parameters for the hosts in the chain.&lt;/p&gt;
&lt;p&gt;You can read the &lt;a href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/"&gt;original&lt;/a&gt; post for the &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;A while ago in the &lt;a href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/"&gt;Transparent SSH host-jumping (Advanced)&lt;/a&gt; post I
described a technique on how one could jump quite effortlessly through a chain
of intermediate hosts. However, there was a catch: the user names and ports
across the whole chain should be the same and there was no easy way to change
that.&lt;/p&gt;
&lt;p&gt;Given that I &lt;a href="https://dmitry.khlebnikov.net/2016/07/25/ssh-interactive-proxycommand/"&gt;recently&lt;/a&gt; paid quite a lot of attention to the ProxyCommand
directive I decided to look into the implementation of the helper script that
will allow one to tweak parameters for the hosts in the chain.&lt;/p&gt;
&lt;p&gt;You can read the &lt;a href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/"&gt;original&lt;/a&gt; post for the details of how this host-jumping
technique works, here I am only going to provide the proxy script and the
corresponding ssh config parameter block to use the script.&lt;/p&gt;
&lt;p&gt;The goal was to support the following syntax:&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh default_user@userA^hostA/userB^hostB:port/hostC&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It was a little challenge to come up with the character for identifying the
user part for intermediate hosts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;@&lt;/code&gt; - cannot be used since SSH parses the command line before providing the
    string to the ProxyCommand script&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%&lt;/code&gt; - cannot be used since SSH was thinking that I&amp;rsquo;m trying to do an
    expansion of the internal SSH variable&lt;/li&gt;
&lt;li&gt;&lt;code&gt;!&lt;/code&gt;, &lt;code&gt;$&lt;/code&gt;, &lt;code&gt;(&lt;/code&gt;, &lt;code&gt;)&lt;/code&gt;, and &lt;code&gt;&amp;amp;&lt;/code&gt; - are all shell unfriendly&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So I decided on the &lt;code&gt;^&lt;/code&gt; character as a delimiter.&lt;/p&gt;
&lt;p&gt;In the proposed command above the &amp;ldquo;default_user&amp;rdquo; is the user name we ultimately
want to use for logging into the last host in the chain (it happens that this
user name will be used for any host in the chain where no alternative name is
provided).&lt;/p&gt;
&lt;p&gt;Each host in the chain could also be provided with the relevant port or, if the
port is omitted, it will use the global port configuration (usually 22/tcp but
can be changed with the &lt;code&gt;-p&lt;/code&gt; argument to ssh).  The script is a bit not optimised
(bash is really slow on string processing, but I decided to stick with pure
bash where it was possible):&lt;/p&gt;
&lt;pre class="highlight" data-file="~/bin/ssh-helper.sh"&gt;&lt;code class="language-bash"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#!/bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;set -eu -o pipefail
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec 10&amp;lt;&amp;amp;0 11&amp;gt;&amp;amp;1 0&amp;lt;&amp;amp;2 1&amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;DEFAULT_USER=&amp;quot;$1&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;DEFAULT_PORT=&amp;quot;$3&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_CHAIN=&amp;quot;$2&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_NEXT=&amp;quot;${HOST_CHAIN%%/*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_USER=&amp;quot;${HOST_NEXT%%^*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[ &amp;quot;$HOST_USER&amp;quot; == &amp;quot;$HOST_NEXT&amp;quot; ] &amp;amp;&amp;amp; HOST_USER=&amp;quot;$DEFAULT_USER&amp;quot; ||:
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_PORT=&amp;quot;${HOST_NEXT##*:}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[ &amp;quot;$HOST_PORT&amp;quot; == &amp;quot;$HOST_NEXT&amp;quot; ] &amp;amp;&amp;amp; HOST_PORT=&amp;quot;$DEFAULT_PORT&amp;quot; ||:
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;TARGET_HOST=&amp;quot;${HOST_CHAIN##*/}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;TARGET_PORT=&amp;quot;${TARGET_HOST##*:}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;TARGET_HOST=&amp;quot;${TARGET_HOST%:*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[ &amp;quot;$TARGET_PORT&amp;quot; == &amp;quot;$TARGET_HOST&amp;quot; ] &amp;amp;&amp;amp; TARGET_PORT=&amp;quot;$DEFAULT_PORT&amp;quot; ||:
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;TARGET_HOST=&amp;quot;${TARGET_HOST#*^}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_NEXT=&amp;quot;${HOST_NEXT#*^}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_NEXT=&amp;quot;${HOST_NEXT%:*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_CHAIN=&amp;quot;${HOST_CHAIN%/*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[ &amp;quot;$HOST_CHAIN&amp;quot; == &amp;quot;${HOST_CHAIN#*/}&amp;quot; ] &amp;amp;&amp;amp; HOST_CHAIN= || HOST_CHAIN=&amp;quot;${HOST_CHAIN#*/}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;HOST_CHAIN=&amp;quot;$HOST_NEXT${HOST_CHAIN:+/$HOST_CHAIN}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;if [ ! -d &amp;quot;$HOME/.ssh/.sessions&amp;quot; ]; then
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    echo &amp;quot;Creating the sessions directory&amp;quot; &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    mkdir -m700 &amp;quot;$HOME/.ssh/.sessions&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;fi
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;CONTROL_SOCKET=$(printf &amp;quot;$HOST_USER@HOST_CHAIN:$HOST_PORT\n&amp;quot; | shasum | cut -f1 -d' ')
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec 0&amp;lt;&amp;amp;10 1&amp;gt;&amp;amp;11
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec ssh \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    -o &amp;quot;ControlMaster auto&amp;quot; \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    -o &amp;quot;ControlPath ~/.ssh/.sessions/$CONTROL_SOCKET&amp;quot; \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    -o &amp;quot;ControlPersist 120s&amp;quot; \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    -l &amp;quot;$HOST_USER&amp;quot; \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    -p &amp;quot;$HOST_PORT&amp;quot; \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    &amp;quot;$HOST_CHAIN&amp;quot; \
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    -W &amp;quot;$TARGET_HOST&amp;quot;:&amp;quot;$TARGET_PORT&amp;quot;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above is a proof of the concept and it &amp;ldquo;works for me&amp;rdquo; :). I am using it
every day when I need to access boxes behind a bastion host. Your mileage may
vary and you are free to create your own version of the script that would
perform better (I would be really glad if a version of such a script could be
shared with me).&lt;/p&gt;
&lt;p&gt;The corresponding configuration block in the ssh config file looks as follows:&lt;/p&gt;
&lt;pre class="highlight" data-file="~/.ssh/config"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host */*
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    # if you uncomment ControlPath you also need to uncomment ControlMaster
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    #ControlMaster auto
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    # For OpenSSH &amp;lt; 6.7 you may uncomment the following, but long chains will fail:
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    #ControlPath   ~/.ssh/.sessions/%r@%h:%p
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    # For OpenSSH &amp;gt;= 6.7 you should uncomment the following:
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    #ControlPath   ~/.ssh/.sessions/%C
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ProxyCommand ~/bin/ssh-helper.sh %r %h %p&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well, this is a bit messy since OpenSSH introduced the &lt;code&gt;%C&lt;/code&gt; macro in version 6.7
and without &lt;code&gt;%C&lt;/code&gt; the &lt;code&gt;ControlPath&lt;/code&gt; string gets too long for OpenSSH to create a
socket on the filesystem for long chains of hosts.&lt;/p&gt;</content><category term="ssh"></category><category term="console"></category><category term="ssh"></category><category term="howto"></category></entry><entry><title>SSH: Interactive ProxyCommand</title><link href="https://dmitry.khlebnikov.net/2016/07/25/ssh-interactive-proxycommand/" rel="alternate"></link><published>2016-07-25T10:00:00+10:00</published><updated>2020-05-17T04:45:11+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2016-07-25:/2016/07/25/ssh-interactive-proxycommand/</id><summary type="html">&lt;p&gt;I was involved in the creation of the &lt;a href="https://github.com/realestate-com-au/sshephalopod"&gt;sshephalopod&lt;/a&gt; project, which was an
attempt to build an enterprise level authentication framework for SSH
authentication using the SSH &lt;abbr title="Certificate Authority"&gt;CA&lt;/abbr&gt; feature.&lt;/p&gt;
&lt;p&gt;The project is based on a wrapper script that signs a user via a &lt;abbr title="Security Assertion Markup Language"&gt;SAML&lt;/abbr&gt; identity
provider and gets user&amp;rsquo;s public key signed for the further usage.&lt;/p&gt;
&lt;p&gt;In one of the discussions I pointed out that such a wrapper script is not good
for the end user experience and I proposed to provide the users with an excerpt
for their ssh config file, so the functionality of sshephalopod would be &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I was involved in the creation of the &lt;a href="https://github.com/realestate-com-au/sshephalopod"&gt;sshephalopod&lt;/a&gt; project, which was an
attempt to build an enterprise level authentication framework for SSH
authentication using the SSH &lt;abbr title="Certificate Authority"&gt;CA&lt;/abbr&gt; feature.&lt;/p&gt;
&lt;p&gt;The project is based on a wrapper script that signs a user via a &lt;abbr title="Security Assertion Markup Language"&gt;SAML&lt;/abbr&gt; identity
provider and gets user&amp;rsquo;s public key signed for the further usage.&lt;/p&gt;
&lt;p&gt;In one of the discussions I pointed out that such a wrapper script is not good
for the end user experience and I proposed to provide the users with an excerpt
for their ssh config file, so the functionality of sshephalopod would be
transparent to the general usage scenario of the ssh tool.&lt;/p&gt;
&lt;p&gt;The response was that ProxyCommand do not support interactivity. Well, as they
say: The challenge is accepted :)&lt;/p&gt;
&lt;p&gt;The following is my train of thoughts before I came up with a general solution
on how to allow an interactive command to be used as the ProxyCommand in the
ssh config file.&lt;/p&gt;
&lt;p&gt;Before we start solving the problem at hand we need to create a test
environment, so we would be able to confirm when we reached success. The task
itself was very simple: we needed a host we could ssh into (an sshd daemon
running on the local host would be sufficient), then we needed an interactive
script, and a configuration block for the connection.&lt;/p&gt;
&lt;p&gt;The configuration block is pretty simple (%h expands to localhost and %p
expands to the port specified on the command line or to &amp;ldquo;22&amp;rdquo; otherwise):&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ fgrep -A1 'Host localhost' ~/.ssh/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host localhost
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; ProxyCommand ~/bin/interactive.script.sh %h %p&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Since most of our research is going to be inside the interactive script you
will see several incarnations of script&amp;rsquo;s body. The very first one was the
following:&lt;/p&gt;
&lt;pre class="highlight" data-file="~/bin/interactive.script.sh"&gt;&lt;code class="language-bash"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#!/bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec nc &amp;quot;$1&amp;quot; &amp;quot;$2&amp;quot;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this point we just need to confirm that our test environment works as
expected &amp;ndash; the ssh session should be proxied through the nc command and we
should be able to login under our own account via ssh to the localhost (my
private key was added to the key manager with ssh-add, hence no password prompt
was displayed):&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh galaxy@localhost
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Last login: Thu Jul 21 01:30:21 2016
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;OK, we confirmed that we can establish a proxied connection and tunnel our ssh
session through it.&lt;/p&gt;
&lt;p&gt;Each interactive script or program relies on the communication channel with the
user otherwise it could not be interactive. This channel comprises at least of
two file descriptors: one for standard input and the other for standard output,
so let&amp;rsquo;s check what descriptors are available for our script:&lt;/p&gt;
&lt;pre class="highlight" data="file="~/bin/interactive.script.sh""&gt;&lt;code class="language-bash"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#!/bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# on Linux the following line would be much simpler: ls -l /proc/$$/fd/, but
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# on OS X they do not expose the open file descriptors through /proc, so I
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# used &amp;quot;lsof&amp;quot; instead.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;lsof -p $$ &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec nc &amp;quot;$1&amp;quot; &amp;quot;$2&amp;quot;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we try to connect now we should see something like the following (I am
writing this article on an OS X machine so I provide the output from OS X,
however this also works for Linux):&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh galaxy@localhost
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF     NODE NAME
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user  cwd    DIR                1,2       612   893854 /Users/user/.ssh
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user  txt    REG                1,2    628640  2329236 /bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user  txt    REG                1,2    625712 13892061 /usr/lib/dyld
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user  txt    REG                1,2 385393734 13894121 /private/var/run/dyld_shared_cache_x86_64
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user    0   PIPE 0x44d71099589485df     16384          -&amp;gt;0x44d7109951223d0f
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user    1   PIPE 0x44d710995122454f     16384          -&amp;gt;0x44d71099512246af
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user    2u   CHR               16,1  0t631830     9705 /dev/ttys001
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45225   user  255r   REG                1,2       219 15455259 /Users/user/bin/interactive.script.sh
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Last login: Mon Jul 25 17:52:40 2016 from localhost
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We are interested in file descriptors 0 (standard input), 1 (standard output),
and 2 (standard error). As you can see the standard input and output are part
of the pipes (presumably linking them to the parent ssh process) and standard
error is pointing to our terminal session.&lt;/p&gt;
&lt;p&gt;I could have occupied a bit more of the page space showcasing that if you try
to communicate on standard input and/or output the ssh client will terminate
since you will be messing with the SSH protocol flow, but I believe you will
trust me on this :).&lt;/p&gt;
&lt;p&gt;What can we do to interact with the user, yet to preserve the channel with the
parent ssh process? Well, the answer is quite obvious:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;we have a pointer to the terminal session (file descriptor 2, the standard
    error, points to the terminal),&lt;/li&gt;
&lt;li&gt;so we just need to save pointers to the pipes&amp;rsquo; ends,&lt;/li&gt;
&lt;li&gt;re-open standard input and output with the terminal before we interact with
    the user,&lt;/li&gt;
&lt;li&gt;and restore these file descriptors back once we are ready to hand over the
    ssh session.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The following version of the script demonstrates the implementation of the
above logic:&lt;/p&gt;
&lt;pre class="highlight" data-file="~/bin/interactive.script.sh"&gt;&lt;code class="language-bash"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#!/bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec 10&amp;lt;&amp;amp;0 11&amp;gt;&amp;amp;1 0&amp;lt;&amp;amp;2 1&amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# start of the interactive behaviour
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;lsof -p $$
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;read -p &amp;quot;Type something: &amp;quot; I
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;echo &amp;quot;You typed: $I&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# finish of the interactive behaviour
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec 0&amp;lt;&amp;amp;10 1&amp;gt;&amp;amp;11
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec nc &amp;quot;$1&amp;quot; &amp;quot;$2&amp;quot;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I think it is time to test it :) :&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh galaxy@localhost
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;COMMAND   PID   USER   FD   TYPE             DEVICE  SIZE/OFF     NODE NAME
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user  cwd    DIR                1,2       612   893854 /Users/user/.ssh
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user  txt    REG                1,2    628640  2329236 /bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user  txt    REG                1,2    625712 13892061 /usr/lib/dyld
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user  txt    REG                1,2 385393734 13894121 /private/var/run/dyld_shared_cache_x86_64
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user    0u   CHR               16,1  0t640407     9705 /dev/ttys001
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user    1u   CHR               16,1  0t640407     9705 /dev/ttys001
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user    2u   CHR               16,1  0t640407     9705 /dev/ttys001
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user   10   PIPE 0x44d710995122378f     16384          -&amp;gt;0x44d71099589494ff
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user   11   PIPE 0x44d7109951223d0f     16384          -&amp;gt;0x44d710995122454f
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bash    45238   user  255r   REG                1,2       135 15455285 /Users/user/bin/interactive.script.sh
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Type something: This is a test
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;You typed: This is a test
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Last login: Mon Jul 25 17:57:05 2016 from localhost
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ logout
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Connection to localhost closed.&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Mission accomplished! :)&lt;/p&gt;
&lt;p&gt;I hope this small article would help somebody to design better wrappers around
SSH. Keep in mind that you could always optimise it further. For example, recent
versions of OpenSSH support passing of a file descriptor from the ProxyCommand
script, so if you have a decent netcat tool that supports the &amp;ldquo;-F&amp;rdquo; option
(fdpass) you could get native performance for the ssh communication link with
no proxy process hanging around.&lt;/p&gt;
&lt;p&gt;P.S. if you have any questions do not hesitate to comment.&lt;/p&gt;</content><category term="ssh"></category><category term="ssh"></category><category term="console"></category></entry><entry><title>Raspberry Pi 3 toolchain on CentOS 7</title><link href="https://dmitry.khlebnikov.net/2016/05/22/raspberry-pi-3-toolchain-on-centos-7/" rel="alternate"></link><published>2016-05-22T12:00:00+10:00</published><updated>2020-05-17T04:45:11+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2016-05-22:/2016/05/22/raspberry-pi-3-toolchain-on-centos-7/</id><summary type="html">&lt;p&gt;I heard a lot about Raspberry Pi boards but until now I had no need nor time to
work with one.&lt;/p&gt;
&lt;p&gt;However, recently I purchased a Dodge Journey R/T and found that although I
love the car I am so disappointed with its software and hard-wired logic that I
decided to experiment a bit and fix the most annoying things.&lt;/p&gt;
&lt;p&gt;Since almost everything inside the car is talking over the CAN bus I needed
some kind of a enclave inside the car where I could run my code and
inject/intercept CAN messages.&lt;/p&gt;
&lt;p&gt;I looked around and found that &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I heard a lot about Raspberry Pi boards but until now I had no need nor time to
work with one.&lt;/p&gt;
&lt;p&gt;However, recently I purchased a Dodge Journey R/T and found that although I
love the car I am so disappointed with its software and hard-wired logic that I
decided to experiment a bit and fix the most annoying things.&lt;/p&gt;
&lt;p&gt;Since almost everything inside the car is talking over the CAN bus I needed
some kind of a enclave inside the car where I could run my code and
inject/intercept CAN messages.&lt;/p&gt;
&lt;p&gt;I looked around and found that I can build the desired appliance using
Raspberry Pi 3 (Model B) + PiCAN 2 HAT board.&lt;/p&gt;
&lt;p&gt;Once the hardware was delivered to my home the time came to start building the
software side of things. My distribution of choice for this project became
CentOS 7 (userland), however, building stuff on the Raspberry Pi itself was a
painful and long process, so I needed a proper toolchain to be able to utilise
much more powerful hardware and do builds quicker.&lt;/p&gt;
&lt;p&gt;The following is a session dump (with some notes) on how I built my toolchain
on an AWS EC2 instance which was running a minimal CentOS 7 as its OS.&lt;/p&gt;
&lt;p&gt;I spawned an EC2 instance (you need at least 8GB of free space there to be able
to build the toolchain), logged in, and ensured that my system is up to date
(and update it if it was not):&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# yum -y update
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Loaded plugins: at-exit, fastestmirror, post-transaction-actions
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Loading mirror speeds from cached hostfile
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; * base: mirror.domain.tld
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; * extras: mirror.domain.tld
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; * updates: mirror.domain.tld
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;No packages marked for update&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The easiest way to build a toolchain is to use the crosstool-ng project, so I
went ahead and downloaded the latest version with the corresponding GPG
signature, verified the signature (although the verification was very
superficial since Bryan Hundven is not in my Web of Trust and the crosstool-ng
website was not providing an HTTPS page to confirm the fingerprint of the key),
and unpacked the sources:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# yum -y install bison bzip2 flex gcc gcc-c++ glibc-static gperf help2man libstdc++-static libtool make ncurses-devel texinfo wget
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# useradd -m build
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# su - build
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ wget -q 'http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-1.22.0.tar.xz'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ wget -q 'http://crosstool-ng.org/download/crosstool-ng/crosstool-ng-1.22.0.tar.xz.sig'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ gpg --recv-keys 35B871D1 --keyserver pgp.surfnet.nl
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: &amp;quot;--keyserver&amp;quot; not a key ID: skipping
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: &amp;quot;pgp.surfnet.nl&amp;quot; not a key ID: skipping
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: requesting key 35B871D1 from hkp server keys.gnupg.net
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: /home/build/.gnupg/trustdb.gpg: trustdb created
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: key 35B871D1: public key &amp;quot;Bryan Hundven &amp;quot; imported
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: Total number processed: 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:               imported: 1  (RSA: 1)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ gpg --verify crosstool-ng-1.22.0.tar.xz.sig
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: Signature made Fri Nov 20 13:09:26 2015 UTC using RSA key ID 35B871D1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: Good signature from &amp;quot;Bryan Hundven &amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:                 aka &amp;quot;Bryan Hundven &amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:                 aka &amp;quot;Bryan Hundven &amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:                 aka &amp;quot;Bryan Hundven &amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:                 aka &amp;quot;[jpeg image of size 3080]&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:                 aka &amp;quot;[jpeg image of size 16246]&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg: WARNING: This key is not certified with a trusted signature!
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;gpg:          There is no indication that the signature belongs to the owner.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Primary key fingerprint: 561E D9B6 2095 88ED 23C6  8329 CAD7 C8FC 35B8 71D1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ tar xJSf crosstool-ng-1.22.0.tar.xz
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ rm crosstool-ng-1.22.0.tar.xz*&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The next step was to prepare the environment for the crosstool-ng build process:&lt;/p&gt;
&lt;pre class="highlight" data-user="build"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ cd crosstool-ng
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ /configure --prefix=$HOME/ct-ng
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;checking build system type... x86_64-pc-linux-gnu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[skipped]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;configure: creating ./config.status
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;config.status: creating Makefile
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ make
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;  SED    'ct-ng'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[skipped]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;  SED    'docs/ct-ng.1'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;  GZIP   'docs/ct-ng.1.gz'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ make install
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;  GEN    'config/configure.in'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[skipped]&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For auto-completion, do not forget to install &lt;code&gt;ct-ng.comp&lt;/code&gt; into your &lt;code&gt;bash&lt;/code&gt;
completion directory (usually &lt;code&gt;/etc/bash_completion.d/&lt;/code&gt;)&lt;/p&gt;
&lt;pre class="highlight" data-user="build"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ export PATH=$HOME/ct-ng/bin:$PATH
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ cd&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once the above was done we are ready to actually configure and build our toolchain:&lt;/p&gt;
&lt;pre class="highlight" data-user="build"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ mkdir ~/builddir
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ cd ~/builddir
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ ct-ng menuconfig&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I was quite happy with the defaults and the only changes I made were the
following:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Paths and misc options -&amp;gt; Try features marked as EXPERIMENTAL -&amp;gt; check&lt;/p&gt;
&lt;p&gt;You may skip this but I prefer to see all available options when I go
through the list of configurable parameters, hence I enabled this;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Target options -&amp;gt; Target Architecture -&amp;gt; arm&lt;/p&gt;
&lt;p&gt;My board is Raspberry Pi 3 (Model B) which runs on ARMv8 Cortex-A53, yours
may be different but most likely it is also ARM based :)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Target options -&amp;gt; Bitness -&amp;gt; 64-bit&lt;/p&gt;
&lt;p&gt;There is actually almost no point in building a 64-bit version when you are
running on such a limited device as Raspberry, but at the time I was
writing this blog post I was building the AArch64 version of the toolchain.
I would recommend to stick with the 32-bit version of the toolchain if you
do not have any specific requirements for the 64-bit one;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Target options -&amp;gt; Architecture level -&amp;gt; armv8-a&lt;/p&gt;
&lt;p&gt;Since my only target was Raspberry Pi 3 (Model B) and the toolchain was
created for the personal use I did additional optimisation for my board.&lt;/p&gt;
&lt;p&gt;If you are not sure or if you want a toolchain that would produce more
compatible code for a range of ARM devices, then leave this setting at its
default, i.e. blank&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Target options -&amp;gt; Emit assembly for CPU -&amp;gt; cortex-a53&lt;/p&gt;
&lt;p&gt;Actually, this supersedes the previous option since it is more explicit. If
you are not optimising for a specific hardware, then leave it at the default
setting (which is blank).&lt;/p&gt;
&lt;p&gt;Also, there are more optimisations, e.g. you can specify that FPU for this
board is neon-fp-armv8, etc. but to keep it simple I decided not to
showcase that.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Toolchain options -&amp;gt; Tuple&amp;rsquo;s vendor string -&amp;gt; rpi3&lt;/p&gt;
&lt;p&gt;This is optional but I like my toolchain to be as descriptive as possible,
e.g. with this setting binaries will be prefixed with
&lt;code&gt;aarch64-rpi3-linux-gnueabi-&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Operating System -&amp;gt; Target OS -&amp;gt; linux&lt;/p&gt;
&lt;p&gt;It is essential to set this to &amp;ldquo;linux&amp;rdquo; otherwise &lt;code&gt;crosstool-ng&lt;/code&gt; will assume
that you are building a toolchain for a bare-bone hardware and the produced
binaries would not be properly linked to work with the OS on the board&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Once we are comfortable with the configuration of the future toolchain we exit
the configuration menu (saving the changes) and launch the build process (it
would take approximately an hour on AWS t2.small instance):&lt;/p&gt;
&lt;pre class="highlight" data-user="build" data-prompt=""[build@localhost"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;configuration written to .config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;*** End of the configuration.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;*** Execute 'ct-ng build' to start the build or try 'ct-ng help'.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ ct-ng build
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[INFO ]  Performing some trivial sanity checks
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[INFO ]  Build started 20160522.070915
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[skipped]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[INFO ]  Build completed at 20160522.080629
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[INFO ]  (elapsed: 57:14.18)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[INFO ]  Finishing installation (may take a few seconds)...
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[57:15] /&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Seems that our Raspberry Pi 3 toolchain is ready to be used. Let&amp;rsquo;s compile
something and see how it goes:&lt;/p&gt;
&lt;pre class="highlight" data-user="build"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ export PATH=$HOME/x-tools/aarch64-rpi3-linux-gnueabi/bin:$PATH
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ aarch64-rpi3-linux-gnueabi-gcc --version
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;aarch64-rpi3-linux-gnueabi-gcc (crosstool-NG crosstool-ng-1.22.0) 5.2.0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Copyright (C) 2015 Free Software Foundation, Inc.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;This is free software; see the source for copying conditions.  There is NO
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ printf '#include \nint main(){printf(&amp;quot;Hello\\n&amp;quot;); return 0;}\n' &amp;gt; sample.c
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ aarch64-rpi3-linux-gnueabi-gcc -o sample sample.c
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ ls -l sample
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-rwxr-xr-x. 1 build build 7672 May 22 08:19 sample
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[build@localhost ~]$ file sample
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;sample: ELF 64-bit LSB executable, ARM aarch64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 4.3.0, not stripped&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Well, it is time to build some awesome stuff for Raspberry Pi 3, I guess, but
this will be in another post. :)&lt;/p&gt;</content><category term="linux"></category><category term="console"></category><category term="howto"></category><category term="linux"></category><category term="raspberry pi"></category></entry><entry><title>Building a firewall? Simple and easy!</title><link href="https://dmitry.khlebnikov.net/2016/05/22/building-a-firewall-simple-and-easy/" rel="alternate"></link><published>2016-05-22T10:00:00+10:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2016-05-22:/2016/05/22/building-a-firewall-simple-and-easy/</id><summary type="html">&lt;p&gt;I strive for simplicity since I am a strong believer that achieving a goal with
the most simplest solution looks elegant, proves that you have deep knowledge
on the subject, and overall is beautiful by itself.  Additionally to this, a
simple solution is easier to comprehend and to audit, hence it is much easier
to ensure the security of such a solution.&lt;/p&gt;
&lt;p&gt;Over the last decade I stumbled upon numerous complicated firewalls erected on
the NAT boxes with tens (sometimes, hundreds!) of rules describing the traffic
flows and punched holes for some edge cases.  Every time I wondered what kind &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I strive for simplicity since I am a strong believer that achieving a goal with
the most simplest solution looks elegant, proves that you have deep knowledge
on the subject, and overall is beautiful by itself.  Additionally to this, a
simple solution is easier to comprehend and to audit, hence it is much easier
to ensure the security of such a solution.&lt;/p&gt;
&lt;p&gt;Over the last decade I stumbled upon numerous complicated firewalls erected on
the NAT boxes with tens (sometimes, hundreds!) of rules describing the traffic
flows and punched holes for some edge cases.  Every time I wondered what kind
of a bug has bitten the person who composed such a convoluted ruleset that is a
nightmare to manage.&lt;/p&gt;
&lt;p&gt;In 99% of the cases I was able to come up with a ruleset of usually less than
20 rules for the whole firewall to achieve exactly the same result.  So, in
this article I will explain my approach on building firewalls that are easy to
support and to understand.&lt;/p&gt;
&lt;p&gt;Before you dive into optimising (or creating) your firewall there are some
things you need to have a clear understanding of:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Networking&lt;/p&gt;
&lt;p&gt;You do not need to be an expert or a guru, but you should know fundamentals
about the protocols, standards, and internals of the networking related to
the area you are going to secure with the firewall.&lt;/p&gt;
&lt;p&gt;When you are in doubt, do not rely on an assumption: use search engines and
locate the corresponding RFC, standard, and/or any other authoritative
source of information documenting the protocol you are working with.&lt;/p&gt;
&lt;p&gt;It is impossible to know everything, but the common fallacy is that people
often create things based on wrong assumptions when it was a couple of
clicks away to research and understand the subject.  I have seen so many
times when people are &amp;ldquo;designing&amp;rdquo; their firewalls without a slightest clue
in regard to the standards covering interoperability of the hosts in the IP
network.&lt;/p&gt;
&lt;p&gt;For example, you can easily spot these &amp;ldquo;creations&amp;rdquo; if you look at the
ruleset and see that there is a rule that drops ICMP packets
unconditionally (or do not define any rules dealing with ICMP when the
default policy is &amp;ldquo;deny&amp;rdquo;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Traffic flows&lt;/p&gt;
&lt;p&gt;Think of a firewall as a filter that manages traffic flows (Figure 1 shows
a good visual representation of how traffic passes through the Linux
netfilter subsystem).&lt;/p&gt;
&lt;p&gt;Before you can make a decision in regard to whether to allow or deny
something you must know what your are dealing with and what outcome you
want to achieve.&lt;/p&gt;
&lt;p&gt;It would tremendously help you later if you could simply draw a diagram of
your network and overlay it with a layer documenting the inbound and
outbound flows of each node on the diagram.  Such a &amp;ldquo;data flow&amp;rdquo; diagram is
supposed to be a part of any solution documentation involving network
infrastructure, but in reality most of the enterprises (at least the ones I
worked with) simply forget to generate one.&lt;/p&gt;
&lt;p&gt;On such a diagram you would be able to see straight away what kind of
legitimate traffic is going to cross your firewall and what traffic is not
supposed to reach your firewall at all.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Goals&lt;/p&gt;
&lt;p&gt;This may sound obvious, but one of the most important things is to know
exactly what you are trying to achieve.  You are not building a firewall for
the sake of building a firewall, are you?&lt;/p&gt;
&lt;p&gt;Frankly speaking, there are just a handful number of scenarios for creating
a firewall (I fail to come up with more than five at this point) and all of
them are very simple.&lt;/p&gt;
&lt;p&gt;If your network provides any services to the external network (e.g.
Internet) there are just two options I can think of:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Allow external entities to access services on defined public endpoints
   (an inbound flow) and allow unrestricted outbound traffic from your
   network to the external one (an outbound flow);&lt;/li&gt;
&lt;li&gt;Allow external entities to access services on defined public endpoints
   and restrict outbound traffic from your network to a defined set of
   external endpoints.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;If your network does not provide any services to the external network and
only consumes resources from it, I see only two options:&lt;/p&gt;
&lt;ol start="3"&gt;
&lt;li&gt;Disallow any access from the external entities to your resources, but
   allow your network to access the external endpoints and receive
   responses from there;&lt;/li&gt;
&lt;li&gt;The same as above, but restrict the outbound traffic to a selected set
   of the external endpoints.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The fifth scenario is the one I personally do not use and is the blacklist
approach:&lt;/p&gt;
&lt;ol start="5"&gt;
&lt;li&gt;allow everything in each direction and block communication for the
   specific endpoints only (be they external and/or internal).&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Tools&lt;/p&gt;
&lt;p&gt;Last, but not least, is the requirement to know the corresponding toolset
you are going to utilise to achieve your goals.&lt;/p&gt;
&lt;p&gt;There are numerous high-level frameworks which are supposed to make systems
administrator&amp;rsquo;s life easier (e.g.  RHEL/CentOS/Fedora are using firewalld
on top of iptables), however, personally I prefer to work with iptables
directly (thus, my systems do not have firewalld installed).&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Before you start implementing the rules it often helps to describe your
firewall ruleset in simple sentences, e.g.:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;deny any incoming traffic to our network through the firewall unless it is
     explicitly allowed by the rules;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;allow any outbound traffic from our network through the firewall unless it
     is explicitly denied by the rules;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;deny any forwarding of traffic through the firewall unless it is
     explicitly allowed by the rules;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;allow anyone on the Internet to connect to the webserver on ports 80/tcp
     and 443/tcp;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;allow our office to connect to the firewall via SSH on port 22/tcp;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;allow traffic from our network to pass the firewall toward the Internet;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;allow the back channel traffic from the resources on the Internet to our
     network;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;…&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;And then research how each of these sentences can be implemented using the
configuration language of the tool.  The point here is that you need to take
one step at a time and translate the logic exactly so you do not deviate from
your goals &amp;ndash; you will be able to optimise the result at a later stage.&lt;/p&gt;
&lt;p&gt;Well, it is time for a real world example, I guess.  The following snippet is
used as the skeleton for the iptables ruleset on systems I manage (this snippet
assumes that 192.168.0.0/16 is the internal network and that the ruleset is
installed on the NAT instance which is a gateway to the Internet):&lt;/p&gt;
&lt;pre class="highlight" data-file="/etc/sysconfig/iptables"&gt;&lt;code class="language-iptables"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;*filter
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;:INPUT ACCEPT [0:0]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;:FORWARD ACCEPT [0:0]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;:OUTPUT ACCEPT [0:0]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -m state --state INVALID -j DROP
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# If it was already established pass bits through
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Allow for the local traffic
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -i lo -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Let's MTU discovery and other network management to work properly
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Allow remote SSH logins on the specified port (should be &amp;lt;1024 and would require sshd re-configuration if the port is not standard)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Allow DHCP client to get its information
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -i eth0 -p udp -m state --state NEW -m udp --sport 67:68 --dport 67:68 -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# Reject anything that we did not specifically allow above
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A INPUT -j REJECT --reject-with icmp-host-prohibited
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# This is a NAT box, so we accept packets from our network designated to the world, but reject any other forwarding attempts.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A FORWARD -i eth0 -s 192.168.0.0/22 ! -d 192.168.0.0/22 -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A FORWARD -i eth0 ! -s 192.168.0.0/22 -d 192.168.0.0/22 -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# If there is a MTU mismatch between the NAT box and hosts behind it we want to allow ICMP for the MTU discovery
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A FORWARD -i eth0 -p icmp -m icmp --icmp-type any -s 192.168.0.0/22 -d 192.168.0.0/22 -j ACCEPT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# We may be interested in anything that is rejected in this chain, so let's log it
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A FORWARD -j LOG
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# We do not allow to forward anything else
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A FORWARD -j REJECT --reject-with icmp-host-prohibited
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;COMMIT
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;*nat
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;:POSTROUTING ACCEPT [0:0]
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-A POSTROUTING -s 192.168.0.0/22 ! -d 192.168.0.0/22 -j MASQUERADE
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;COMMIT&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;There are a few things to note:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;default policies for INPUT and FORWARD are set to ACCEPT while the last
    rule in each chain is set to REJECT.  The reason for this is that the
    default policy can be either ACCEPT or DROP with the latter silently
    dropping packets.  Dropping packets makes it hard to investigate network
    issues, hence I prefer REJECT instead.&lt;/li&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;if you need to open more ports the best place to insert your rules would be
    between SSH and DHCP rules in the INPUT chain&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;if you are setting up a firewall on the server (so no traffic forwarding is
    needed) you may want to either drop all rules from the FORWARD chain and
    set the default policy for that chain to DROP, or you can simply leave the
    last two rules (LOG and REJECT) in the chain removing the rest.  Also, the
    nat table is not needed on the servers, so should be omitted.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;the above ruleset is not strict enough in regard to filtering ICMP traffic
    and allows all types of ICMP, perhaps it could be further tightened to
    allow only ICMP types 0 (reply), 3 (destination unreachable), 8 (request),
    11 (time exceeded), and 30 (traceroute) to pass through the firewall.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So, here you have it a solid firewall ruleset consisting of just 13 rules.&lt;/p&gt;</content><category term="linux"></category><category term="console"></category><category term="howto"></category><category term="iptables"></category><category term="linux"></category><category term="security"></category></entry><entry><title>Transparent SSH host-jumping (Advanced)</title><link href="https://dmitry.khlebnikov.net/2015/08/06/transparent-ssh-host-jumping-advanced/" rel="alternate"></link><published>2015-08-06T10:00:00+10:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2015-08-06:/2015/08/06/transparent-ssh-host-jumping-advanced/</id><summary type="html">&lt;p&gt;In this brief article I am going to describe how I resolved a nagging issue I
had with setting up access to hosts which are not directly reachable, but where
you need to forward your connection through an intermediate host.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://dmitry.khlebnikov.net/2010/12/10/ssh-port-forwarding-intermediate/"&gt;Previously&lt;/a&gt;, I was using the local SSH port-forwarding technique (although I
was configuring hosts I connect to in the &lt;code&gt;~/.ssh/config&lt;/code&gt; file instead of
using the command-line options). However, this approach turned out to be quite
inconvenient since every time I wanted to connect to a new host (and, possibly,
through a new intermediate host) I had to edit my &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;In this brief article I am going to describe how I resolved a nagging issue I
had with setting up access to hosts which are not directly reachable, but where
you need to forward your connection through an intermediate host.&lt;/p&gt;
&lt;p&gt;&lt;a href="https://dmitry.khlebnikov.net/2010/12/10/ssh-port-forwarding-intermediate/"&gt;Previously&lt;/a&gt;, I was using the local SSH port-forwarding technique (although I
was configuring hosts I connect to in the &lt;code&gt;~/.ssh/config&lt;/code&gt; file instead of
using the command-line options). However, this approach turned out to be quite
inconvenient since every time I wanted to connect to a new host (and, possibly,
through a new intermediate host) I had to edit my SSH configuration file and
add something like the following:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host intermediate
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    HostName 192.168.1.1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    HostKeyAlias intermediate
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    LocalForward 10001 target:22
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host target
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    HostName 127.0.0.1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    HostKeyAlias target
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    Port 10001&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Upon closer examination of my day-to-day routine I found two things that
frustrated me the most:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;My &lt;code&gt;~/.ssh/config&lt;/code&gt; file was growing uncontrollably and became hard to
     navigate;&lt;/li&gt;
&lt;li&gt;Each time I needed to connect to the target host through the intermediate
     host I had to open two sessions with one of them being idle most of the
     time.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;After a while I stumbled upon an article describing quite a generic way to
tunnel through an intermediate host and found the approach quite convenient for
the day-to-day use. So, I have added the following block into my &lt;code&gt;~/.ssh/config&lt;/code&gt;
file just before the &lt;code&gt;Host *&lt;/code&gt; section:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host */*
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ProxyCommand ssh $(dirname %h) -W $(basename %h):%p&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From that point on, I could connect to a target host via an intermediate one
by simply executing the following command:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ssh user@intemediate/target&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The configuration with the &lt;code&gt;ProxyCommand&lt;/code&gt; directive was spawning two &lt;code&gt;ssh&lt;/code&gt;
processes with one connected to the intermediate host in the background and the
other proxied through the intermediate host and connected to the target running
in the foreground, so from my point of view I had just one terminal session
open. The configuration allowed to chain as many hosts as I wanted, e.g.:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ssh user@hostA/hostB/hostC/hostD&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above would result in three &lt;code&gt;ssh&lt;/code&gt; processes running in the background (the
first connected to hostA, the second connected to &lt;em&gt;hostB&lt;/em&gt; proxied through &lt;em&gt;hostA&lt;/em&gt;,
and the third connected to &lt;em&gt;hostC&lt;/em&gt; proxied through &lt;em&gt;hostB&lt;/em&gt;) and one foreground
process which was connected to &lt;em&gt;hostD&lt;/em&gt; proxied via &lt;em&gt;hostC&lt;/em&gt;. This is great and quite
flexible to use, however, this approach has a number of limitations:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;you cannot specify different ports for different hosts in a chain;&lt;/li&gt;
&lt;li&gt;neither can you use different login names for different hosts in the chain;&lt;/li&gt;
&lt;li&gt;establishing connection to different chains sharing a part of the chain
    would not reuse already established connections, i.e. slow connection times.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Personally, I am using the same login name and the same ports on hosts I am
accessing, so the first two items were not an issue for me, but the last one
was irritating enough and I decided to figure out whether it is possible to
optimise it. After a bit of reading the documentation and a few attempts I came
up with the following configuration block in my &lt;code&gt;~/.ssh/config&lt;/code&gt; file (remember,
this block should be placed &lt;em&gt;before&lt;/em&gt; the &lt;code&gt;Host *&lt;/code&gt; one):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host */*
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ControlMaster auto
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ControlPath   ~/.ssh/.sessions/%r@%h:%p
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ProxyCommand /bin/sh -c 'mkdir -p -m700 ~/.ssh/.sessions/&amp;quot;%r@$(dirname %h)&amp;quot; &amp;amp;&amp;amp; exec ssh -o &amp;quot;ControlMaster auto&amp;quot; -o &amp;quot;ControlPath   ~/.ssh/.sessions/%r@$(dirname %h):%p&amp;quot; -o &amp;quot;ControlPersist 120s&amp;quot; -l %r -p %p $(dirname %h) -W $(basename %h):%p'&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s review it line by line, so the logic is clear:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Host */*&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This host definition block would catch any host specified on the &lt;code&gt;ssh&lt;/code&gt; command
line when the host name matches the &lt;code&gt;*/*&lt;/code&gt; pattern, so &lt;code&gt;ssh hostA/hostB/hostC&lt;/code&gt;
will be matched as &lt;code&gt;hostA/hostB&lt;/code&gt; being the first part before &lt;code&gt;/&lt;/code&gt; and &lt;code&gt;hostC&lt;/code&gt; as
the second part after &lt;code&gt;/&lt;/code&gt;. Due to a recursive call to &lt;code&gt;ssh&lt;/code&gt; (see below) this
block will be recursively applied to all hosts in the specified chain.&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ControlMaster auto&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This directive instructs &lt;code&gt;ssh&lt;/code&gt; to try to reuse an existing control channel to
communicate with the remote host, and if such a channel does not exist it will
be created, so further connections to the same remote host would benefit from
a speedup provided by the already established connection.&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ControlPath ~/.ssh/.sessions/%r@%h:%p&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This directive provides &lt;code&gt;ssh&lt;/code&gt; with the location of the control channel socket
file. The socket file should be unique for each remote host. Since we are
reusing the existing connection and skipping the authentication the socket file
should be tagged with the corresponding login name, this is why we are using %r
(remote login name), %h (the remote host name), and %p (the remote port) as
part of the file name. Please note that due to our usage of &amp;ldquo;/&amp;rdquo; as a host
separator in the chain the path constructed here will have a subdirectory
defined in the middle of the %h expansion. &lt;code&gt;ssh&lt;/code&gt; would not automatically create
that subdirectory, so it is something we need to address (see below)&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-ssh_config"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    ProxyCommand …&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is the heart of the whole block. I am starting this proxy command with
&lt;code&gt;/bin/sh -c '…'&lt;/code&gt; since &lt;code&gt;ssh&lt;/code&gt; is &lt;code&gt;exec()&lt;/code&gt;uting the specified command (this
replaces the spawned shell and makes it impossible to conditionally chain
commands), therefore I am using the shell binary as the proxy command to get
the ability to script my logic. Then I am creating the required directory
structure for the control channels under &lt;code&gt;~/.ssh/.sessions&lt;/code&gt; (note the &lt;code&gt;-p&lt;/code&gt;
argument to &lt;code&gt;mkdir&lt;/code&gt;, this will create all the missing parts of the specified
tree, but also would silence &lt;code&gt;mkdir&lt;/code&gt; in case all of the directories already
exist). It is worth to mention that with this &lt;code&gt;mkdir&lt;/code&gt; command I am creating the
subdirectory for the &lt;code&gt;ControlPath&lt;/code&gt; defined for the enclosing &lt;code&gt;Host */*&lt;/code&gt; block.&lt;/p&gt;
&lt;p&gt;The second part of the command line is conditionally executing &lt;code&gt;ssh&lt;/code&gt; if &lt;code&gt;mkdir&lt;/code&gt;
did not report any issues. It is good to execute &lt;code&gt;ssh&lt;/code&gt; here since we do not
need a redundant shell hanging around in the process tree. In this recursive
&lt;code&gt;ssh&lt;/code&gt; call we explicitly specify that we also need multiplexing of the control
channels created by the parent connections (they are &amp;ldquo;parent&amp;rdquo; since this is the
connection that established first and which enables access to the hosts further
down the specified chain) as well as we explicitly specify the location of the
control channel (note that since it is a parrent connection we are stripping
the rest of host names from the &lt;code&gt;%h&lt;/code&gt; macro using &lt;code&gt;dirname&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Finally, the third explicitly specified directive is &lt;code&gt;ControlPersist&lt;/code&gt; which is
set to &lt;code&gt;120s&lt;/code&gt;. This directive instructs &lt;code&gt;ssh&lt;/code&gt; to stay in the background and
maintain the control channel in case we decide to reuse it, but if no activity
on the control channel is detected for 2 minutes the &lt;code&gt;ssh&lt;/code&gt; process would
terminate. Without this directive the moment you close the connection which was
the master connection all dependent connections would also be closed, e.g. if
you have two sessions: one to &lt;code&gt;hostA/hostB&lt;/code&gt; and the other to &lt;code&gt;hostA/hostC&lt;/code&gt;, the
moment you closed the first connection the second one will be immediately
terminated if you do not have the &lt;code&gt;ControlPersist&lt;/code&gt; configured.&lt;/p&gt;
&lt;p&gt;The rest of the &lt;code&gt;ssh&lt;/code&gt; arguments is obvious: we connect to the first host in the
provided host chain (we are extracting that part with &lt;code&gt;dirname %h&lt;/code&gt;) and we are
proxying stdin/stdout to the last host in the supplied chain with the &lt;code&gt;-W&lt;/code&gt;
option.&lt;/p&gt;
&lt;p&gt;Basically, the control flow when you do &lt;code&gt;ssh user@hostA/hostB/hostC&lt;/code&gt; is the
following:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;ssh&lt;/code&gt; matches the &lt;code&gt;*/*&lt;/code&gt; pattern against the provided host name
     (&lt;code&gt;hostA/hostB/hostC&lt;/code&gt;)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;ssh&lt;/code&gt; tries to reuse the control channel by attempting to open the
     &lt;code&gt;~/.ssh/.sessions/user@hostA/hostB/hostC:22&lt;/code&gt; socket, if successful the
     connection is established and the command prompt is displayed to the
     calling user, otherwise the execution continues&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;ssh&lt;/code&gt; executes the defined &lt;code&gt;ProxyCommand&lt;/code&gt; command&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;the first part of the command creates &lt;code&gt;~/.ssh/.sessions/hostA/hostB&lt;/code&gt; if it
     is not there&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;the second part executes&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ssh … -o &amp;quot;ControlPath ~/.ssh/.sessions/user@hostA/hostB:22&amp;quot; … hostA/hostB -W hostC:22&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This will initiate another round of the above steps, but with a shorter chain
 and it will be recursive until there is just a single host left, e.g. when
 we ascend to &lt;code&gt;hostA&lt;/code&gt; as the host to connect to.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;now, with connected stdin/stdout to port 22 on &lt;code&gt;hostC&lt;/code&gt; (in the last
     iteration) &lt;code&gt;ssh&lt;/code&gt; performs the authentication against &lt;code&gt;hostC&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;if authentication is successful &lt;code&gt;ssh&lt;/code&gt; creates the
     &lt;code&gt;~/.ssh/.sessions/user@hostA/hostB/hostC:22&lt;/code&gt; control channel socket and
     becomes the master of that control channel&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;a command prompt is displayed to the calling user&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I hope this little trick will save you some time and will make your life
easier. :)&lt;/p&gt;</content><category term="ssh"></category><category term="console"></category><category term="ssh"></category><category term="howto"></category></entry><entry><title>Should we use "sudo" for day-to-day activities?</title><link href="https://dmitry.khlebnikov.net/2015/07/18/should-we-use-sudo-for-day-to-day-activities/" rel="alternate"></link><published>2015-07-18T20:04:00+10:00</published><updated>2020-05-17T04:45:11+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2015-07-18:/2015/07/18/should-we-use-sudo-for-day-to-day-activities/</id><summary type="html">&lt;div class="toc"&gt;&lt;span class="toctitle"&gt;Table of Contents&lt;/span&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#history"&gt;History&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#people-are-saying-sudo-is-good-is-it-true"&gt;People are saying &amp;ldquo;sudo&amp;rdquo; is good. Is it true?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#what-is-the-problem-with-the-sudo-approach"&gt;What is the problem with the &amp;ldquo;sudo&amp;rdquo; approach?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#the-light-side-of-sudo-is-there-one"&gt;The light side of &amp;ldquo;sudo&amp;rdquo;. Is there one?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#how-can-we-improve-the-security-of-our-systems-in-relation-to-the-sudo-usage"&gt;How can we improve the security of our systems in relation to the &amp;ldquo;sudo&amp;rdquo; usage?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;None of the systems I administer or supervise have &lt;code&gt;sudo&lt;/code&gt; installed with the
SUID bit set.&lt;/p&gt;
&lt;p&gt;Every time I answer a question on how to do privileged work on these systems
(i.e. do tasks that require administrator privileges) with a proposal to SSH
under the privileged account directly to do such a work, whoever asked &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;div class="toc"&gt;&lt;span class="toctitle"&gt;Table of Contents&lt;/span&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href="#history"&gt;History&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#people-are-saying-sudo-is-good-is-it-true"&gt;People are saying &amp;ldquo;sudo&amp;rdquo; is good. Is it true?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#what-is-the-problem-with-the-sudo-approach"&gt;What is the problem with the &amp;ldquo;sudo&amp;rdquo; approach?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#the-light-side-of-sudo-is-there-one"&gt;The light side of &amp;ldquo;sudo&amp;rdquo;. Is there one?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#how-can-we-improve-the-security-of-our-systems-in-relation-to-the-sudo-usage"&gt;How can we improve the security of our systems in relation to the &amp;ldquo;sudo&amp;rdquo; usage?&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;p&gt;None of the systems I administer or supervise have &lt;code&gt;sudo&lt;/code&gt; installed with the
SUID bit set.&lt;/p&gt;
&lt;p&gt;Every time I answer a question on how to do privileged work on these systems
(i.e. do tasks that require administrator privileges) with a proposal to SSH
under the privileged account directly to do such a work, whoever asked the
question starts to blabber how insecure that is, that one should use &lt;code&gt;sudo&lt;/code&gt;,
and that nobody should ever login directly as root.&lt;/p&gt;
&lt;p&gt;I have spent quite some time explaining the misconception behind so-called
&amp;ldquo;secure way to access systems through sudo&amp;rdquo;, so I decided to write up an
article that describes the issues of using that approach and why using &lt;code&gt;sudo&lt;/code&gt;
is actually &lt;em&gt;less secure&lt;/em&gt; than a direct SSH access.&lt;/p&gt;
&lt;h2 id="history"&gt;History&lt;/h2&gt;
&lt;p&gt;The following is based on my personal recollection of the history around early
90’s with some references to documents I could quickly find.  Unfortunately, this
is one of the topics that is not so easy to reconstruct in full detail.
Although there may be minor inaccuracies, the outlined view on the history
should be very close to the true events that took place.&lt;/p&gt;
&lt;p&gt;Many years ago (but not that far in the past) system administrators were using
&lt;code&gt;telnet&lt;/code&gt; and &lt;code&gt;rsh&lt;/code&gt; to access and administer their servers.  Networks were
simpler and traffic sniffing techniques were common.  Therefore, it was very
easy to eavesdrop on a root account login and to automate the task of gathering
the credentials.  To mitigate the issue to some extent the following approach
was proposed:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;login as a non-privileged account first;&lt;/li&gt;
&lt;li&gt;do some stuff;&lt;/li&gt;
&lt;li&gt;if you need privileged account access (e.g. root) switch to it using &lt;code&gt;su&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The idea behind this proposal was that such a sequence makes it harder for a
traffic listener to catch root’s credentials on the wire due to the login
sequence mixed in to the stream of other activities the systems administrator
was doing before escalating their account to the privileged user.&lt;/p&gt;
&lt;p&gt;At approximately the same time discussions started in regard to the dangers
of working as root, that people were tending to work as root for prolonged
periods of time performing tasks that did not require escalated privileges
without proper justification for that behaviour.  As the result of these
discussions the &lt;code&gt;sudo&lt;/code&gt; utility was born.  The utility allowed to bind root
privileges to a restricted set of commands and maintained access controls
through its configuration file in order to allow or deny access to the defined
functionality to specific users/groups.  This allowed systems administrators to
delegate some of the privileged routines to less privileged user/groups. (See
more on the &lt;a href="https://www.sudo.ws/sudo/history.html"&gt;history of sudo&lt;/a&gt; if you are interested).&lt;/p&gt;
&lt;p&gt;Somewhere in early 90’s the two approaches were merged, so the approach became:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;login as a non-privileged account and do your every day tasks;&lt;/li&gt;
&lt;li&gt;once a privileged operation is required execute it through &lt;code&gt;sudo&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Although it seems like a minor optimisation, in fact, this introduced a &lt;em&gt;major
security issue&lt;/em&gt;: previously, the attacker should have needed to listen for
traffic in attempt to figure out when the victim is executing &lt;code&gt;su&lt;/code&gt; and is
providing root&amp;rsquo;s password, but now they did not need to do anything except of
capturing user&amp;rsquo;s password at the beginning of the session (the same problem the
&amp;ldquo;su-after-normal-login&amp;rdquo; approach was trying to solve just reappeared :) ) since
once you know user&amp;rsquo;s password you can use &lt;code&gt;sudo&lt;/code&gt; which authenticates you with
&lt;em&gt;user&amp;rsquo;s&lt;/em&gt; password!&lt;/p&gt;
&lt;p&gt;In 1995, &lt;a href="https://en.wikipedia.org/wiki/Tatu_Yl%C3%B6nen"&gt;Tatu Ylönen&lt;/a&gt; as a response to the issues related to exchanging the
credentials over non-protected, easily sniffable networks released his first
implementation of the SSH protocol as freeware to the public.  Over the next
five years SSH was adopted worldwide and it eventually replaced
&lt;code&gt;telnet&lt;/code&gt;/&lt;code&gt;rlogin&lt;/code&gt;/&lt;code&gt;rsh&lt;/code&gt; for the remote access and management activities in most
places around the globe.&lt;/p&gt;
&lt;p&gt;However, due to inertia the recommended approach of logging in as a
non-privileged account and escalating privileges later somehow survived, is
still followed, and often people don’t even try to analyse and see the flaws of
the approach.&lt;/p&gt;
&lt;h2 id="people-are-saying-sudo-is-good-is-it-true"&gt;People are saying &amp;ldquo;sudo&amp;rdquo; is good. Is it true?&lt;/h2&gt;
&lt;p&gt;&lt;sup&gt;(or looking critically into some common misconceptions re: &amp;ldquo;sudo&amp;rdquo;)&lt;/sup&gt;&lt;/p&gt;
&lt;p&gt;So let’s look at the most commonly used &amp;ldquo;pros&amp;rdquo; in favour of using &lt;code&gt;sudo&lt;/code&gt;. For
example, &lt;a href="https://help.ubuntu.com/community/RootSudo"&gt;Ubuntu’s community help page&lt;/a&gt; provides a nice, aggregated list of
benefits provided by &lt;code&gt;sudo&lt;/code&gt; usage in their default installation. Let’s walk
through all of them and see if they are real benefits at all:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;The installer has fewer questions to ask.&lt;/p&gt;
&lt;p&gt;This is a very questionable &amp;ldquo;benefit&amp;rdquo; to the end user since it implies
 that the system would do more stuff with escalated privileges behind the
 scenes without the user even knowing it. From the security standpoint it
 just silently expands the attack surface.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Users don&amp;rsquo;t have to remember an extra password for occasional use (i.e.
     the root password). If they did, they&amp;rsquo;d be likely to forget it (or record
     it unsafely, allowing anyone to easily crack into their system).&lt;/p&gt;
&lt;p&gt;This is another hard to comprehend &amp;ldquo;benefit&amp;rdquo;. Given that we now have SSH
 and the recommended best practice is to use SSH keys instead of passwords,
 &lt;code&gt;sudo&lt;/code&gt; requires users to memorise yet another password.&lt;/p&gt;
&lt;p&gt;Moreover, the argument in regard to users’ likely behaviour is purely
 speculative and assumptive — to the same extent we can assume that
 password policies make it hard for users to memorise their passwords and
 they would be likely to forget the password (or record it unsafely, …).&lt;/p&gt;
&lt;p&gt;The truth is, the key based authentication solves the issue of the
 requirement to have multiple passwords for multiple accounts.&lt;/p&gt;
&lt;p&gt;There is one place, however, where the discussed &amp;ldquo;benefit&amp;rdquo; is actually
 applicable — local console access (no key authentication there, usually),
 but even there the best practice would be to login directly as root on
 the virtual console if there is such a need (the reason for that is
 quite complicated and in short could be described as the following: there
 are multiple checks and assumptions in the kernel code and the
 accompanying C library on allocating a terminal, spawning a process, etc.
 for root over the same actions performed for a non-privileged user).&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;It avoids the &amp;ldquo;I can do anything&amp;rdquo; interactive login by default. You will
     be prompted for a password before major changes can happen, which should
     make you think about the consequences of what you are doing.&lt;/p&gt;
&lt;p&gt;This statement also assumes that for some reason people would prefer to
 always login as root and do all of their work under that account.&lt;/p&gt;
&lt;p&gt;In reality users are so used to prefix almost any failed command with
 &lt;code&gt;sudo&lt;/code&gt; that this &amp;ldquo;benefit&amp;rdquo; can be considered as the quite opposite item,
 against &lt;code&gt;sudo&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;On a properly configured environment you explicitly need to login as the
 privileged account to do functions that require privileges.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sudo adds a log entry of the command(s) run (in /var/log/auth.log). If you
     mess up, you can go back and see what commands were run.&lt;/p&gt;
&lt;p&gt;This statement is also somewhat true, but it does not defend the &lt;code&gt;sudo&lt;/code&gt;
 usage. A proper auditing subsystem is what keeps audit logs no matter how
 activity was performed. Logging of executed commands for user&amp;rsquo;s history
 reasons is the job for the shell.&lt;/p&gt;
&lt;p&gt;The ability of logging is so limited in &lt;code&gt;sudo&lt;/code&gt; that it cannot be used for
 anything except a substitute for the shell history. Just imagine the
 following scenario — a user executes:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;sudo less /var/log/messages&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and then types &amp;ldquo;!&amp;rdquo; followed by the Enter/Return key — the user effectively
 now in the root shell and what &lt;code&gt;sudo&lt;/code&gt; will log into its logs has nothing
 to do with what user actually did.&lt;/p&gt;
&lt;p&gt;Instead of relying on &lt;code&gt;sudo&lt;/code&gt;&amp;lsquo;s logging abilities, one should configure
 &lt;code&gt;auditd&lt;/code&gt; and send events to a centralised log aggregator to get audit logs
 that can be trusted.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;On a server, every cracker trying to brute-force their way in will know it
     has an account named root and will try that first. What they don&amp;rsquo;t know is
     what the usernames of your other users are. Since the root account
     password is locked, this attack becomes essentially meaningless, since
     there is no password to crack or guess in the first place.&lt;/p&gt;
&lt;p&gt;This is such a weak attempt to bring host security into the play that it
 is hard to comment on it without dropping a tear :).&lt;/p&gt;
&lt;p&gt;First, use SSH keys and disable the password authentication on the server
 — this (and not some security through obscurity) will defend the system
 from the brute force attacks.&lt;/p&gt;
&lt;p&gt;Second, protect your remote access entry points with properly configured
 firewall and allow remote access from a defined list of locations only
 (i.e. whitelist authorised locations) — this will shrink the possible
 attack surface of the SSH service considerably.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Allows easy transfer for admin rights by adding and removing users from
     groups. When you use a single root password, the only way to de-authorize
     users is to change the root password.&lt;/p&gt;
&lt;p&gt;This is an interesting one: half of the statement is true, another is
 misleading.&lt;/p&gt;
&lt;p&gt;The true part is that you can easily delegate privileged operations using
 &lt;code&gt;sudo&lt;/code&gt;.  All in all, it was the primary goal and requirement of the tool
 creation to provide access delegation.&lt;/p&gt;
&lt;p&gt;The misleading part is that the alternative is to use a single root
 account/password.  The truth is that nobody is limited by a single root
 account: you can create as many as you want and each of them could have
 their own distinct password, e.g.&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# useradd -om -o 0 -g 0 -s /bin/sh new_root
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# passwd new_root&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Better yet, do not set the password and lock the account instead with
 &lt;code&gt;usermod -L new_root&lt;/code&gt; since we are using keys, remember?&lt;/p&gt;
&lt;p&gt;This approach also provides additional accountability since users will
 have separate shell histories, their login attempts will be clearly logged
 under separate names, etc.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;sudo can be setup with a much more fine-grained security policy.&lt;/p&gt;
&lt;p&gt;Another half-truth in the list of &amp;ldquo;benefits&amp;rdquo;. The statement is incomplete
 and lacks the part it is comparing the functionality to.  If we are
 comparing a legacy Unix access control system with &lt;code&gt;sudo&lt;/code&gt;, then yes &lt;code&gt;sudo&lt;/code&gt;
 is much more configurable. If we compare &lt;code&gt;sudo&lt;/code&gt; with, say, SELinux or
 GRsecurity’s RBAC &amp;ndash; &lt;code&gt;sudo&lt;/code&gt; will lose since both have much more
 fine-grained security controls than &lt;code&gt;sudo&lt;/code&gt;.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The root account password does not need to be shared with everybody who
     needs to perform some type of administrative task(s) on the system (see
     the previous bullet).&lt;/p&gt;
&lt;p&gt;As with item #6 this statement assumes for some obscure reason that there
 can be just a single root account in the system.  Therefore, the result of
 such a logical exercise is also questionable since it is based on a wrong
 assumption.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;The authentication automatically expires after a short time (which can be
     set to as little as desired or 0); so if you walk away from the terminal
     after running commands as root using sudo, you will not be leaving a root
     terminal open indefinitely.&lt;/p&gt;
&lt;p&gt;This statement also compares &lt;code&gt;sudo&lt;/code&gt; with something reader cannot compare
 to.  Moreover, it mixes up two logically unrelated things: the credentials
 expiration and terminal security.  While it is great that &lt;code&gt;sudo&lt;/code&gt; implements
 the former, the latter is usually addressed by entirely different means:
 starting with auto-logout functionality, lock screen, physical security,
 etc.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Well, we can continue to critically assess other common statements in regard to
&lt;code&gt;sudo&lt;/code&gt; made mostly by people who do not have any strong Information Security
background, but it would be a waste of time for the readers.&lt;/p&gt;
&lt;p&gt;You can always raise a question regarding some particular claim and/or
assumption related to &lt;code&gt;sudo&lt;/code&gt; and if it is interesting I would add it (and the
corresponding response) to this article.&lt;/p&gt;
&lt;h2 id="what-is-the-problem-with-the-sudo-approach"&gt;What is the problem with the &amp;ldquo;sudo&amp;rdquo; approach?&lt;/h2&gt;
&lt;p&gt;Well, there are several in fact. The most pressing issue is that the usage of
&lt;code&gt;sudo&lt;/code&gt; (or &lt;code&gt;su&lt;/code&gt;, or any other utility that has its SUID bit set) is crossing
the security boundary from the less privileged account to the more privileged
account. This opens doors (or widens the attack surface) to privilege
escalation techniques. In plain English it makes the non-privileged account to
be essentially equal to the privileged one, let me explain by a fairly simple
example:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;imagine if you are a developer and you work on a server under your
     non-privileged account;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;as a part of your daily routine you need to download some third party
     package and install it (we are going to leave out all the security
     complexities involved with such an activity like verifying signatures,
     using a separate instance to prepare a package for deployment, etc.);&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;the installation of the package usually requires executing some third
     party code under your non-privileged account. This code was not written by
     you and there is a high chance that you did not read/verify the foreign
     code line by line in order to ensure that it does not do anything
     malicious since this would be quite time consuming, would require a lot of
     effort, and your team has more important priorities than this (remember,
     this is an example based on situations you would encounter in the real
     world, which is by no means perfect);&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;it happens, that that particular third party was compromised and some
     malicious code has been injected into the package installation routines;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;after the execution of the installation routine (and the malicious code
     for that matter) your &lt;code&gt;~/.bashrc&lt;/code&gt; (for example) is modified in such a way
     that each time you login it starts up a key logger or some other kind of
     remotely controllable piece of software that talks back to its master;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;So far we just got an issue localised to this non-privileged account only (with
a possibility to spread across the entire fleet of servers that non-privileged
account has access to in case of the NFS mounted home directories). Is this
bad? Yes, it is since it may disrupt this particular project, steal reachable
sensitive information, could be used as a trampoline to jump start further
research and exploitation of other vulnerable resources. Is it critically bad?
Not necessarily. If the systems are built properly with host-based security in
mind, if the proper privilege separation techniques are used throughput the
company infrastructure, etc. the impact is localised and with proper monitoring
systems it would be detected eventually and investigated (keep in mind that it
is really hard for a non-privileged account to hide their activities from more
privileged processes).&lt;/p&gt;
&lt;p&gt;Now, let’s add &lt;code&gt;sudo&lt;/code&gt; to the mix, e.g. suddenly the developer decided to
install an additional library package into the system. So, what would happen
next? You guessed it: the developer would need to type in their password to
convince &lt;code&gt;sudo&lt;/code&gt; that they are &amp;ldquo;allowed&amp;rdquo; to do such a privileged thing as
installing a system package, the malicious software installed by the attacker
would happily intercept that and send it back to its master.&lt;/p&gt;
&lt;p&gt;From this point on, the attacker has the account password of the account where
their software runs and which they control. The attacker can now utilise &lt;code&gt;sudo&lt;/code&gt;
powers at their will. The security impact would be ranging from &amp;ldquo;high&amp;rdquo; to
&amp;ldquo;extreme&amp;rdquo; depending on how committed the attackers are.&lt;/p&gt;
&lt;p&gt;Following the logic, why would we want to introduce an additional complexity
that does not address the issue it was supposed to address, which is &amp;ldquo;to limit
exposure of the root account&amp;rdquo;?&lt;/p&gt;
&lt;h2 id="the-light-side-of-sudo-is-there-one"&gt;The &lt;em&gt;light&lt;/em&gt; side of &amp;ldquo;sudo&amp;rdquo;. Is there one?&lt;/h2&gt;
&lt;p&gt;So, is &lt;code&gt;sudo&lt;/code&gt; any good for anything? Actually, yes, it is. All in all, &lt;code&gt;sudo&lt;/code&gt;
is a tool that attracts a lot of attention from the security researchers and
auditors, its codebase got numerous peer reviews and the functionality the tool
provides can be used for good. The following scenarios come to my mind right
away:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;On a SELinux enabled system it seems that &lt;code&gt;sudo&lt;/code&gt; is the only properly
   implemented and reliable way to assume a different SELinux role. All other
   mechanisms are either lacking in the functionality or just do it half way
   leaving some artefacts behind;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Unless some effort is put into tweaking the way PAM (Pluggable
   Authentication Modules, an authentication framework used on Linux, Solaris,
   and some other Unix-like systems) authenticates users on LDAP enabled
   systems there is no easy way to have two separate accounts (a privileged and
   a non-privileged account) for the same LDAP user. This could be addressed
   administratively (e.g. by defining additional privileged users in LDAP) or
   technically by implementing account names’ prefixes. However, if there are
   budgetary and/or time constraints to implement the proper security framework
   &lt;code&gt;sudo&lt;/code&gt; with a quite restricted configuration would be an acceptable
   compromise.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Unfortunately, personally, I failed to find any other justified applications of
&lt;code&gt;sudo&lt;/code&gt; in a secure environment and would be happy to get some feedback if you
have something in mind worth including into the list above.&lt;/p&gt;
&lt;h2 id="how-can-we-improve-the-security-of-our-systems-in-relation-to-the-sudo-usage"&gt;How can we improve the security of our systems in relation to the &amp;ldquo;sudo&amp;rdquo; usage?&lt;/h2&gt;
&lt;p&gt;OK, so we got to the point where we are standing at a crossroad and we kind
of established that excessive usage of &lt;code&gt;sudo&lt;/code&gt; is a bad thing (for
security-paranoid readers - read: &amp;ldquo;almost any usage of &lt;code&gt;sudo&lt;/code&gt; except for
changing SELinux roles on a SELinux-enabled system is a bad thing&amp;rdquo;). So, what
is the alternative way of doing things? Well, there is a complex approach on
addressing and minimising the privilege escalation risks and roughly it can be
summarised as follows:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;apply the &lt;a href="https://en.wikipedia.org/wiki/Principle_of_least_privilege"&gt;least privilege principle&lt;/a&gt; to everything&lt;/p&gt;
&lt;p&gt;For example, if you need to work on content, the account you use to log
into the remote server should be allowed to do just that. This sounds a bit
extreme, so we may re-phrase it as follows:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a name="quote-least-privilege" href="#quote-least-privilege"&gt;&lt;/a&gt;
Each account should be provided the least number of required privileges
to do specific tasks under that account and should not be used for
anything else outside the defined set of activities.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Again, if you include &amp;ldquo;becoming root&amp;rdquo; into the list of defined activities
it would kind of defeat the purpose, so please resist this temptation. :)&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;there should be a defined list of accounts which are allowed to do
    system-wide modifications (e.g. privileged accounts)&lt;/p&gt;
&lt;p&gt;In line with the previous bullet point, these accounts must be used for
these activities only (system updates, installing new software, modifying
system-wide configuration).  The expectation is that the privileged
accounts are used on occasion only;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;privileged accounts during their activities should not cross the security
    boundary with the less privileged accounts.&lt;/p&gt;
&lt;p&gt;This is needed to avoid attacks from the less privileged accounts toward
more privileged (e.g. process hijacking, file races, etc.). Unfortunately,
this point is a bit confusing without a proper explanation that may take
several blog posts to be fully covered, but in a nutshell it means that
root should not touch anything writable by the less privileged account.
Some examples of the bad and insecure behaviour include:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;changing directory to a directory writable by non-root,&lt;/li&gt;
&lt;li&gt;executing scripts from a directory writable by non-root accounts or
    scripts that are writable by non-root,&lt;/li&gt;
&lt;li&gt;copying a file/directory from/to a directory writable by non-root
    accounts,&lt;/li&gt;
&lt;li&gt;and so on.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;if possible (and this is &lt;em&gt;highly&lt;/em&gt; recommended) privileged accounts should be
    accessed from the trusted and secure machines.&lt;/p&gt;
&lt;p&gt;It is really hard to define what the &amp;ldquo;trusted and secure machine&amp;rdquo; is, but
generally it should be assumed&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;that it is a laptop or a desktop station that is used entirely for the
    work purposes (no free time surfing on the leisure sites and stuff :) ),&lt;/li&gt;
&lt;li&gt;that proper firewall rules and protection techniques were used to secure
    the machine, and&lt;/li&gt;
&lt;li&gt;that the operator is security-minded and does everything they can to
     ensure integrity and security of their machine and software installed
     on it.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I would be really happy to answer any question in regard to this article and
provide any possible help in making our everyday system level activities more
secure, so do not hesitate to comment or &lt;a href="/contact"&gt;contact me&lt;/a&gt;.&lt;/p&gt;</content><category term="sudo"></category><category term="sudo"></category><category term="console"></category></entry><entry><title>SSH port-forwarding (Intermediate)</title><link href="https://dmitry.khlebnikov.net/2010/12/10/ssh-port-forwarding-intermediate/" rel="alternate"></link><published>2010-12-10T10:00:00+11:00</published><updated>2020-05-17T04:45:11+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2010-12-10:/2010/12/10/ssh-port-forwarding-intermediate/</id><summary type="html">&lt;p&gt;In my previous blog entry I described some basic functionality of SSH in terms
of port-forwarding. Now it&amp;rsquo;s time for a little bit more complex stuff.&lt;/p&gt;
&lt;p&gt;In this article I will highlight:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(forward) piercing of a firewall (getting access to resources behind it);&lt;/li&gt;
&lt;li&gt;dynamic port-forwarding (AKA proxy);&lt;/li&gt;
&lt;li&gt;(reverse) piercing of a firewall (exposing your local services on the remote side).&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="forward-firewall-piercing"&gt;Forward firewall piercing&lt;/h2&gt;
&lt;p&gt;Let&amp;rsquo;s start with the forward firewall piercing, since it is the easiest and was
somewhat already described in my previous blog entry on this topic. Now,
imagine that you already have SSH access to some &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;In my previous blog entry I described some basic functionality of SSH in terms
of port-forwarding. Now it&amp;rsquo;s time for a little bit more complex stuff.&lt;/p&gt;
&lt;p&gt;In this article I will highlight:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(forward) piercing of a firewall (getting access to resources behind it);&lt;/li&gt;
&lt;li&gt;dynamic port-forwarding (AKA proxy);&lt;/li&gt;
&lt;li&gt;(reverse) piercing of a firewall (exposing your local services on the remote side).&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="forward-firewall-piercing"&gt;Forward firewall piercing&lt;/h2&gt;
&lt;p&gt;Let&amp;rsquo;s start with the forward firewall piercing, since it is the easiest and was
somewhat already described in my previous blog entry on this topic. Now,
imagine that you already have SSH access to some host which is multi-home
connected (e.g. the host is connected to more than one network). Let&amp;rsquo;s also
assume that the host is a firewall and is masquerading other hosts in the
internal network and is translating just a handful set of ports to the servers
(looks familiar, doesn&amp;rsquo;t it? :) ). In other words, we are speaking of a
standard firewall/NAT router.&lt;/p&gt;
&lt;p&gt;Now, how can you access port 12345 on host behind the firewall given that this
port is not &amp;ldquo;exported&amp;rdquo; by the NAT on the firewall? This is quite simple. Open a
terminal window on your local computer and type the following:&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~] ssh -L12345:192.168.1.2:12345 joe@firewall.domain.tld&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From now on, as long as your SSH session is up and running you will be able to
reach &lt;code&gt;192.168.1.2:12345&lt;/code&gt; by connecting to &lt;code&gt;localhost:12345&lt;/code&gt; (i.e. the &lt;code&gt;12345&lt;/code&gt;
port on your local computer). Indeed, for this to work you need SSH access
anywhere inside the protected network (not necessarily on the firewall itself)
and if the firewall blocks any SSH access, you are out of luck.&lt;/p&gt;
&lt;h2 id="dynamic-port-forwarding"&gt;Dynamic port-forwarding&lt;/h2&gt;
&lt;p&gt;There are at least two usage patterns where I find SSH&amp;rsquo;s ability to forward
requests to many ports useful:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;I need to connect to different services (possibly on different hosts) inside
  the protected network (as per the configuration described above) and I don&amp;rsquo;t
  want to specify all of them on the command line;&lt;/li&gt;
&lt;li&gt;I need to access some resource which is Geo-protected (e.g. allows access
  from a particular part of the world), e.g. want to watch US Netflix being
  physically in Australia&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;In both cases, you use the following SSH command in your terminal window:&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh -D3128 joe@relay.domain.tld&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;As long as you SSH session is active, you can use port &lt;code&gt;3128&lt;/code&gt; on your local
machine as SOCKS4/SOCKS5 proxy (e.g. you can configure proxy settings in your
browser to use &lt;code&gt;localhost:3128&lt;/code&gt;) and browse the Net through your SSH connection,
and all your requests will look like they are coming from &lt;code&gt;relay.domain.tld&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;There are many uses for this: for example, some payment processors won&amp;rsquo;t allow
you to pay for goods if you are trying to pay through them from some countries
even if you are a legitimate user, another use case is when you are concerned
re: your privacy &amp;ndash; you can conceal your actual location by building a chain of
SSH tunnels and access the desired web site through this chain :) .&lt;/p&gt;
&lt;h2 id="reverse-firewall-piercing"&gt;Reverse firewall piercing&lt;/h2&gt;
&lt;p&gt;Finally, what if you are behind a very strict firewall that limits almost
everything, but you need to provide some services to the outside world from
your computer (e.g. sharing your access to company&amp;rsquo;s confidential information
to folks from WikiLeaks&amp;hellip; just kidding :) )?&lt;/p&gt;
&lt;p&gt;To achieve this you need to have an SSH account somewhere in the Net &amp;ndash; just
Google for &amp;ldquo;free ssh account&amp;rdquo; and you will surely find one for yourself).&lt;/p&gt;
&lt;p&gt;Now, when you have the account, you can execute the following on your local
computer (which is inside that highly secure network :) ):&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh -R:60000:127.0.0.1:22 joe@friendly.domain.tld&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above command will setup such a configuration that connecting on port &lt;code&gt;60000&lt;/code&gt;
at &lt;code&gt;friendly.domain.tld&lt;/code&gt; will forward traffic to your local machine&amp;rsquo;s port 22
(which is behind a firewall) &amp;ndash; this will work as long as your SSH session to
the &lt;code&gt;friendly.domain.tld&lt;/code&gt; is active.  Unfortunately, there are several pitfalls
in this approach, but they are all resolvable.&lt;/p&gt;
&lt;p&gt;Firstly, you need to ensure that &lt;code&gt;friendly.domain.tld&lt;/code&gt; is using a recent version
of SSH daemon, otherwise you will be limited to bind only to the loopback
interface on the remote host.&lt;/p&gt;
&lt;p&gt;Secondly, even if they are using a recent version of the SSH daemon, they can
disallow such binding (e.g. setting &amp;ldquo;GatewayPorts no&amp;rdquo; in &lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt;),
and, again, you will be restricted to the loopback interface only.&lt;/p&gt;
&lt;p&gt;Finally, you need to find such a friendly host which allows you to connect to
the bound ports from the outside (many public ones have a firewall rule
preventing such access in order to prevent abuses of their services).&lt;/p&gt;
&lt;p&gt;All in all, the best option to try this is to have your own host somewhere (e.g.
purchase a small virtual environment from some hosting provider or create an
instance on AWS EC2), then you will be able to configure the remote side the
way you want it!&lt;/p&gt;
&lt;p&gt;Anyway, even if you fail to find a host that allows you to expose your service
to the public, you still should be able to access it yourself &amp;ndash; using the
forward firewall piercing technique described at the beginning of this post:&lt;/p&gt;
&lt;pre class="highlight" data-user="user" data-prompt=""[user@localhost"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# from your home computer
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~]$ ssh -L60000:127.0.0.1:60000 joe@friendly.domain.tld&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once it is done your computer in the highly secure network should be reachable
via SSH on your &lt;code&gt;localhost:60000&lt;/code&gt;, e.g.&lt;/p&gt;
&lt;pre class="highlight" data-user="user"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[user@localhost ~] ssh -p6000 my_account@localhost&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Where &lt;code&gt;my_account&lt;/code&gt; is a user allowed to SSH into your computer in the highly
secure network.&lt;/p&gt;</content><category term="ssh"></category></entry><entry><title>SSH port-forwarding (Basic)</title><link href="https://dmitry.khlebnikov.net/2010/11/29/ssh-port-forwarding-basic/" rel="alternate"></link><published>2010-11-29T10:00:00+11:00</published><updated>2020-05-17T04:45:11+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2010-11-29:/2010/11/29/ssh-port-forwarding-basic/</id><summary type="html">&lt;p&gt;I think all of you are using SSH in your daily routines. However, do you use
its full potential? Today&amp;rsquo;s topic is the SSH port-forwarding feature and how
it can be use to achieve some interesting configurations.&lt;/p&gt;
&lt;p&gt;I&amp;rsquo;m sure most of you are aware of the feature, but how many of you are using
it? Personally, I&amp;rsquo;m a bit obsessed with it and have found numerous cases where
this feature of SSH is a real life saver.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s start with simple things and imagine that you have a server where you
are running MySQL (as a &lt;span class="truncated"&gt;&lt;/span&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;I think all of you are using SSH in your daily routines. However, do you use
its full potential? Today&amp;rsquo;s topic is the SSH port-forwarding feature and how
it can be use to achieve some interesting configurations.&lt;/p&gt;
&lt;p&gt;I&amp;rsquo;m sure most of you are aware of the feature, but how many of you are using
it? Personally, I&amp;rsquo;m a bit obsessed with it and have found numerous cases where
this feature of SSH is a real life saver.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s start with simple things and imagine that you have a server where you
are running MySQL (as a backend for your website) and that you are not
comfortable to work with MySQL neither through the MySQL command line interface
nor through a web-interace like phpMyAdmin. Instead you prefer to use, say,
MySQL WorkBench or something similar running on your local computer.&lt;/p&gt;
&lt;p&gt;How one could do this? Well, I&amp;rsquo;ve seen a lot that people tend to configure the
MySQL server to listen on a public interface (i.e. an interface that is
reachable from the Internet), then access it from their computer directly.
It&amp;rsquo;s not that bad if you have a static &lt;abbr title="Internet Protocol"&gt;IP&lt;/abbr&gt; assigned to your computer and you
added a firewall rule protecting the MySQL port on the server to be reachable
from your &lt;abbr title="Internet Protocol"&gt;IP&lt;/abbr&gt; address only, but what if you are behind some kind of NAT and the
same &lt;abbr title="Internet Protocol"&gt;IP&lt;/abbr&gt; address is shared among others in your network? What if you don&amp;rsquo;t have
a static &lt;abbr title="Internet Protocol"&gt;IP&lt;/abbr&gt; and the dynamic &lt;abbr title="Internet Protocol"&gt;IP&lt;/abbr&gt; range assigned by your ISP is too broad?
Overall, I personally don&amp;rsquo;t like running MySQL on a public interface since
there were publicly known security vulnerabilities in the MySQL binary
protocol, and I can assure you there will be more discovered over the time.&lt;/p&gt;
&lt;p&gt;So, what should we do to access our remote database securely and conveniently?
Run the MySQL server on 127.0.0.1:3306 (well, if your web server is located on
another machine, you may want to bind MySQL to some internal interface &amp;ndash; the
network that links your servers only, e.g. 192.168.1.1:3306), and then use the
SSH port-forwarding feature to setup a tunnel between your remote database and
your local computer:&lt;/p&gt;
&lt;pre class="highlight" data-user="root"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;[root@localhost ~]# ssh -L3306:127.0.0.1:3306 user@server&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Here, &lt;code&gt;-L3306:127.0.0.1:3306&lt;/code&gt; says that we want &lt;code&gt;127.0.0.1:3306&lt;/code&gt; to be &amp;ldquo;mapped&amp;rdquo;
to our local host to port &lt;code&gt;3306&lt;/code&gt;. While the SSH session is active any packet
sent to &lt;code&gt;localhost:3306&lt;/code&gt; (on your computer) will be forwarded over the SSH
encrypted channel to the remote server and then will be fed to remote&amp;rsquo;s
&lt;code&gt;127.0.0.1:3306&lt;/code&gt;.  This means that as long as your SSH session is alive you
will be able to work with the remote MySQL server like it&amp;rsquo;s running on your
local computer and you can use any MySQL tools locally.&lt;/p&gt;
&lt;p&gt;Well, the above command was given for Linux, Mac OSX, and other Unix-based
systems. For Windows, you can use PuTTY to achive the same. I found the
following &lt;a href="https://www.akadia.com/services/ssh_putty.html"&gt;instructions for PuTTY&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;OK, this is not a new topic and it was described many times here and there on
the Internet, but I decided to write this article as a foundation for my
further articles on this topic which will cover more advanced usage of the SSH
port-forwarding feature. For example, I intend to document a configuration of
the MySQL replication setup between two servers located at two different data
centres where each server is a part of a server farm protected by a firewall.&lt;/p&gt;</content><category term="ssh"></category><category term="ssh"></category><category term="console"></category><category term="bastion"></category></entry><entry><title>HOWTO: VMware Player as a remote console (VNC)</title><link href="https://dmitry.khlebnikov.net/2010/11/24/howto-vmware-player-as-a-remote-console-vnc/" rel="alternate"></link><published>2010-11-24T10:00:00+11:00</published><updated>2020-05-17T20:25:15+10:00</updated><author><name>(GalaxyMaster)</name></author><id>tag:dmitry.khlebnikov.net,2010-11-24:/2010/11/24/howto-vmware-player-as-a-remote-console-vnc/</id><summary type="html">&lt;p&gt;Turning VMware Player into a non-privileged VNC client to access VMware VMs from a Linux-based PC&lt;/p&gt;</summary><content type="html">&lt;p&gt;Since I am doing a lot of remote systems administration tasks due to the nature
of my IT consulting work and since I am also running Linux on all my computers
I was looking for a native way how to get a remote console to VMware VMs from
linux.&lt;/p&gt;
&lt;p&gt;After some searching I found that &lt;a href="http://www.vmware.com/go/downloadplayer/"&gt;VMware Player&lt;/a&gt; (which has native binaries for
Linux) can be used as a VNC client to get to VMs consoles. However, once I have
downloaded VMware Player&amp;rsquo;s bundle and was faced with its requirement to run the
installation script as root I became quite unhappy with an idea of running some
proprietary software on my machine as root, especially after looking into the
bundle and the way the installation script was written. Moreover, there was no
need for other parts of &lt;a href="http://www.vmware.com/go/downloadplayer/"&gt;VMware Player&lt;/a&gt; &amp;ndash; I just wanted to have a small tool to
be able to hook the remote consoles up under my lovely Linux environment.
Therefore, I decided to take a challenge and to tweak the installation so it
will be possible to install the whole thing as a non-privileged user. Another
sub-goal was to strip the installation further down and prepare a small package
with only components needed for remote console sessions.&lt;/p&gt;
&lt;p&gt;If you are not concerned about security (and integrity) of your system, e.g.
you are fine with the re-installation of the whole system, then it will be
cheaper to just install the &lt;a href="http://www.vmware.com/go/downloadplayer/"&gt;VMware Player&lt;/a&gt; under the root account. In this case
you don&amp;rsquo;t need to read any further since what I am describing below is for
those brave hearts who value their systems and who do not want to give a chance
to mess their systems up by running low-quality custom installation scripts as
root.&lt;/p&gt;
&lt;p&gt;Well, if you are still reading, then I hope that my research on this topic and
the how-to I have spent considerable time to come up with is worth something
and will be of some help to you.&lt;/p&gt;
&lt;p&gt;Our starting point is a Linux-based system (it does not matter what
distribution you are running, but I did everything on a customised &lt;a href="https://en.altlinux.org/"&gt;ALT Linux&lt;/a&gt;&amp;lsquo;s
RPM-based distribution) running on an x86 compatible hardware (mine was 32-bit,
but I see no issues with 64-bit ones).&lt;/p&gt;
&lt;p&gt;The first step is to download &lt;a href="http://www.vmware.com/go/downloadplayer/"&gt;VMware Player&lt;/a&gt; for your architecture, set proper
permissions on the downloaded file, and then extract the payload as follows
(you need to ensure that you have at least 40MB of free space on &lt;code&gt;/tmp&lt;/code&gt;, BTW):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ chmod 0700 ./VMware-Player-3.1.3.324285.i386.bundle
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ./VMware-Player-3.1.3-324285.i386.bundle --console -x $(pwd)/vmplayer
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Extracting VMware Installer...done.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;No protocol specified
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;No protocol specified
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ls -l vmplayer
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;total 20
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwxr-xr-x  8 vmware vmware 4096 Nov 23 09:01 vmware-installer
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwxr-xr-x  4 vmware vmware 4096 Nov 23 09:01 vmware-ovftool
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwxr-xr-x  5 vmware vmware 4096 Nov 23 09:01 vmware-player
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwxr-xr-x 11 vmware vmware 4096 Nov 23 09:01 vmware-player-app
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwxr-xr-x  3 vmware vmware 4096 Nov 23 09:01 vmware-player-setup&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So far so good. We now have the whole bundle unacked into the specified
directory and we are interested in just two subdirectories: &lt;code&gt;vmware-player&lt;/code&gt; and
&lt;code&gt;vmware-player-app&lt;/code&gt;, the rest is not related to the functionality we are
looking for.&lt;/p&gt;
&lt;p&gt;Now, let&amp;rsquo;s pick up all parts from which we will build our future &amp;ldquo;VMware remote
console&amp;rdquo; tool. To make it easier create a dedicated subdirectory, e.g.
&lt;code&gt;vmrconsole&lt;/code&gt;, with the following structure:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole/{bin,etc,lib,share}
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ls -l ~/vmrconsole
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;total 12
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwx------ 2 vmware vmware 4096 Nov 24 01:21 bin
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwx------ 2 vmware vmware 4096 Nov 24 01:21 etc
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwx------ 2 vmware vmware 4096 Nov 24 01:21 lib
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;drwx------ 2 vmware vmware 4096 Nov 24 01:21 share&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From now on we are going to populate these directories with files from the
unpacked bundle.&lt;/p&gt;
&lt;p&gt;The first file we are interested in is &lt;code&gt;appLoader&lt;/code&gt; &amp;ndash; this is the primary
executable by the way, we need to copy it to our bin directory and then try to
run it:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp ~/vmplayer/vmware-player-app/lib/bin/appLoader ~/vmrconsole/bin/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ chmod 0700 ~/vmrconsole/bin/appLoader
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ln -s appLoader ~/vmrconsole/bin/vmplayer
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ~/vmrconsole/bin/vmplayer 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ echo $?
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;255
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Huh, this is not very informative, is it? The binary silently exits with error
code of 255. Well, you may get other errors at this stage if you don&amp;rsquo;t have all
the required shared libraries installed on you system &amp;ndash; however I doubt it
since the requirements of this binary are pretty reasonable: glibc and zlib.&lt;/p&gt;
&lt;p&gt;OK, let&amp;rsquo;s take a peek inside and figure out what is going on (originally I used
strace with logging to a file, but to keep this article reasonable short I am
highlighting important things only):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strace -f -eopen ~/vmrconsole/bin/vmplayer 2&amp;gt;&amp;amp;1 | tail -2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;open(&amp;quot;/etc/localtime&amp;quot;, O_RDONLY)        = 6
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;open(&amp;quot;/etc/vmware/config&amp;quot;, O_RDONLY|O_LARGEFILE) = -1 EACCES (Permission denied)&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It looks that vmplayer wants to access a global config file and does not try to
look for an alternative, home directory based one. Well, this is understandable
since VMware folks did not expect it to be run as a non-privileged process, but
we need to deal with this somehow. What are our options here? The simpliest
option I could think of at the moment is to substitute the hardcoded absolute
path inside the binary with something relative:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings ~/vmrconsole/bin/appLoader | fgrep /etc/vmware | uniq -c
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;      1 /etc/vmware/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;      1 /etc/vmware/icu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;      1 /etc/vmware/ssl/rui.crt
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;      1 /etc/vmware/ssl/rui.key
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;      1 /etc/vmware/ssl/dh512.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;      1 /etc/vmware/ssl/dh1024.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware,..//////etc,g' ~/vmrconsole/bin/appLoader&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The trick here is to substitute one string with another of the same length (we
are modifying a binary so we do not want to mess offsets up) and luckily enough
we can use whatever number of slashes we want &amp;ndash; they all are considered as a
single separator nevertheless. OK, we could have used a hex editor and could
have terminated strings with a NULL byte, but the point is that the approach I
took is the quickest and is working well. Let&amp;rsquo;s run the modified binary through
strace again, but this time we need to be prepared for the changed behaviour:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cd ~/vmrconsole/bin/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ touch ../etc/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strace -f -emkdir,lstat,open,write ./vmplayer 2&amp;gt;&amp;amp;1 | tail -12
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;mkdir(&amp;quot;/tmp/.private/vmware/vmware-vmplayer&amp;quot;, 0700) = -1 EEXIST (File exists)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;open(&amp;quot;/tmp/.private/vmware/vmware-vmplayer/appLoader-9245.log&amp;quot;, O_RDWR|O_CREAT|O_APPEND|O_LARGEFILE, 0644) = 5
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;open(&amp;quot;/etc/localtime&amp;quot;, O_RDONLY)        = 6
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.824: app-3077760&amp;quot;..., 121) = 121
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.824: app-3077760&amp;quot;..., 60) = 60
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.824: app-3077760&amp;quot;..., 71) = 71
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.824: app-3077760&amp;quot;..., 57) = 57
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;\&amp;quot;\n&amp;quot;, 2)                     = 2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.825: app-3077760&amp;quot;..., 82) = 82
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;open(&amp;quot;..//////etc/config&amp;quot;, O_RDONLY|O_LARGEFILE) = 6
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.825: app-3077760&amp;quot;..., 89) = 89
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;Nov 24 01:53:09.825: app-3077760&amp;quot;..., 73) = 73&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Looks better, does not it? Our binary found the config file and was able to
open it, however it still produces no output, but it reports something to a log
file:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ tail -7 /tmp/.private/vmware/vmware-vmplayer/appLoader-9245.log
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.824: app-3077760704| Log for VMware Workstation pid=9245 version=7.1.3 build=build-324285 option=Release
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.824: app-3077760704| The process is 32-bit.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.824: app-3077760704| Host codepage=utf8 encoding=UTF-8
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.824: app-3077760704| Calling: &amp;quot;./vmplayer&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.825: app-3077760704| Using configuration file ..//////etc/config.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.825: app-3077760704| libdir entry was not present in ..//////etc/config.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 01:53:09.825: app-3077760704| Unable to lookup library directory.&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I do not know much about VMware Players config file but according to the log
message it wants some variable called &lt;code&gt;libdir&lt;/code&gt; and this variable should point
to the library directory, so let&amp;rsquo;s introduce such a variable and try to execute
the binary again:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ echo 'libdir = ..' &amp;gt;&amp;gt; ../etc/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strace -f -emkdir,lstat,open,write ./vmplayer 2&amp;gt;&amp;amp;1 | tail -4
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;LOG NOT INITIALIZED | LoadLibrar&amp;quot;..., 73) = 73
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;open(&amp;quot;../lib/libvmplayer.so/libvmplayer.so&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;LOG NOT INITIALIZED | Error load&amp;quot;..., 153) = 153
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;write(5, &amp;quot;LOG NOT INITIALIZED | Could not &amp;quot;..., 74) = 74&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I hope you have noticed that I have used a relative path for the library
directory in the config file and this means that we always should run the
binary with its directory being the current working directory. This is a bit
inconvenient, but we will solve this with a wrapper script later. Right now, we
need to get it working and we see that it tried to dynamically load some
library from the library directory. OK, let&amp;rsquo;s search for this library in the
unpacked bundle directory and copy the library file over to our tree:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find ~/vmplayer -name libvmplayer.so
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/lib/lib/libvmplayer.so
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/lib/lib/libvmplayer.so/libvmplayer.so
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -a ~/vmplayer/vmware-player-app/lib/lib/libvmplayer.so ~/vmrconsole/lib/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ldd ~/vmrconsole/lib/libvmplayer.so/libvmplayer.so | fgrep 'not found'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; libview.so.2 =&amp;gt; not found
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; libcds.so =&amp;gt; not found
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; libvmwarebase.so.0 =&amp;gt; not found
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; libvmwareui.so.0 =&amp;gt; not found
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt; libgvmomi.so.0 =&amp;gt; not found&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The last command showed that &lt;code&gt;libvmplayer.so&lt;/code&gt; depends on some libraries and
that their locations are currently unknown to the system. In order to solve
this there are two things we need to do:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We need to tell the system where it should search for the libraries;&lt;/li&gt;
&lt;li&gt;We need to locate these libraries and put them into a directory where the
   system will find them.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;To accomplish the first thing we need to create a wrapper script around
vmplayer and use this script for fine-tuning later. Here is the very basic
script for this purpose (created as &lt;code&gt;~/vmrconsole/bin/loader.sh&lt;/code&gt;:&lt;/p&gt;
&lt;pre class="highlight" data-file="~/vmrconsole/bin/loader.sh"&gt;&lt;code class="language-bash"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#!/bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# We must run vmplayer from the directory it resides in since all
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# relative paths are solved from there.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ORIG_NAME=&amp;quot;${BASH_SOURCE##*/}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ABS_NAME=$(readlink -e $BASH_SOURCE) || exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;VMW_BINDIR=&amp;quot;${ABS_NAME%/*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;VMW_LIBDIR=&amp;quot;$VMW_BINDIR/../lib&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# check that directories exist, if not notify the user
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;if [ ! -d &amp;quot;$VMW_BINDIR&amp;quot; ]; then
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    echo &amp;quot;ERROR: cannot determine the directory where this script resides!&amp;quot; &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;fi
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# preserve the current working directory
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;OLD_PWD=&amp;quot;$PWD&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;if ! cd &amp;quot;$VMW_LIBDIR&amp;quot; &amp;gt;/dev/null 2&amp;gt;&amp;amp;1 ; then
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    echo &amp;quot;ERROR: the '$VMW_LIBDIR' directory does not exist!&amp;quot; &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;fi
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# resolve the library directory path (to get rid off ../ inside of it)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;VMW_LIBDIR=$(pwd -P 2&amp;gt;/dev/null)
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;if [ $? -ne 0 -o ! -d &amp;quot;$VMW_LIBDIR&amp;quot; ]; then
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    echo &amp;quot;ERROR: could not resolve the '$VMW_LIBDIR' directory path!&amp;quot; &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;fi
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# return back since it possible that we were called as ./vmrconsole
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;if ! cd &amp;quot;$OLD_PWD&amp;quot; &amp;gt;/dev/null 2&amp;gt;&amp;amp;1 ; then
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    echo &amp;quot;ERROR: could not return to the original '$OLD_PWD' directory!&amp;quot; &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;fi
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# we don't need the following variable anymore
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;unset OLD_PWD
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# change the current directory to $VMW_BINDIR
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;if ! cd &amp;quot;$VMW_BINDIR&amp;quot; &amp;gt;/dev/null 2&amp;gt;&amp;amp;1 ; then
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    echo &amp;quot;ERROR: failed to change directory to '$VMW_BINDIR'!&amp;quot; &amp;gt;&amp;amp;2
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;    exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;fi
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# set the library search path so the dynamic linker will be able
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# to locate locally installed libraries.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;LD_LIBRARY_PATH=&amp;quot;$VMW_LIBDIR${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;export LD_LIBRARY_PATH
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;# execute the real binary and pass the supplied arguments to it
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec -a &amp;quot;$ORIG_NAME&amp;quot; ./appLoader &amp;quot;$@&amp;quot;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This wrapper script should not be called directly, instead we need to create a
symbolic link to this wrapper, e.g. for vmplayer the following should be
performed:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ln -sf loader.sh ~/vmrconsole/bin/vmplayer&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Since our vmplayer is not a full scale VMware Player I suggest to create
another small wrapper script and name it &lt;code&gt;vmrconsole&lt;/code&gt;:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cat ~/vmrconsole/bin/vmrconsole
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;#!/bin/bash
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;ABS_NAME=$(readlink -e $BASH_SOURCE) || exit 1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;BINDIR=&amp;quot;${ABS_NAME%/*}&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;exec &amp;quot;$BINDIR/vmplayer&amp;quot; -h &amp;quot;$@&amp;quot;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ chmod 0700 ~/vmrconsole/bin/vmrconsole&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we need to populate our library directory with the needed libraries. It is
a bit tricky to describe since on different systems you will likely end up with
different sets of libraries inside our local directory. For example, on my
system I have quite a few of the libraries installed from the distribution
repositories and these versions of libraries are fresher and with many bug
fixes in comparison to the VMWare provided ones.&lt;/p&gt;
&lt;p&gt;Anyway, the general approach to install missing libraries is the following &amp;ndash;
we start with the libraries we determined as missing during our &lt;code&gt;ldd
~/vmrconsole/lib/libvmplayer.so/libvmplayer.so | fgrep 'not found'&lt;/code&gt; step (we
need to locate and copy them over to our library directory):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ldd ~/vmrconsole/lib/libvmplayer.so/libvmplayer.so | fgrep 'not found' | awk '{ print $1; }' | xargs -i find ~/vmplayer -type f -name '{}' -execdir cp -avL '{}' ~/vmrconsole/lib/ \;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;`libview.so.2' -&amp;gt; `/home/vmware/vmrconsole/lib/libview.so.2'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;`libcds.so' -&amp;gt; `/home/vmware/vmrconsole/lib/libcds.so'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;`libvmwarebase.so.0' -&amp;gt; `/home/vmware/vmrconsole/lib/libvmwarebase.so.0'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;`libvmwareui.so.0' -&amp;gt; `/home/vmware/vmrconsole/lib/libvmwareui.so.0'
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;`libgvmomi.so.0' -&amp;gt; `/home/vmware/vmrconsole/lib/libgvmomi.so.0'&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once this is done we need to follow the following loop until there is no output
from the command listed below (in fact, on my system this step was not needed
since I had all dependencies in place already, but it is harmless to execute
this command anyway):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ LD_LIBRARY_PATH=~/vmrconsole/lib ldd ~/vmrconsole/lib/* 2&amp;gt;/dev/null | fgrep 'not found' | awk '{ print $1; }' | xargs -i find ~/vmplayer -type f -name '{}' -execdir cp -avL '{}' ~/vmrconsole/lib/ \;&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we try to access any remote VM&amp;rsquo;s console it will be clear that some parts
are still missing:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ vmrconsole 192.168.70.31
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Failed to open file '/usr/lib/vmware/share/pixmaps/progress.png': No such file or directory
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Failed to open file '/usr/lib/vmware/share/pixmaps/eula.png': No such file or directory
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Failed to open file '/usr/lib/vmware/share/pixmaps/stream-spinner.png': No such file or directory
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Failed to open file '/usr/lib/vmware/share/pixmaps/stream-spinner-stopped.png': No such file or directory
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;SSLLoadSharedLibrary: Failed to load library libcrypto.so.0.9.8:/home/vmplayer/vmrconsole/bin/libdir/lib/libcrypto.so.0.9.8/libcrypto.so.0.9.8: cannot open shared object file: No such file or directory&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;strace&lt;/code&gt; is our best friend here, just run the command through &lt;code&gt;strace&lt;/code&gt;,
examine the log file, and fix stuff properly:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strace -f -eopen -o ~/strace.log vmrconsole 192.168.70.31 &amp;gt;/dev/null 2&amp;gt;&amp;amp;1
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ less -n ~/strace.log
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cd ~/vmrconsole/lib
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ fgrep -lr /vmware *
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;libcds.so
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;libgvmomi.so.0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;libvmplayer.so/libvmplayer.so
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;libvmwarebase.so.0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;libvmwareui.so.0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings libcds.so | fgrep /vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/bootstrap
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware-installer/bootstrap
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware-installer/database
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware/,..//////etc/,' libcds.so 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware-installer/,..//////etc/installer/,' libcds.so 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings libgvmomi.so.0 | fgrep /vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/hostd/proxy.xml
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/icu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/rui.crt
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/rui.key
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/dh512.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/dh1024.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware/,..//////etc/,g' libgvmomi.so.0
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings libvmplayer.so/libvmplayer.so | fgrep /vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bin/vmware-vmrc-daemon
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings libvmwarebase.so.0 | fgrep /vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/icu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/CVP
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;vmauthd/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/sbin/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/var/run/vmware/authd_
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/var/run/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/rui.crt
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/rui.key
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/dh512.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/dh1024.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/var/run/vmware/usbarbitrator-socket
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/vmware/settings
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/vmware/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bin/vmware-vmx
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bin/vmware-vmx-debug
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;bin/vmware-vmx-stats
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;%s/vmware-speedtest-%d.tmp
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/vmware-ace/host.vmpl
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/vmware-ace/host-update.vmpl
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware/,..//////etc/,g' libvmwarebase.so.0 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware,..//////etc,g' libvmwarebase.so.0 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/usr/lib/vmware/,..//////////etc/,g' libvmwarebase.so.0 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/var/run/vmware,..//////var/run,g' libvmwarebase.so.0 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings libvmwareui.so.0 | fgrep /usr/lib/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings libvmwareui.so.0 | fgrep /var/run/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/var/run/vmware/fuse/%Lu.info
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/var/run/vmware,..//////var/run,g' libvmwareui.so.0&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ufff, we did a lot of binary patching &amp;ndash; luckily, VMware binaries and libraries
are not calculating their checksums. Now, we need to put all this stuff we have
seen in the &lt;code&gt;strings&lt;/code&gt; output and during the execution of the program in place (in
accordance to our new relative paths):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find ~/vmplayer -name icu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/lib/icu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/icu ~/vmrconsole/etc/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole/etc/ssl
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find ~/vmplayer -name CVP
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole/var
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole/var/run
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find ~/vmplayer -name pixmaps
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player/lib/share/pixmaps
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/lib/share/pixmaps
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole/share/pixmaps
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/share/pixmaps/* ~/vmrconsole/share/pixmaps/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/share/EULA.txt ~/vmrconsole/share/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/share/*.ui ~/vmrconsole/share/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/share/icons ~/vmrconsole/share/&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this stage we should be able to launch the vmplayer program via our wrapper
script (I am launching it on a remote machine through SSH, but here I am
describing how it should look on the local console):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ~/vmrconsole/bin/vmplayer&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img alt="VMware Player: main window" class="figure" src="https://dmitry.khlebnikov.net/images/howto-vmware-player-as-remote-console-01.jpg"&gt;&lt;/p&gt;
&lt;p&gt;So far so good, but we need to resolve the issue with the OpenSSL library
dependency. To resolve the issue we need to create symbolic links from our
local library directory to the system-wide version of the OpenSSL library:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ln -s /usr/lib/libcrypto.so.0.9.8 ~/vmrconsole/lib/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ln -s /usr/lib/libssl.so.0.9.8 ~/vmrconsole/lib/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ls -ld ~/vmrconsole/lib/lib*.so.0.9.8 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;lrwxrwxrwx 1 vmware vmware 27 Nov 24 05:27 /home/vmware/vmrconsole/lib/libcrypto.so.0.9.8 -&amp;gt; /usr/lib/libcrypto.so.0.9.8
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;lrwxrwxrwx 1 vmware vmware 27 Nov 24 05:27 /home/vmware/vmrconsole/lib/libssl.so.0.9.8 -&amp;gt; /usr/lib/libssl.so.0.9.8&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Let&amp;rsquo;s try to connect to remote VM&amp;rsquo;s console again:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ vmrconsole 192.168.70.31&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img alt="VMware Player: credentials window" class="figure" src="https://dmitry.khlebnikov.net/images/howto-vmware-player-as-remote-console-02.jpg"&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="VMware Player: MKS error message" class="figure" src="https://dmitry.khlebnikov.net/images/howto-vmware-player-as-remote-console-03.jpg"&gt;&lt;/p&gt;
&lt;p&gt;Well, this error message does not say much except that we are not getting our
console :). If we check the log file directory we would see there is a file
called &lt;code&gt;player-XXXXX.log&lt;/code&gt; (where XXXXX is the PID of the VMware Player that
produced this log file). Inside the log file we may see some interesting parts
like the following (I have included only those messages which are related to our
task):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-syslog"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:40:42.002: player| CDS error: Cannot locate VMIS, bootstrap file /etc/vmware-installer/bootstrap unavailable!
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:40:42.072: player| Unable to launch vmplayer-daemon: File does not exist.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:40:42.072: player| Unable to find /home/vmplayer/bin/vmware-unity-helper in attempt to launch daemon.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:04.630: player| Player dispatch: Opening VM while not connected to the daemon.
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.437: player| ConnectMksClient - calling VMClient_ConnectMksClientEx
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.437: player| VMClient_ConnectMksClientEx - trying local socket connection
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.444: player| Cnx_Connect: Returning false because CnxConnectAuthd failed
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.444: player| Cnx_Connect: Error message: Connection terminated by server
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.444: player| VMClient_ConnectMksClientEx - trying remote socket connection
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.611: player| VMClient_ConnectMksClientEx - connecting the MKS client
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:05.616: player| vmdbPipe_Streams: Couldn't read
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;Nov 24 03:41:15.941: player| Gdk: losing last reference to undestroyed window&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;From the messages quoted above it is quite clear that the program is trying to
launch some helper binaries/daemons in the background and to delegate the
actual remote console task to them. You can &lt;code&gt;strace&lt;/code&gt;/&lt;code&gt;ltrace&lt;/code&gt; the whole thing,
review the resulting logs and you will find that it tries to execute two helper
binaries: &lt;code&gt;vmware-authd&lt;/code&gt; and &lt;code&gt;vmware-remotemks&lt;/code&gt;, the latter is the remote
console engine, while the former is some kind of an authentication daemon and I
do not think it is needed for our purposes. I am not going to describe in
details how I arrived at the following (it is all clear once you have studied
the &lt;code&gt;strace&lt;/code&gt;/&lt;code&gt;ltrace&lt;/code&gt; log files):&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find ~/vmplayer -name vmware-authd -o -name vmware-remotemks
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/lib/bin/vmware-remotemks
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/sbin/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mkdir -m700 ~/vmrconsole/vmauthd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ln -s `which true` ~/vmrconsole/vmauthd/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ls -ld ~/vmrconsole/vmauthd/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;lrwxrwxrwx 1 vmware vmware 9 Nov 24 04:15 /home/vmware/vmrconsole/vmauthd/vmware-authd -&amp;gt; /bin/true
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL ~/vmplayer/vmware-player-app/lib/bin/vmware-remotemks ~/vmrconsole/bin/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ chmod 0700 ~/vmrconsole/bin/vmware-remotemks
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ strings ~/vmrconsole/bin/vmware-remotemks | fgrep /vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/lib/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/config
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/icu
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/rui.crt
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/rui.key
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/dh512.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/ssl/dh1024.pem
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/etc/vmware/CVP
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;vmauthd/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/usr/sbin/vmware-authd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/var/run/vmware/authd_
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/var/run/vmware
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/var/run/vmware,..//////var/run,g' ~/vmrconsole/bin/vmware-remotemks
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ sed -i 's,/etc/vmware/,..//////etc/,g' ~/vmrconsole/bin/vmware-remotemks&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Another attempt:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ vmrconsole 192.168.70.31&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img alt="VMware Player: hints messages" class="figure" src="https://dmitry.khlebnikov.net/images/howto-vmware-player-as-remote-console-04.jpg"&gt;&lt;/p&gt;
&lt;p&gt;Ouch, we are presented by a bunch of hints (your mileage may vary since it
depends on the environment), but you surely will see the hint/error message
presented on the above screenshot.&lt;/p&gt;
&lt;p&gt;This is not a showstopper if you are an English-only user - just click on the
OK button and you should be able to work with the console, however I think it
is just a right thing to do to fix this little bugger:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find ~/vmplayer -iname xkeymap
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;/home/vmware/vmplayer/vmware-player-app/lib/xkeymap
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/xkeymap ~/vmrconsole/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cp -aL /home/vmware/vmplayer/vmware-player-app/lib/vnckeymap ~/vmrconsole/
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ vmrconsole 192.168.70.31&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;img alt="VMware Player: remote console window" class="figure" src="https://dmitry.khlebnikov.net/images/howto-vmware-player-as-remote-console-05.jpg"&gt;&lt;/p&gt;
&lt;p&gt;We are almost done! At least we achieved the goal we set at the beginning of
this article.&lt;/p&gt;
&lt;p&gt;Now, it is time to ensure that all file/directory permissions are strict enough
and to create a tarball, then place it somewhere so we will be able to use our
new tool when the right time comes:&lt;/p&gt;
&lt;pre class="highlight"&gt;&lt;code class="language-shell"&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cd ~/vmrconsole
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find . -type d -execdir chmod 0700 '{}' \;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ find . -type f -execdir chmod 0600 '{}' \;
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ chmod 0700 bin/*
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ cd
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ mv vmrconsole vmrconsole-3.1.3.324285
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ tar cjpf ~/vmrconsole-3.1.3.324285.i386.tar.bz2 vmrconsole-3.1.3.324285
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;$ ls -lh vmrconsole-3.1.3.324285.i386.tar.bz2 
&lt;/div&gt;&lt;div class="lines"&gt;&lt;a&gt;&lt;/a&gt;-rw-r--r-- 1 vmware vmware 13M Nov 24 07:06 vmrconsole-3.1.3.324285.i386.tar.bz2&lt;/div&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;P.S. Oh, boy, it takes 2 hours to investigate and to come up with a solution,
then 8 hours to write an article to describe steps to reproduce! I hope that
somebody has found this article useful and I would appreciate any comments.&lt;/p&gt;</content><category term="hacking"></category></entry></feed>